# Generated by Django 5.2.8 on 2025-12-02 05:08

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0006_add_funder_field'),
        ('finance', '0001_initial'),
        ('learners', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='TrancheEvidenceRequirement',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('evidence_type', models.CharField(choices=[('LEARNER_LIST', 'Learner List/Register'), ('LEARNER_AGREEMENTS', 'Learner Agreements'), ('ID_COPIES', 'ID Document Copies'), ('QUALIFICATION_COPIES', 'Qualification Copies'), ('REGISTRATION_FORMS', 'Registration Forms'), ('ENROLLMENT_PROOF', 'Enrollment Confirmation'), ('NLRD_REGISTRATION', 'NLRD Registration Proof'), ('SETA_REGISTRATION', 'SETA Registration Confirmation'), ('PPE_ISSUE_REGISTER', 'PPE Issue Register'), ('TOOLBOX_ISSUE_REGISTER', 'Toolbox Issue Register'), ('EQUIPMENT_PHOTOS', 'Equipment Issue Photos'), ('DELIVERY_NOTES', 'Delivery Notes'), ('MATERIAL_ISSUE_REGISTER', 'Learning Material Issue Register'), ('TEXTBOOK_LIST', 'Textbook/Material List'), ('ATTENDANCE_REGISTERS', 'Attendance Registers'), ('TRAINING_SCHEDULE', 'Training Schedule'), ('FACILITATOR_REPORTS', 'Facilitator Reports'), ('LESSON_PLANS', 'Lesson Plans'), ('ASSESSMENT_SCHEDULE', 'Assessment Schedule'), ('ASSESSMENT_RESULTS', 'Assessment Results'), ('COMPETENCY_MATRIX', 'Competency Matrix'), ('POE_SAMPLES', 'POE Samples'), ('ASSESSMENT_TOOLS', 'Assessment Tools Used'), ('PLACEMENT_LETTERS', 'Workplace Placement Letters'), ('WORKPLACE_AGREEMENTS', 'Workplace Agreements'), ('MENTOR_ASSIGNMENTS', 'Mentor Assignment Records'), ('LOGBOOKS', 'Learner Logbooks'), ('WORKPLACE_REPORTS', 'Workplace Progress Reports'), ('MODERATION_REPORTS', 'Moderation Reports'), ('VERIFICATION_REPORTS', 'Verification Reports'), ('EXTERNAL_MODERATION', 'External Moderation Proof'), ('TRADE_TEST_BOOKINGS', 'Trade Test Bookings'), ('TRADE_TEST_RESULTS', 'Trade Test Results'), ('CERTIFICATES', 'Certificates Issued'), ('CERTIFICATE_REGISTER', 'Certificate Issue Register'), ('INVOICES', 'Invoices'), ('BANK_STATEMENTS', 'Bank Statements'), ('FINANCIAL_REPORT', 'Financial Report'), ('PROJECT_REPORT', 'Project Progress Report'), ('TRAINING_PHOTOS', 'Training Session Photos'), ('CEREMONY_PHOTOS', 'Ceremony/Event Photos'), ('SITE_PHOTOS', 'Training Site Photos'), ('OTHER', 'Other Supporting Document')], max_length=50)),
                ('name', models.CharField(help_text='Specific name for this evidence requirement', max_length=255)),
                ('description', models.TextField(blank=True, help_text='Details about what is required')),
                ('is_mandatory', models.BooleanField(default=True)),
                ('expected_count', models.PositiveIntegerField(default=1, help_text='Expected number of documents/items (e.g., one per learner)')),
                ('deadline', models.DateField(blank=True, null=True)),
                ('requires_verification', models.BooleanField(default=False)),
                ('verification_notes', models.TextField(blank=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Tranche Evidence Requirement',
                'verbose_name_plural': 'Tranche Evidence Requirements',
                'ordering': ['tranche', 'evidence_type'],
            },
        ),
        migrations.CreateModel(
            name='TrancheEvidence',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('title', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending Review'), ('VERIFIED', 'Verified'), ('REJECTED', 'Rejected'), ('NEEDS_REVISION', 'Needs Revision')], default='PENDING', max_length=20)),
                ('verified_at', models.DateTimeField(blank=True, null=True)),
                ('verification_notes', models.TextField(blank=True)),
                ('rejection_reason', models.TextField(blank=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tranche_evidence', to='learners.document')),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('verified_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tranche_evidence_verified', to=settings.AUTH_USER_MODEL)),
                ('requirement', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='evidence', to='core.trancheevidencerequirement')),
            ],
            options={
                'verbose_name': 'Tranche Evidence',
                'verbose_name_plural': 'Tranche Evidence',
                'ordering': ['requirement', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TrancheSchedule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('reference_number', models.CharField(editable=False, max_length=50, unique=True)),
                ('sequence_number', models.PositiveIntegerField(help_text='Order in the tranche sequence')),
                ('tranche_type', models.CharField(choices=[('COMMENCEMENT', 'Commencement'), ('RECRUITMENT', 'Learner Recruitment'), ('REGISTRATION', 'Learner Registration'), ('PPE_TOOLBOX', 'PPE & Toolbox Issuance'), ('LEARNING_MATERIAL', 'Learning Material Issuance'), ('ASSESSMENT_1', 'Assessment Cycle 1'), ('ASSESSMENT_2', 'Assessment Cycle 2'), ('ASSESSMENT_3', 'Assessment Cycle 3'), ('PLACEMENT', 'Workplace Placement'), ('MODERATION', 'Moderation'), ('TRADE_TEST', 'Trade Test'), ('CERTIFICATION', 'Certification'), ('COMPLETION', 'Programme Completion'), ('FINAL', 'Final Claim'), ('INTERIM', 'Interim Claim'), ('CUSTOM', 'Custom Milestone')], max_length=30)),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(choices=[('SCHEDULED', 'Scheduled'), ('EVIDENCE_COLLECTION', 'Collecting Evidence'), ('EVIDENCE_COMPLETE', 'Evidence Complete'), ('PENDING_QC', 'Pending Quality Check'), ('QC_FAILED', 'QC Failed - Rework Required'), ('QC_PASSED', 'QC Passed'), ('SUBMITTED', 'Submitted to Funder'), ('QUERY', 'Funder Query'), ('APPROVED', 'Approved by Funder'), ('INVOICED', 'Invoice Sent'), ('PAID', 'Payment Received'), ('CANCELLED', 'Cancelled')], default='SCHEDULED', max_length=30)),
                ('priority', models.CharField(choices=[('LOW', 'Low'), ('MEDIUM', 'Medium'), ('HIGH', 'High'), ('CRITICAL', 'Critical')], default='MEDIUM', max_length=20)),
                ('due_date', models.DateField(help_text='Target date for tranche completion')),
                ('reminder_date', models.DateField(blank=True, help_text='Date to send reminder', null=True)),
                ('evidence_submitted_date', models.DateField(blank=True, null=True)),
                ('qc_completed_date', models.DateField(blank=True, null=True)),
                ('submitted_to_funder_date', models.DateField(blank=True, null=True)),
                ('funder_approved_date', models.DateField(blank=True, null=True)),
                ('invoice_sent_date', models.DateField(blank=True, null=True)),
                ('payment_received_date', models.DateField(blank=True, null=True)),
                ('amount', models.DecimalField(decimal_places=2, default=0, help_text='Amount to be claimed for this tranche', max_digits=14)),
                ('actual_amount_received', models.DecimalField(blank=True, decimal_places=2, help_text='Actual amount received (may differ from claimed)', max_digits=14, null=True)),
                ('learner_count_target', models.PositiveIntegerField(default=0, help_text='Target learner count')),
                ('learner_count_actual', models.PositiveIntegerField(default=0, help_text='Actual learner count at submission')),
                ('qc_notes', models.TextField(blank=True)),
                ('qc_passed', models.BooleanField(blank=True, null=True)),
                ('funder_reference', models.CharField(blank=True, help_text="Funder's reference number", max_length=100)),
                ('funder_response_notes', models.TextField(blank=True)),
                ('notes', models.TextField(blank=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('invoice', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tranches', to='finance.invoice')),
                ('qc_performed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tranches_qc_performed', to=settings.AUTH_USER_MODEL)),
                ('training_notification', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tranches', to='core.trainingnotification')),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Tranche Schedule',
                'verbose_name_plural': 'Tranche Schedules',
                'ordering': ['training_notification', 'sequence_number'],
            },
        ),
        migrations.AddField(
            model_name='trancheevidencerequirement',
            name='tranche',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='evidence_requirements', to='core.trancheschedule'),
        ),
        migrations.CreateModel(
            name='TrancheSubmission',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('submission_reference', models.CharField(editable=False, max_length=100, unique=True)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('PENDING_QC', 'Pending Internal QC'), ('QC_APPROVED', 'QC Approved'), ('SUBMITTED', 'Submitted to Funder'), ('ACKNOWLEDGED', 'Funder Acknowledged Receipt'), ('UNDER_REVIEW', 'Under Funder Review'), ('QUERY', 'Funder Query'), ('QUERY_RESOLVED', 'Query Resolved'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected'), ('PAYMENT_PENDING', 'Payment Pending'), ('PAID', 'Paid')], default='DRAFT', max_length=30)),
                ('submission_method', models.CharField(choices=[('PORTAL', 'Online Portal'), ('EMAIL', 'Email'), ('HAND_DELIVERY', 'Hand Delivery'), ('COURIER', 'Courier'), ('POST', 'Postal Service')], default='PORTAL', max_length=30)),
                ('submission_date', models.DateTimeField(blank=True, null=True)),
                ('portal_reference', models.CharField(blank=True, max_length=100)),
                ('portal_submission_id', models.CharField(blank=True, max_length=100)),
                ('qc_checklist_completed', models.BooleanField(default=False)),
                ('qc_completed_date', models.DateTimeField(blank=True, null=True)),
                ('qc_notes', models.TextField(blank=True)),
                ('funder_response_date', models.DateTimeField(blank=True, null=True)),
                ('funder_reference', models.CharField(blank=True, max_length=100)),
                ('funder_notes', models.TextField(blank=True)),
                ('claimed_amount', models.DecimalField(decimal_places=2, default=0, max_digits=14)),
                ('approved_amount', models.DecimalField(blank=True, decimal_places=2, max_digits=14, null=True)),
                ('payment_date', models.DateField(blank=True, null=True)),
                ('payment_reference', models.CharField(blank=True, max_length=100)),
                ('payment_amount', models.DecimalField(blank=True, decimal_places=2, max_digits=14, null=True)),
                ('attached_documents', models.JSONField(blank=True, default=list)),
                ('notes', models.TextField(blank=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('qc_completed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tranche_qc_completed', to=settings.AUTH_USER_MODEL)),
                ('submitted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tranche_submissions', to=settings.AUTH_USER_MODEL)),
                ('tranche', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='submissions', to='core.trancheschedule')),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Tranche Submission',
                'verbose_name_plural': 'Tranche Submissions',
                'ordering': ['-submission_date', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TrancheComment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('comment_type', models.CharField(choices=[('INTERNAL', 'Internal Note'), ('FUNDER_QUERY', 'Funder Query'), ('FUNDER_RESPONSE', 'Response to Funder'), ('QC_NOTE', 'QC Note'), ('STATUS_UPDATE', 'Status Update')], default='INTERNAL', max_length=30)),
                ('comment', models.TextField()),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('tranche', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='comments', to='core.trancheschedule')),
                ('submission', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='comments', to='core.tranchesubmission')),
            ],
            options={
                'verbose_name': 'Tranche Comment',
                'verbose_name_plural': 'Tranche Comments',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TrancheTemplate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('name', models.CharField(help_text="Template name, e.g., 'MERSETA OC Apprenticeship 3-Year'", max_length=255)),
                ('project_type', models.CharField(choices=[('OC_APPRENTICESHIP', 'OC Apprenticeship'), ('OC_LEARNERSHIP', 'OC Learnership'), ('SKILLS_PROGRAMME', 'Skills Programme'), ('SHORT_COURSE', 'Short Course'), ('LEGACY_APPRENTICESHIP', 'Legacy Apprenticeship'), ('LEGACY_LEARNERSHIP', 'Legacy Learnership')], max_length=30)),
                ('funder_type', models.CharField(choices=[('PRIVATE', 'Private'), ('CORPORATE_DG', 'Corporate DG'), ('CORPORATE', 'Corporate'), ('MUNICIPALITY', 'Municipality'), ('GOVERNMENT', 'Government')], max_length=30)),
                ('description', models.TextField(blank=True)),
                ('duration_months', models.PositiveIntegerField(default=36, help_text='Total program duration in months')),
                ('total_tranches', models.PositiveIntegerField(default=9, help_text='Total number of tranches')),
                ('is_active', models.BooleanField(default=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Tranche Template',
                'verbose_name_plural': 'Tranche Templates',
                'ordering': ['project_type', 'funder_type', 'name'],
                'unique_together': {('project_type', 'funder_type', 'name')},
            },
        ),
        migrations.CreateModel(
            name='TrancheTemplateItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('sequence_number', models.PositiveIntegerField(help_text='Order in the tranche sequence')),
                ('tranche_type', models.CharField(choices=[('COMMENCEMENT', 'Commencement'), ('RECRUITMENT', 'Learner Recruitment'), ('REGISTRATION', 'Learner Registration'), ('PPE_TOOLBOX', 'PPE & Toolbox Issuance'), ('LEARNING_MATERIAL', 'Learning Material Issuance'), ('ASSESSMENT_1', 'Assessment Cycle 1'), ('ASSESSMENT_2', 'Assessment Cycle 2'), ('ASSESSMENT_3', 'Assessment Cycle 3'), ('PLACEMENT', 'Workplace Placement'), ('MODERATION', 'Moderation'), ('TRADE_TEST', 'Trade Test'), ('CERTIFICATION', 'Certification'), ('COMPLETION', 'Programme Completion'), ('FINAL', 'Final Claim'), ('INTERIM', 'Interim Claim'), ('CUSTOM', 'Custom Milestone')], max_length=30)),
                ('name', models.CharField(help_text="Tranche name, e.g., 'Tranche 1 - Commencement'", max_length=255)),
                ('description', models.TextField(blank=True)),
                ('months_from_start', models.PositiveIntegerField(default=0, help_text='Months from program start when this tranche is due')),
                ('days_before_deadline_reminder', models.PositiveIntegerField(default=14, help_text='Days before due date to send reminder')),
                ('percentage_of_total', models.DecimalField(decimal_places=2, default=0, help_text='Percentage of total contract value for this tranche', max_digits=5)),
                ('evidence_requirements', models.JSONField(blank=True, default=list, help_text='List of evidence types required for this tranche')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('template', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='items', to='core.tranchetemplate')),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Tranche Template Item',
                'verbose_name_plural': 'Tranche Template Items',
                'ordering': ['template', 'sequence_number'],
                'unique_together': {('template', 'sequence_number')},
            },
        ),
        migrations.AddField(
            model_name='trancheschedule',
            name='template_item',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='schedule_instances', to='core.tranchetemplateitem'),
        ),
        migrations.AlterUniqueTogether(
            name='trancheschedule',
            unique_together={('training_notification', 'sequence_number')},
        ),
    ]
