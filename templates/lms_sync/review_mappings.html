{% extends "base/app_layout.html" %}
{% load static %}

{% block title %}Review Assessment Mappings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3><i class="fas fa-clipboard-check me-2"></i>Review AI Assessment Mappings</h3>
                    <p class="text-muted mb-0">Review and approve AI-suggested mappings of Moodle activities to QCTO criteria</p>
                </div>
                <div>
                    <a href="{% url 'lms_sync:dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Pending Review</h6>
                            <h3 class="mb-0">{{ stats.pending }}</h3>
                        </div>
                        <div class="text-warning" style="font-size: 2rem;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Approved</h6>
                            <h3 class="mb-0">{{ stats.approved }}</h3>
                        </div>
                        <div class="text-success" style="font-size: 2rem;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Rejected</h6>
                            <h3 class="mb-0">{{ stats.rejected }}</h3>
                        </div>
                        <div class="text-danger" style="font-size: 2rem;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Avg Confidence</h6>
                            <h3 class="mb-0">{{ stats.avg_confidence|floatformat:1 }}%</h3>
                        </div>
                        <div class="text-info" style="font-size: 2rem;">
                            <i class="fas fa-brain"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="PENDING" {% if request.GET.status == 'PENDING' %}selected{% endif %}>Pending Review</option>
                                <option value="APPROVED" {% if request.GET.status == 'APPROVED' %}selected{% endif %}>Approved</option>
                                <option value="REJECTED" {% if request.GET.status == 'REJECTED' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Course</label>
                            <select name="course" class="form-select">
                                <option value="">All Courses</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}" {% if request.GET.course|slugify == course.id|slugify %}selected{% endif %}>
                                    {{ course.shortname }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Min Confidence</label>
                            <select name="min_confidence" class="form-select">
                                <option value="">Any Confidence</option>
                                <option value="90" {% if request.GET.min_confidence == '90' %}selected{% endif %}>90%+</option>
                                <option value="75" {% if request.GET.min_confidence == '75' %}selected{% endif %}>75%+</option>
                                <option value="50" {% if request.GET.min_confidence == '50' %}selected{% endif %}>50%+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter me-2"></i>Filter
                                </button>
                                <a href="{% url 'lms_sync:review_mappings' %}" class="btn btn-secondary">
                                    <i class="fas fa-redo me-2"></i>Reset
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mappings List -->
    <div class="row">
        <div class="col-12">
            {% for mapping in mappings %}
            <div class="card mb-3 mapping-card" id="mapping-{{ mapping.id }}">
                <div class="card-body">
                    <div class="row">
                        <!-- Left: Moodle Activity -->
                        <div class="col-md-5">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-graduation-cap me-2"></i>Moodle Activity
                            </h6>
                            <h5>{{ mapping.moodle_activity.name }}</h5>
                            <p class="text-muted small mb-2">
                                <strong>Course:</strong> {{ mapping.moodle_activity.course.shortname }}<br>
                                <strong>Type:</strong> 
                                <span class="badge bg-info">{{ mapping.moodle_activity.get_activity_type_display }}</span><br>
                                {% if mapping.moodle_activity.description %}
                                <strong>Description:</strong> {{ mapping.moodle_activity.description|truncatewords:30 }}
                                {% endif %}
                            </p>
                        </div>

                        <!-- Center: Mapping Arrow & Confidence -->
                        <div class="col-md-2 text-center d-flex flex-column justify-content-center align-items-center">
                            <i class="fas fa-arrow-right text-muted mb-2" style="font-size: 1.5rem;"></i>
                            
                            <!-- Confidence Badge -->
                            <div class="confidence-badge mb-2">
                                <div class="circular-progress" data-percentage="{{ mapping.ai_confidence|floatformat:0 }}">
                                    <svg width="80" height="80">
                                        <circle cx="40" cy="40" r="35" fill="none" stroke="#e9ecef" stroke-width="8"></circle>
                                        <circle cx="40" cy="40" r="35" fill="none" 
                                                stroke="{% if mapping.ai_confidence >= 90 %}#28a745{% elif mapping.ai_confidence >= 75 %}#17a2b8{% elif mapping.ai_confidence >= 50 %}#ffc107{% else %}#dc3545{% endif %}" 
                                                stroke-width="8" 
                                                stroke-dasharray="{{ mapping.ai_confidence|floatformat:0|add:'0'|mul:2.199|floatformat:2 }} 220"
                                                transform="rotate(-90 40 40)"></circle>
                                        <text x="40" y="45" text-anchor="middle" font-size="16" font-weight="bold" 
                                              fill="{% if mapping.ai_confidence >= 90 %}#28a745{% elif mapping.ai_confidence >= 75 %}#17a2b8{% elif mapping.ai_confidence >= 50 %}#ffc107{% else %}#dc3545{% endif %}">
                                            {{ mapping.ai_confidence|floatformat:0 }}%
                                        </text>
                                    </svg>
                                </div>
                                <small class="text-muted d-block mt-1">AI Confidence</small>
                            </div>

                            <!-- Status Badge -->
                            {% if mapping.status == 'PENDING' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif mapping.status == 'APPROVED' %}
                            <span class="badge bg-success">Approved</span>
                            {% else %}
                            <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                        </div>

                        <!-- Right: QCTO Criteria -->
                        <div class="col-md-5">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-clipboard-list me-2"></i>QCTO Assessment Criteria
                            </h6>
                            <h5>{{ mapping.qcto_criteria.criteria_code }}</h5>
                            <p class="mb-2">{{ mapping.qcto_criteria.description|truncatewords:30 }}</p>
                            <p class="text-muted small mb-0">
                                <strong>Module:</strong> {{ mapping.qcto_criteria.module.code }} - {{ mapping.qcto_criteria.module.name }}<br>
                                {% if mapping.qcto_criteria.is_critical %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Critical Criteria
                                </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- AI Reasoning -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-light mb-3">
                                <strong><i class="fas fa-robot me-2"></i>AI Reasoning:</strong>
                                <p class="mb-0 mt-2">{{ mapping.ai_reasoning }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Review Section -->
                    {% if mapping.status == 'PENDING' %}
                    <div class="row">
                        <div class="col-12">
                            <form method="post" class="review-form">
                                {% csrf_token %}
                                <input type="hidden" name="mapping_id" value="{{ mapping.id }}">
                                
                                <div class="mb-3">
                                    <label class="form-label">Review Notes (Optional)</label>
                                    <textarea name="review_notes" class="form-control" rows="2" 
                                              placeholder="Add any comments about this mapping..."></textarea>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" name="action" value="approve" class="btn btn-success">
                                        <i class="fas fa-check me-2"></i>Approve Mapping
                                    </button>
                                    <button type="submit" name="action" value="reject" class="btn btn-danger">
                                        <i class="fas fa-times me-2"></i>Reject Mapping
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="skipMapping({{ mapping.id }})">
                                        <i class="fas fa-forward me-2"></i>Skip for Now
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <!-- Already Reviewed -->
                    <div class="row">
                        <div class="col-12">
                            <div class="alert {% if mapping.status == 'APPROVED' %}alert-success{% else %}alert-danger{% endif %}">
                                <strong>
                                    {% if mapping.status == 'APPROVED' %}
                                    <i class="fas fa-check-circle me-2"></i>Approved
                                    {% else %}
                                    <i class="fas fa-times-circle me-2"></i>Rejected
                                    {% endif %}
                                </strong> by {{ mapping.reviewed_by.get_full_name }} on {{ mapping.reviewed_at|date:"Y-m-d H:i" }}
                                {% if mapping.review_notes %}
                                <p class="mb-0 mt-2"><strong>Notes:</strong> {{ mapping.review_notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Mappings to Review</h4>
                    <p class="text-muted">All AI-suggested mappings have been reviewed.</p>
                    <a href="{% url 'lms_sync:dashboard' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    {% if mappings.has_other_pages %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if mappings.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.course %}&course={{ request.GET.course }}{% endif %}{% if request.GET.min_confidence %}&min_confidence={{ request.GET.min_confidence }}{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ mappings.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.course %}&course={{ request.GET.course }}{% endif %}{% if request.GET.min_confidence %}&min_confidence={{ request.GET.min_confidence }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">Page {{ mappings.number }} of {{ mappings.paginator.num_pages }}</span>
                    </li>
                    
                    {% if mappings.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ mappings.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.course %}&course={{ request.GET.course }}{% endif %}{% if request.GET.min_confidence %}&min_confidence={{ request.GET.min_confidence }}{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ mappings.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.course %}&course={{ request.GET.course }}{% endif %}{% if request.GET.min_confidence %}&min_confidence={{ request.GET.min_confidence }}{% endif %}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<script>
function skipMapping(mappingId) {
    // Scroll to next mapping
    const currentCard = document.getElementById('mapping-' + mappingId);
    const nextCard = currentCard.nextElementSibling;
    if (nextCard && nextCard.classList.contains('mapping-card')) {
        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
</script>

<style>
.mapping-card {
    transition: box-shadow 0.3s ease;
}

.mapping-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.circular-progress {
    position: relative;
}

.confidence-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
}
</style>
{% endblock %}
