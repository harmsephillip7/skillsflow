{% extends "base/app_layout.html" %}
{% load static %}

{% block title %}LMS Integration Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Brand Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <form method="post" class="d-flex align-items-center">
                        {% csrf_token %}
                        <label for="brand_id" class="me-3 mb-0"><strong>Select Brand:</strong></label>
                        <select name="brand_id" id="brand_id" class="form-select form-select-sm me-3" style="max-width: 300px;" onchange="this.form.submit()">
                            <option value="">-- Choose a Brand --</option>
                            {% for brand in available_brands %}
                            <option value="{{ brand.id }}" {% if selected_brand and selected_brand.id == brand.id %}selected{% endif %}>
                                {{ brand.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if selected_brand %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>{{ selected_brand.name }}</span>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3><i class="fas fa-graduation-cap me-2"></i>LMS Integration Dashboard</h3>
                    <p class="text-muted mb-0">Manage Moodle integration and assessment mappings</p>
                </div>
                <div>
                    {% if selected_brand and not has_instance %}
                    <a href="{% url 'lms_sync:setup_wizard' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Setup Moodle Instance
                    </a>
                    {% elif has_instance %}
                    <button type="button" class="btn btn-success" onclick="triggerSync()">
                        <i class="fas fa-sync-alt me-2"></i>Sync Now
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if not selected_brand %}
    <!-- No Brand Selected -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card text-center">
                <div class="card-body py-5">
                    <i class="fas fa-building text-muted" style="font-size: 5rem;"></i>
                    <h3 class="mt-4 mb-3">Select a Brand to Continue</h3>
                    <p class="text-muted mb-4">Please select a brand from the dropdown above to view or configure its Moodle integration.</p>
                </div>
            </div>
        </div>
    </div>
    {% elif has_instance %}
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Synced Courses</h6>
                            <h3 class="mb-0">{{ stats.total_courses }}</h3>
                        </div>
                        <div class="text-primary" style="font-size: 2rem;">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                    <small class="text-muted">{{ stats.active_courses }} active</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Enrolled Students</h6>
                            <h3 class="mb-0">{{ stats.total_enrollments }}</h3>
                        </div>
                        <div class="text-info" style="font-size: 2rem;">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <small class="text-muted">Across all courses</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Pending Reviews</h6>
                            <h3 class="mb-0">
                                {{ stats.pending_mappings }}
                                {% if stats.pending_mappings > 0 %}
                                <span class="badge bg-warning" style="font-size: 0.6rem;">!</span>
                                {% endif %}
                            </h3>
                        </div>
                        <div class="text-warning" style="font-size: 2rem;">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                    </div>
                    <small class="text-muted">
                        {% if stats.pending_mappings > 0 %}
                        <a href="{% url 'lms_sync:review_mappings' %}?status=PENDING">Review now →</a>
                        {% else %}
                        All mappings reviewed
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-muted mb-2">Last Sync</h6>
                            <h3 class="mb-0">
                                {% if instance.last_sync %}
                                {{ instance.last_sync|timesince }}
                                {% else %}
                                Never
                                {% endif %}
                            </h3>
                        </div>
                        <div class="text-success" style="font-size: 2rem;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <small class="text-muted">Next: Tonight at 2:00 AM</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Instance Info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-server me-2"></i>{{ instance.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Brand:</strong> {{ instance.brand.name }}</p>
                            <p class="mb-2"><strong>URL:</strong> <a href="{{ instance.base_url }}" target="_blank">{{ instance.base_url }} <i class="fas fa-external-link-alt"></i></a></p>
                            <p class="mb-2"><strong>Status:</strong> 
                                {% if instance.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Auto Sync:</strong> 
                                {% if instance.auto_sync_enabled %}
                                <span class="badge bg-success">Enabled</span>
                                {% else %}
                                <span class="badge bg-warning">Disabled</span>
                                {% endif %}
                            </p>
                            <p class="mb-2"><strong>Grade Threshold:</strong> 
                                {{ instance.brand.grade_threshold.pass_percentage|default:global_threshold }}%
                            </p>
                            <p class="mb-2"><strong>Last Sync:</strong> 
                                {% if instance.last_sync %}
                                {{ instance.last_sync|date:"Y-m-d H:i" }}
                                {% else %}
                                Never
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-primary" onclick="testConnection()">
                            <i class="fas fa-heartbeat me-2"></i>Test Connection
                        </button>
                        <a href="{% url 'lms_sync:edit_instance' instance.id %}" class="btn btn-sm btn-secondary">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'lms_sync:browse_courses' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-search me-2"></i>Browse Courses
                        </a>
                        <a href="{% url 'lms_sync:review_mappings' %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-clipboard-check me-2"></i>Review Mappings
                            {% if stats.pending_mappings > 0 %}
                            <span class="badge bg-warning">{{ stats.pending_mappings }}</span>
                            {% endif %}
                        </a>
                        <a href="{% url 'lms_sync:sync_logs' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-history me-2"></i>Sync History
                        </a>
                        <a href="{% url 'lms_sync:moodle_tutorial' %}" class="btn btn-outline-secondary btn-sm" target="_blank">
                            <i class="fas fa-book-reader me-2"></i>View Tutorial
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Courses -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-book me-2"></i>Synced Courses
                        </h5>
                        <a href="{% url 'lms_sync:browse_courses' %}" class="btn btn-sm btn-primary">
                            View All <i class="fas fa-arrow-right ms-2"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_courses %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th>Module</th>
                                    <th>Enrollments</th>
                                    <th>Activities</th>
                                    <th>Mapped</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in recent_courses %}
                                <tr>
                                    <td><strong>{{ course.shortname }}</strong></td>
                                    <td>{{ course.fullname|truncatewords:8 }}</td>
                                    <td>
                                        {% if course.module %}
                                        {{ course.module.code }}
                                        {% else %}
                                        <span class="text-muted">Not mapped</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ course.enrollments.count }}</td>
                                    <td>{{ course.activities.count }}</td>
                                    <td>
                                        {% with mapped=course.activities_mapped total=course.activities.count %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if mapped == total %}bg-success{% elif mapped > 0 %}bg-warning{% else %}bg-secondary{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {% if total > 0 %}{{ mapped|div:total|mul:100 }}{% else %}0{% endif %}%">
                                                {{ mapped }}/{{ total }}
                                            </div>
                                        </div>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <a href="{% url 'lms_sync:course_detail' course.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-book text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">No courses synced yet</p>
                        <button type="button" class="btn btn-primary" onclick="triggerSync()">
                            <i class="fas fa-sync-alt me-2"></i>Run Initial Sync
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sync Logs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Sync Activity
                        </h5>
                        <a href="{% url 'lms_sync:sync_logs' %}" class="btn btn-sm btn-secondary">
                            View All <i class="fas fa-arrow-right ms-2"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_logs %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Sync Type</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>{{ log.started_at|date:"Y-m-d H:i" }}</td>
                                    <td><span class="badge bg-info">{{ log.get_sync_type_display }}</span></td>
                                    <td>
                                        {% if log.status == 'COMPLETED' %}
                                        <span class="badge bg-success">{{ log.status }}</span>
                                        {% elif log.status == 'FAILED' %}
                                        <span class="badge bg-danger">{{ log.status }}</span>
                                        {% else %}
                                        <span class="badge bg-warning">{{ log.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            Created: {{ log.records_created }}<br>
                                            Updated: {{ log.records_updated }}<br>
                                            Failed: {{ log.records_failed }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if log.completed_at %}
                                        {{ log.started_at|timesince:log.completed_at }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No sync activity yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Instance Setup for selected brand -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card text-center">
                <div class="card-body py-5">
                    <i class="fas fa-graduation-cap text-muted" style="font-size: 5rem;"></i>
                    <h3 class="mt-4 mb-3">No Moodle Instance Configured for {{ selected_brand.name }}</h3>
                    <p class="text-muted mb-4">Get started by setting up Moodle LMS integration for this brand.</p>
                    <a href="{% url 'lms_sync:setup_wizard' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Setup Moodle Integration
                    </a>
                    <div class="mt-4">
                        <a href="{% url 'lms_sync:moodle_tutorial' %}" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-book-reader me-2"></i>View Setup Tutorial
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function testConnection() {
    // AJAX call to test connection
    fetch('{% url "lms_sync:test_connection" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ Connection successful!\n\n' + data.message);
        } else {
            alert('✗ Connection failed\n\n' + data.message);
        }
    })
    .catch(error => {
        alert('Error testing connection: ' + error);
    });
}

function triggerSync() {
    if (confirm('Start manual synchronization?\n\nThis will pull courses, enrollments, and grades from Moodle.')) {
        // AJAX call to trigger sync
        fetch('{% url "lms_sync:trigger_sync" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✓ Sync started!\n\nCheck sync history for progress.');
                location.reload();
            } else {
                alert('✗ Failed to start sync\n\n' + data.message);
            }
        })
        .catch(error => {
            alert('Error starting sync: ' + error);
        });
    }
}
</script>
{% endblock %}
