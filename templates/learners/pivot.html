{% extends 'base/app_layout.html' %}
{% load static %}
{% load learner_tags %}

{% block title %}Learner Pivot Analysis - SkillsFlow{% endblock %}

{% block main_content %}
<div class="flex flex-col h-full" x-data="pivotTable()">
    <!-- Page Header -->
    <div class="flex-shrink-0 bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Learner Pivot Analysis</h1>
                <p class="mt-1 text-sm text-gray-500">Cross-tabulate learner data by multiple dimensions</p>
            </div>
            
            <!-- View Switcher -->
            <div class="flex items-center space-x-3">
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <a href="{% url 'learners:list' %}" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        List
                    </a>
                    <a href="{% url 'learners:kanban' %}" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                        </svg>
                        Kanban
                    </a>
                    <span class="px-3 py-1.5 text-sm font-medium rounded-md bg-white shadow text-primary-700">
                        <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Pivot
                    </span>
                </div>
                
                <button @click="exportPivot()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>
        
        <!-- Pivot Controls -->
        <div class="mt-4 bg-gray-50 rounded-lg p-4">
            <form method="get" class="flex flex-wrap items-end gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Rows</label>
                    <select name="rows" 
                            onchange="this.form.submit()"
                            class="border border-gray-300 rounded-lg text-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500 w-40">
                        <option value="status" {% if rows == 'status' %}selected{% endif %}>Status</option>
                        <option value="qualification" {% if rows == 'qualification' %}selected{% endif %}>Qualification</option>
                        <option value="campus" {% if rows == 'campus' %}selected{% endif %}>Campus</option>
                        <option value="funding_type" {% if rows == 'funding_type' %}selected{% endif %}>Funding Type</option>
                        <option value="population_group" {% if rows == 'population_group' %}selected{% endif %}>Population Group</option>
                        <option value="gender" {% if rows == 'gender' %}selected{% endif %}>Gender</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Columns</label>
                    <select name="cols" 
                            onchange="this.form.submit()"
                            class="border border-gray-300 rounded-lg text-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500 w-40">
                        <option value="campus" {% if cols == 'campus' %}selected{% endif %}>Campus</option>
                        <option value="status" {% if cols == 'status' %}selected{% endif %}>Status</option>
                        <option value="qualification" {% if cols == 'qualification' %}selected{% endif %}>Qualification</option>
                        <option value="funding_type" {% if cols == 'funding_type' %}selected{% endif %}>Funding Type</option>
                        <option value="gender" {% if cols == 'gender' %}selected{% endif %}>Gender</option>
                        <option value="year" {% if cols == 'year' %}selected{% endif %}>Enrollment Year</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Values</label>
                    <select name="values" 
                            onchange="this.form.submit()"
                            class="border border-gray-300 rounded-lg text-sm py-2 px-3 focus:ring-primary-500 focus:border-primary-500 w-40">
                        <option value="count" {% if values == 'count' %}selected{% endif %}>Count</option>
                        <option value="avg_progress" {% if values == 'avg_progress' %}selected{% endif %}>Avg Progress %</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Pivot Table -->
    <div class="flex-1 overflow-auto p-6 bg-gray-50">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100 sticky left-0">
                                {{ rows|title }}
                            </th>
                            {% for col in column_headers %}
                            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                {{ col|default:"(None)" }}
                            </th>
                            {% endfor %}
                            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider bg-gray-100">
                                Total
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for row_name, row_data in pivot_data.items %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 bg-gray-50 sticky left-0">
                                {{ row_name|default:"(None)" }}
                            </td>
                            {% for col in column_headers %}
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center 
                                {% if row_data|get_item:col > 0 %}text-gray-900{% else %}text-gray-300{% endif %}">
                                {% with value=row_data|get_item:col %}
                                {% if value %}
                                <span class="inline-flex items-center justify-center min-w-[40px] px-2 py-1 rounded 
                                    {% if value > 20 %}bg-green-100 text-green-800
                                    {% elif value > 10 %}bg-blue-100 text-blue-800
                                    {% elif value > 5 %}bg-amber-100 text-amber-800
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ value }}
                                </span>
                                {% else %}
                                —
                                {% endif %}
                                {% endwith %}
                            </td>
                            {% endfor %}
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900 bg-gray-50">
                                {{ row_data.total|default:0 }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ column_headers|length|add:2 }}" class="px-6 py-12 text-center text-gray-500">
                                No data to display
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gray-100">
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-gray-100">
                                Total
                            </td>
                            {% for col in column_headers %}
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                                {{ column_totals|get_item:col|default:0 }}
                            </td>
                            {% endfor %}
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-primary-700">
                                {{ grand_total|default:0 }}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Enrollments</p>
                        <p class="text-2xl font-bold text-gray-900">{{ grand_total }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Active Learners</p>
                        <p class="text-2xl font-bold text-gray-900">{{ active_count }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Unique Categories</p>
                        <p class="text-2xl font-bold text-gray-900">{{ pivot_data|length }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function pivotTable() {
    return {
        exportPivot() {
            // Export pivot table as CSV
            const table = document.querySelector('table');
            let csv = [];
            
            // Get headers
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent.trim());
            });
            csv.push(headers.join(','));
            
            // Get rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    let text = td.textContent.trim().replace('—', '0');
                    row.push(text);
                });
                csv.push(row.join(','));
            });
            
            // Get totals
            const totals = [];
            table.querySelectorAll('tfoot td').forEach(td => {
                totals.push(td.textContent.trim());
            });
            csv.push(totals.join(','));
            
            // Download
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'learner_pivot_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
        }
    }
}
</script>
{% endblock %}
