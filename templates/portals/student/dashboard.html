{% extends 'base/app_layout.html' %}
{% load static %}

{% block title %}My Dashboard - Learner Portal{% endblock %}

{% block page_header %}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Welcome back, {{ learner.user.first_name }}!</h1>
        <p class="mt-1 text-sm text-gray-500">Track your learning journey</p>
    </div>
    <div class="mt-4 sm:mt-0 flex items-center gap-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800">
            <i class="fas fa-id-card mr-2"></i>{{ learner.id_number|default:"N/A" }}
        </span>
        <a href="{% url 'core:dashboard' %}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
            <i class="fas fa-arrow-left mr-2"></i>Main Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-book text-blue-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-2xl font-bold text-gray-900">{{ enrollments|length }}</p>
                    <p class="text-xs text-gray-500">Active Courses</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-amber-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-2xl font-bold text-gray-900">{{ upcoming_assessments|length }}</p>
                    <p class="text-xs text-gray-500">Upcoming Tests</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-2xl font-bold text-gray-900">{{ recent_marks|length }}</p>
                    <p class="text-xs text-gray-500">Recent Results</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-percentage text-purple-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-2xl font-bold text-gray-900">{{ avg_score|floatformat:0 }}%</p>
                    <p class="text-xs text-gray-500">Average Score</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Sessions Alert -->
    {% if today_sessions %}
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Today's Sessions</h3>
                    <p class="mt-1 text-sm text-blue-700">
                        You have <strong>{{ today_sessions|length }}</strong> session{{ today_sessions|length|pluralize }} scheduled for today.
                    </p>
                </div>
            </div>
            <a href="{% url 'portals:student_schedule' %}?view=today" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">
                View Schedule
            </a>
        </div>
    </div>
    {% endif %}

    {% if tomorrow_sessions %}
    <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-purple-600 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-purple-800">Tomorrow's Sessions</h3>
                    <p class="mt-1 text-sm text-purple-700">
                        You have <strong>{{ tomorrow_sessions|length }}</strong> session{{ tomorrow_sessions|length|pluralize }} scheduled for tomorrow.
                    </p>
                </div>
            </div>
            <a href="{% url 'portals:student_schedule' %}?view=tomorrow" class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition">
                View Schedule
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <a href="{% url 'portals:student_enrollments' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-blue-200 transition">
                <i class="fas fa-graduation-cap text-blue-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">My Courses</span>
            <span class="text-xs text-gray-500">View enrollments</span>
        </a>
        
        <a href="{% url 'portals:student_marks' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-green-200 transition">
                <i class="fas fa-chart-line text-green-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">My Marks</span>
            <span class="text-xs text-gray-500">View results</span>
        </a>
        
        <a href="{% url 'portals:student_attendance' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-orange-200 transition">
                <i class="fas fa-clipboard-check text-orange-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">Attendance</span>
            <span class="text-xs text-gray-500">Workplace register</span>
        </a>
        
        <a href="{% url 'portals:student_schedule' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-indigo-200 transition">
                <i class="fas fa-calendar-alt text-indigo-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">Schedule</span>
            <span class="text-xs text-gray-500">View calendar</span>
        </a>
        
        <a href="{% url 'portals:student_materials' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-purple-200 transition">
                <i class="fas fa-folder-open text-purple-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">Materials</span>
            <span class="text-xs text-gray-500">Learning resources</span>
        </a>
        
        <a href="{% url 'portals:student_timetable' %}" class="bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center text-center transition group">
            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mb-2 group-hover:bg-amber-200 transition">
                <i class="fas fa-calendar-alt text-amber-600 text-xl"></i>
            </div>
            <span class="font-medium text-gray-900">Timetable</span>
            <span class="text-xs text-gray-500">Class schedule</span>
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- My Courses -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">
                    <i class="fas fa-book-open text-primary-600 mr-2"></i>My Courses
                </h3>
                <a href="{% url 'portals:student_enrollments' %}" class="text-sm text-primary-600 hover:text-primary-700">View all →</a>
            </div>
            <div class="divide-y divide-gray-100">
                {% for item in enrollments|slice:":4" %}
                <a href="{% url 'portals:student_course_detail' item.enrollment.id %}" class="block px-5 py-4 hover:bg-gray-50 transition">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-900 truncate">{{ item.enrollment.qualification.title }}</h4>
                            <p class="text-sm text-gray-500 mt-1">{% if item.enrollment.cohort %}{{ item.enrollment.cohort.name }}{% else %}Self-paced{% endif %}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            {% if item.enrollment.status == 'ACTIVE' %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                            {% elif item.enrollment.status == 'COMPLETED' %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                Completed
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                {{ item.enrollment.get_status_display }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Progress bar -->
                    <div class="mt-3">
                        <div class="flex items-center justify-between text-xs mb-1">
                            <span class="text-gray-500">Progress</span>
                            <span class="font-medium text-gray-700">{{ item.progress|default:0 }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary-600 h-2 rounded-full transition-all" style="width: {{ item.progress|default:0 }}%"></div>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="px-5 py-8 text-center text-gray-500">
                    <i class="fas fa-graduation-cap text-3xl text-gray-300 mb-2"></i>
                    <p>You are not enrolled in any courses yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Upcoming Assessments -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="px-5 py-4 border-b border-gray-100">
                <h3 class="font-semibold text-gray-900">
                    <i class="fas fa-clipboard-list text-amber-600 mr-2"></i>Upcoming Assessments
                </h3>
            </div>
            <div class="divide-y divide-gray-100">
                {% for assessment in upcoming_assessments|slice:":5" %}
                <div class="px-5 py-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            {% if assessment.activity_type == 'TEST' %}
                            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-alt text-red-600"></i>
                            </div>
                            {% elif assessment.activity_type == 'ASSIGNMENT' %}
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tasks text-blue-600"></i>
                            </div>
                            {% elif assessment.activity_type == 'PRACTICAL' %}
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tools text-green-600"></i>
                            </div>
                            {% else %}
                            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clipboard text-gray-600"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="font-medium text-gray-900">{{ assessment.title }}</h4>
                            <p class="text-sm text-gray-500">{{ assessment.module.title }}</p>
                            <div class="mt-2 flex items-center gap-3 text-xs">
                                <span class="inline-flex items-center text-gray-500">
                                    <i class="fas fa-tag mr-1"></i>{{ assessment.get_activity_type_display }}
                                </span>
                                <span class="inline-flex items-center text-gray-500">
                                    <i class="fas fa-percentage mr-1"></i>{{ assessment.weight }}% weight
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="px-5 py-8 text-center text-gray-500">
                    <i class="fas fa-check-circle text-3xl text-green-300 mb-2"></i>
                    <p>No upcoming assessments! You're all caught up.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Marks -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">
                <i class="fas fa-chart-bar text-green-600 mr-2"></i>Recent Results
            </h3>
            <a href="{% url 'portals:student_marks' %}" class="text-sm text-primary-600 hover:text-primary-700">View all marks →</a>
        </div>
        {% if recent_marks %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment</th>
                        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-5 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                        <th class="px-5 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for mark in recent_marks|slice:":5" %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-5 py-4">
                            <div class="font-medium text-gray-900">{{ mark.activity.title }}</div>
                            <div class="text-sm text-gray-500">{{ mark.activity.get_activity_type_display }}</div>
                        </td>
                        <td class="px-5 py-4 text-sm text-gray-600">
                            {{ mark.enrollment.cohort.qualification.title|truncatechars:30 }}
                        </td>
                        <td class="px-5 py-4 text-sm text-gray-600">
                            {{ mark.assessment_date|date:"d M Y" }}
                        </td>
                        <td class="px-5 py-4 text-center">
                            {% if mark.percentage_score is not None %}
                            <span class="font-bold {% if mark.percentage_score >= 70 %}text-green-600{% elif mark.percentage_score >= 50 %}text-amber-600{% else %}text-red-600{% endif %}">
                                {{ mark.percentage_score|floatformat:0 }}%
                            </span>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-4 text-center">
                            {% if mark.result == 'C' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Competent
                            </span>
                            {% elif mark.result == 'NYC' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">
                                <i class="fas fa-times mr-1"></i>NYC
                            </span>
                            {% elif mark.result == 'ABS' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-800">
                                Absent
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-800">
                                {{ mark.get_result_display|default:"Pending" }}
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-5 py-8 text-center text-gray-500">
            <i class="fas fa-clipboard-check text-3xl text-gray-300 mb-2"></i>
            <p>No assessment results yet.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
