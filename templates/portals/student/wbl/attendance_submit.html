{% extends 'portals/student/base.html' %}
{% load static %}

{% block title %}Submit Attendance - SkillsFlow{% endblock %}

{% block extra_head %}
<style>
    .camera-preview {
        max-width: 100%;
        border-radius: 12px;
        background: #000;
    }
    
    .gps-indicator {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    
    .offline-badge {
        position: fixed;
        top: 70px;
        right: 16px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'portals:student_dashboard' %}" class="text-gray-700 hover:text-primary-600">Dashboard</a>
        </li>
        <li><span class="mx-2 text-gray-400">/</span></li>
        <li>
            <a href="{% url 'portals:student_wbl_dashboard' %}" class="text-gray-700 hover:text-primary-600">WBL</a>
        </li>
        <li><span class="mx-2 text-gray-400">/</span></li>
        <li>
            <a href="{% url 'portals:student_attendance' %}" class="text-gray-700 hover:text-primary-600">Attendance</a>
        </li>
        <li><span class="mx-2 text-gray-400">/</span></li>
        <li class="text-gray-500">Submit</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Offline Status Indicator -->
<div id="offlineBadge" class="offline-badge hidden">
    <div class="bg-amber-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"></path>
        </svg>
        <span class="font-medium">Offline Mode</span>
    </div>
</div>

<div class="max-w-2xl mx-auto space-y-6">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 rounded-xl shadow-lg p-6 text-white">
        <h1 class="text-2xl font-bold">Submit Attendance</h1>
        <p class="text-emerald-100 mt-1">{{ placement.host.employer.company_name }}</p>
    </div>
    
    <!-- GPS Status Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Location Verification</h3>
            <div id="gpsStatus" class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                <span class="text-sm text-gray-600">Detecting...</span>
            </div>
        </div>
        
        <div id="gpsDetails" class="text-sm text-gray-600 space-y-1 hidden">
            <p>üìç Latitude: <span id="gpsLat" class="font-mono">-</span></p>
            <p>üìç Longitude: <span id="gpsLng" class="font-mono">-</span></p>
            <p>üéØ Accuracy: <span id="gpsAcc">-</span> meters</p>
        </div>
        
        <div id="gpsError" class="hidden">
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                <p class="font-medium">‚ö†Ô∏è Location Access Denied</p>
                <p class="mt-1">Please enable location services to verify your workplace attendance.</p>
            </div>
        </div>
    </div>
    
    <!-- Attendance Form -->
    <form id="attendanceForm" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
        
        <!-- Date -->
        <div>
            <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">
                Date <span class="text-red-500">*</span>
            </label>
            <input type="date" id="attendanceDate" name="date" required
                   max="{{ today|date:'Y-m-d' }}"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
        </div>
        
        <!-- Attendance Type -->
        <div>
            <label for="attendanceType" class="block text-sm font-medium text-gray-700 mb-2">
                Status <span class="text-red-500">*</span>
            </label>
            <select id="attendanceType" name="type" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                <option value="">Select status...</option>
                {% for code, label in attendance_types %}
                <option value="{{ code }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Clock In/Out Times -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="clockIn" class="block text-sm font-medium text-gray-700 mb-2">
                    Clock In
                </label>
                <input type="time" id="clockIn" name="clock_in"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
            </div>
            <div>
                <label for="clockOut" class="block text-sm font-medium text-gray-700 mb-2">
                    Clock Out
                </label>
                <input type="time" id="clockOut" name="clock_out"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
            </div>
        </div>
        
        <!-- Photo Capture -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Photo Proof <span class="text-gray-500">(Optional)</span>
            </label>
            
            <div id="photoSection" class="space-y-3">
                <!-- Camera Preview -->
                <div id="cameraPreview" class="hidden">
                    <video id="cameraVideo" class="camera-preview w-full" autoplay playsinline></video>
                    <div class="flex space-x-2 mt-3">
                        <button type="button" id="captureBtn" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                            üì∏ Capture Photo
                        </button>
                        <button type="button" id="cancelCameraBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Photo Preview -->
                <div id="photoPreview" class="hidden">
                    <img id="photoImg" class="camera-preview w-full" alt="Captured photo">
                    <div class="flex space-x-2 mt-3">
                        <button type="button" id="retakeBtn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            üîÑ Retake
                        </button>
                        <button type="button" id="removePhotoBtn" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                </div>
                
                <!-- Upload Buttons -->
                <div id="photoButtons">
                    <div class="flex space-x-2">
                        <button type="button" id="openCameraBtn" class="flex-1 px-4 py-3 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-lg hover:bg-emerald-100 flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span>Take Photo</span>
                        </button>
                        <label for="photoUpload" class="flex-1 px-4 py-3 bg-gray-50 text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-100 flex items-center justify-center space-x-2 cursor-pointer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Upload</span>
                        </label>
                        <input type="file" id="photoUpload" name="photo" accept="image/*" class="hidden">
                    </div>
                </div>
            </div>
            <canvas id="photoCanvas" class="hidden"></canvas>
        </div>
        
        <!-- Notes -->
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                Notes <span class="text-gray-500">(Optional)</span>
            </label>
            <textarea id="notes" name="notes" rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      placeholder="Any additional information..."></textarea>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" id="submitBtn" class="w-full px-6 py-4 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 focus:ring-4 focus:ring-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed">
            Submit Attendance
        </button>
        
        <!-- Offline Queue Info -->
        <div id="offlineQueue" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <strong>Offline Mode:</strong> Your attendance will be saved locally and synced when you're back online.
            </p>
        </div>
    </form>
    
    <!-- Pending Queue -->
    <div id="pendingQueue" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Pending Submissions (<span id="queueCount">0</span>)</h3>
        <div id="queueList" class="space-y-2"></div>
        <button type="button" id="syncNowBtn" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            üîÑ Sync Now
        </button>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
// IndexedDB Setup for Offline Queue
const DB_NAME = 'SkillsFlowOffline';
const DB_VERSION = 1;
const STORE_NAME = 'attendanceQueue';
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('client_uuid', 'client_uuid', { unique: true });
                store.createIndex('timestamp', 'timestamp', { unique: false });
            }
        };
    });
}

// GPS Capture
let gpsData = null;

function captureGPS() {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                gpsData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date().toISOString()
                };
                
                // Update UI
                document.getElementById('gpsStatus').innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-green-500 gps-indicator"></div>
                    <span class="text-sm text-green-600 font-medium">Location Verified</span>
                `;
                document.getElementById('gpsDetails').classList.remove('hidden');
                document.getElementById('gpsLat').textContent = gpsData.latitude.toFixed(6);
                document.getElementById('gpsLng').textContent = gpsData.longitude.toFixed(6);
                document.getElementById('gpsAcc').textContent = Math.round(gpsData.accuracy);
            },
            (error) => {
                console.error('GPS error:', error);
                document.getElementById('gpsStatus').innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                    <span class="text-sm text-amber-600">Location Unavailable</span>
                `;
                document.getElementById('gpsError').classList.remove('hidden');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }
}

// Camera Handling
let stream = null;
let capturedPhoto = null;

document.getElementById('openCameraBtn').addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' },
            audio: false 
        });
        
        document.getElementById('cameraVideo').srcObject = stream;
        document.getElementById('photoButtons').classList.add('hidden');
        document.getElementById('cameraPreview').classList.remove('hidden');
    } catch (error) {
        alert('Could not access camera: ' + error.message);
    }
});

document.getElementById('captureBtn').addEventListener('click', () => {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        capturedPhoto = blob;
        const url = URL.createObjectURL(blob);
        document.getElementById('photoImg').src = url;
        
        // Stop camera
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        document.getElementById('cameraPreview').classList.add('hidden');
        document.getElementById('photoPreview').classList.remove('hidden');
    }, 'image/jpeg', 0.8);
});

document.getElementById('cancelCameraBtn').addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    document.getElementById('cameraPreview').classList.add('hidden');
    document.getElementById('photoButtons').classList.remove('hidden');
});

document.getElementById('retakeBtn').addEventListener('click', () => {
    document.getElementById('photoPreview').classList.add('hidden');
    document.getElementById('photoButtons').classList.remove('hidden');
    capturedPhoto = null;
});

document.getElementById('removePhotoBtn').addEventListener('click', () => {
    document.getElementById('photoPreview').classList.add('hidden');
    document.getElementById('photoButtons').classList.remove('hidden');
    capturedPhoto = null;
});

document.getElementById('photoUpload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        capturedPhoto = file;
        const url = URL.createObjectURL(file);
        document.getElementById('photoImg').src = url;
        document.getElementById('photoButtons').classList.add('hidden');
        document.getElementById('photoPreview').classList.remove('hidden');
    }
});

// Form Submission
document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const clientUUID = crypto.randomUUID();
    
    // Add GPS data
    if (gpsData) {
        formData.append('gps_latitude', gpsData.latitude);
        formData.append('gps_longitude', gpsData.longitude);
        formData.append('gps_accuracy', gpsData.accuracy);
        formData.append('gps_timestamp', gpsData.timestamp);
    }
    
    // Add photo
    if (capturedPhoto) {
        formData.append('photo', capturedPhoto, 'attendance.jpg');
    }
    
    // Add client UUID for deduplication
    formData.append('client_uuid', clientUUID);
    
    const isOnline = navigator.onLine;
    
    if (isOnline) {
        // Try direct submission
        await submitAttendance(formData);
    } else {
        // Queue for later
        await queueAttendance(formData, clientUUID);
    }
});

async function submitAttendance(formData) {
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    
    try {
        const response = await fetch('{% url "portals:student_attendance_submit" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Attendance submitted successfully!');
            window.location.href = '{% url "portals:student_attendance" %}';
        } else {
            throw new Error(data.error || 'Submission failed');
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Attendance';
    }
}

async function queueAttendance(formData, clientUUID) {
    const record = {
        client_uuid: clientUUID,
        date: formData.get('date'),
        type: formData.get('type'),
        clock_in: formData.get('clock_in'),
        clock_out: formData.get('clock_out'),
        notes: formData.get('notes'),
        gps_latitude: formData.get('gps_latitude'),
        gps_longitude: formData.get('gps_longitude'),
        gps_accuracy: formData.get('gps_accuracy'),
        gps_timestamp: formData.get('gps_timestamp'),
        offline_created: true,
        timestamp: Date.now(),
        // Store photo as base64 if present
        photo: capturedPhoto ? await blobToBase64(capturedPhoto) : null
    };
    
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    await store.add(record);
    
    alert('üì• Attendance saved offline. Will sync when online.');
    updatePendingQueue();
}

function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function updatePendingQueue() {
    if (!db) return;
    
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const records = await store.getAll();
    
    if (records.length > 0) {
        document.getElementById('pendingQueue').classList.remove('hidden');
        document.getElementById('queueCount').textContent = records.length;
        
        const list = document.getElementById('queueList');
        list.innerHTML = records.map(r => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg text-sm">
                <span>${r.date} - ${r.type}</span>
                <span class="text-amber-600 font-medium">Pending</span>
            </div>
        `).join('');
    } else {
        document.getElementById('pendingQueue').classList.add('hidden');
    }
}

// Sync pending records
document.getElementById('syncNowBtn')?.addEventListener('click', async () => {
    if (!navigator.onLine) {
        alert('Still offline. Please connect to internet.');
        return;
    }
    
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const records = await store.getAll();
    
    for (const record of records) {
        try {
            const formData = new FormData();
            Object.keys(record).forEach(key => {
                if (key !== 'id' && key !== 'photo' && record[key]) {
                    formData.append(key, record[key]);
                }
            });
            
            // Reconstruct photo from base64
            if (record.photo) {
                const response = await fetch(record.photo);
                const blob = await response.blob();
                formData.append('photo', blob, 'attendance.jpg');
            }
            
            const response = await fetch('{% url "portals:student_attendance_submit" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            if (response.ok) {
                await store.delete(record.id);
            }
        } catch (error) {
            console.error('Sync error:', error);
        }
    }
    
    updatePendingQueue();
    alert('‚úÖ Sync complete!');
});

// Online/Offline Detection
window.addEventListener('online', () => {
    document.getElementById('offlineBadge').classList.add('hidden');
    document.getElementById('offlineQueue').classList.add('hidden');
    updatePendingQueue();
});

window.addEventListener('offline', () => {
    document.getElementById('offlineBadge').classList.remove('hidden');
    document.getElementById('offlineQueue').classList.remove('hidden');
});

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await initDB();
    captureGPS();
    updatePendingQueue();
    
    // Set today's date as default
    document.getElementById('attendanceDate').valueAsDate = new Date();
    
    // Check online status
    if (!navigator.onLine) {
        document.getElementById('offlineBadge').classList.remove('hidden');
        document.getElementById('offlineQueue').classList.remove('hidden');
    }
});
</script>
{% endblock %}
