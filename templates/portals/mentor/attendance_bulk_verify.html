{% extends 'portals/mentor/base.html' %}
{% load static %}

{% block title %}Bulk Attendance Verification - SkillsFlow{% endblock %}

{% block extra_head %}
<style>
    .bulk-verify-container {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .verification-row {
        transition: all 0.2s ease;
    }
    
    .verification-row:hover {
        background-color: #f9fafb;
    }
    
    .verification-row.selected {
        background-color: #eff6ff;
        border-left: 4px solid #3b82f6;
    }
    
    .gps-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .photo-thumbnail {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .photo-thumbnail:hover {
        transform: scale(1.1);
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
    }
    
    .modal-content {
        position: relative;
        margin: 5% auto;
        max-width: 800px;
        background: white;
        border-radius: 1rem;
        overflow: hidden;
    }
    
    .modal-image {
        width: 100%;
        max-height: 70vh;
        object-fit: contain;
    }
    
    .sticky-actions {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 2px solid #e5e7eb;
        padding: 1rem;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="bulk-verify-container">
    
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Bulk Attendance Verification</h1>
                <p class="text-gray-600 mt-1">Review and verify multiple attendance records efficiently</p>
            </div>
            <a href="{% url 'portals:mentor_dashboard' %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                ‚Üê Back to Dashboard
            </a>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="text-2xl font-bold text-gray-900">{{ stats.total }}</div>
                <div class="text-sm text-gray-600">Total Records</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="text-2xl font-bold text-amber-600">{{ stats.unverified }}</div>
                <div class="text-sm text-gray-600">Unverified</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="text-2xl font-bold text-green-600">{{ stats.verified }}</div>
                <div class="text-sm text-gray-600">Verified</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="text-2xl font-bold text-blue-600">{{ stats.with_gps }}</div>
                <div class="text-sm text-gray-600">With GPS</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <div class="text-2xl font-bold text-purple-600">{{ stats.with_photo }}</div>
                <div class="text-sm text-gray-600">With Photo</div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
        <form method="get" id="filterForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="learner" class="block text-sm font-medium text-gray-700 mb-2">Learner</label>
                <select id="learner" name="learner" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Learners</option>
                    {% for placement in placements %}
                    <option value="{{ placement.learner.id }}" {% if learner_filter == placement.learner.id|stringformat:"s" %}selected{% endif %}>
                        {{ placement.learner.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                    <option value="unverified" {% if status_filter == 'unverified' %}selected{% endif %}>Unverified Only</option>
                    <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>Verified Only</option>
                    <option value="with_gps" {% if status_filter == 'with_gps' %}selected{% endif %}>With GPS</option>
                    <option value="with_photo" {% if status_filter == 'with_photo' %}selected{% endif %}>With Photo</option>
                </select>
            </div>
            
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üîç Apply Filters
                </button>
            </div>
        </form>
    </div>
    
    <!-- Bulk Actions Bar -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-sm p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2 text-white cursor-pointer">
                    <input type="checkbox" id="selectAll" class="w-5 h-5 rounded border-white/30">
                    <span class="font-medium">Select All (<span id="selectedCount">0</span>)</span>
                </label>
            </div>
            
            <div class="flex items-center space-x-2">
                <button id="verifyBtn" disabled class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚úì Verify Selected
                </button>
                <button id="rejectBtn" disabled class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚úó Reject Selected
                </button>
            </div>
        </div>
    </div>
    
    <!-- Attendance Records Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {% if attendance_records %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" id="headerCheckbox" class="w-4 h-4 rounded border-gray-300">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Learner</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GPS</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verification</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="attendanceTableBody">
                    {% for record in attendance_records %}
                    <tr class="verification-row" data-record-id="{{ record.id }}">
                        <td class="px-4 py-3">
                            <input type="checkbox" class="record-checkbox w-4 h-4 rounded border-gray-300" data-record-id="{{ record.id }}">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ record.date|date:"D, d M Y" }}</div>
                            <div class="text-xs text-gray-500">{{ record.date|date:"Y-m-d" }}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">{{ record.placement.learner.get_full_name }}</div>
                            <div class="text-xs text-gray-500">{{ record.placement.enrollment.qualification.short_name|default:"Learner" }}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if record.attendance_type == 'PRESENT' %}bg-green-100 text-green-700
                                {% elif record.attendance_type == 'ABSENT' %}bg-red-100 text-red-700
                                {% elif record.attendance_type == 'SICK' %}bg-amber-100 text-amber-700
                                {% elif record.attendance_type == 'ANNUAL' %}bg-blue-100 text-blue-700
                                {% elif record.attendance_type == 'FAMILY' %}bg-purple-100 text-purple-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ record.get_attendance_type_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {% if record.clock_in and record.clock_out %}
                                {{ record.clock_in|time:"H:i" }} - {{ record.clock_out|time:"H:i" }}
                                <div class="text-xs text-gray-500">{{ record.hours_worked|floatformat:1 }}h</div>
                            {% elif record.clock_in %}
                                In: {{ record.clock_in|time:"H:i" }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if record.gps_latitude and record.gps_longitude %}
                                <button onclick="showGPS({{ record.gps_latitude }}, {{ record.gps_longitude }}, {{ record.gps_accuracy|default:0 }})" 
                                        class="gps-badge bg-blue-100 text-blue-700 hover:bg-blue-200">
                                    üìç View Location
                                </button>
                                <div class="text-xs text-gray-500 mt-1">¬±{{ record.gps_accuracy|floatformat:0|default:"?" }}m</div>
                            {% else %}
                                <span class="text-gray-400 text-sm">No GPS</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if record.photo %}
                                <img src="{{ record.photo.url }}" alt="Attendance photo" class="photo-thumbnail" 
                                     onclick="showPhotoModal('{{ record.photo.url }}', '{{ record.placement.learner.get_full_name }}', '{{ record.date|date:"d M Y" }}')">
                            {% else %}
                                <span class="text-gray-400 text-sm">No Photo</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            {% if record.mentor_verified %}
                                <div class="flex items-center text-green-600">
                                    <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Verified</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ record.mentor_verified_at|date:"d/m H:i" }}</div>
                            {% else %}
                                <span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 rounded-full">
                                    Pending
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            {% if not record.mentor_verified %}
                                <button onclick="verifyRecord({{ record.id }})" class="text-green-600 hover:text-green-700 font-medium mr-2">
                                    ‚úì Verify
                                </button>
                                <button onclick="rejectRecord({{ record.id }})" class="text-red-600 hover:text-red-700 font-medium">
                                    ‚úó Reject
                                </button>
                            {% else %}
                                <button onclick="unverifyRecord({{ record.id }})" class="text-gray-600 hover:text-gray-700 font-medium">
                                    Undo
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">No Attendance Records</h3>
            <p class="mt-2 text-sm text-gray-500">No attendance records found for the selected filters.</p>
            <button onclick="document.getElementById('filterForm').reset(); document.getElementById('filterForm').submit();" 
                    class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Reset Filters
            </button>
        </div>
        {% endif %}
    </div>
    
</div>

<!-- Photo Modal -->
<div id="photoModal" class="modal">
    <div class="modal-content">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div>
                <h3 class="font-semibold text-gray-900" id="modalLearnerName"></h3>
                <p class="text-sm text-gray-600" id="modalDate"></p>
            </div>
            <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <img id="modalImage" class="modal-image" src="" alt="Attendance photo">
    </div>
</div>

<!-- GPS Modal -->
<div id="gpsModal" class="modal">
    <div class="modal-content">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900">GPS Location</h3>
            <button onclick="closeGPSModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6">
            <div class="space-y-3 mb-4">
                <div class="flex justify-between">
                    <span class="text-gray-600">Latitude:</span>
                    <span class="font-mono font-semibold" id="gpsLat"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Longitude:</span>
                    <span class="font-mono font-semibold" id="gpsLng"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Accuracy:</span>
                    <span class="font-semibold" id="gpsAcc"></span>
                </div>
            </div>
            <a id="gpsMapLink" href="#" target="_blank" class="block w-full px-4 py-3 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700">
                üìç Open in Google Maps
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const selectedRecords = new Set();

// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
        const recordId = cb.dataset.recordId;
        if (this.checked) {
            selectedRecords.add(recordId);
            cb.closest('tr').classList.add('selected');
        } else {
            selectedRecords.delete(recordId);
            cb.closest('tr').classList.remove('selected');
        }
    });
    updateBulkActions();
});

// Individual checkbox handling
document.querySelectorAll('.record-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        const recordId = this.dataset.recordId;
        if (this.checked) {
            selectedRecords.add(recordId);
            this.closest('tr').classList.add('selected');
        } else {
            selectedRecords.delete(recordId);
            this.closest('tr').classList.remove('selected');
        }
        updateBulkActions();
    });
});

function updateBulkActions() {
    const count = selectedRecords.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('verifyBtn').disabled = count === 0;
    document.getElementById('rejectBtn').disabled = count === 0;
}

// Bulk Verify
document.getElementById('verifyBtn').addEventListener('click', async function() {
    if (selectedRecords.size === 0) return;
    
    if (!confirm(`Verify ${selectedRecords.size} attendance record(s)?`)) return;
    
    await bulkAction('verify');
});

// Bulk Reject
document.getElementById('rejectBtn').addEventListener('click', async function() {
    if (selectedRecords.size === 0) return;
    
    const note = prompt('Reason for rejection (optional):');
    if (note === null) return; // User cancelled
    
    await bulkAction('reject', note);
});

async function bulkAction(action, note = '') {
    try {
        const response = await fetch('{% url "portals:mentor_bulk_verify_submit" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                record_ids: Array.from(selectedRecords),
                action: action,
                rejection_note: note
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Single record actions
async function verifyRecord(recordId) {
    if (!confirm('Verify this attendance record?')) return;
    
    await bulkAction('verify', '', [recordId]);
}

async function rejectRecord(recordId) {
    const note = prompt('Reason for rejection (optional):');
    if (note === null) return;
    
    selectedRecords.clear();
    selectedRecords.add(recordId.toString());
    await bulkAction('reject', note);
}

async function unverifyRecord(recordId) {
    if (!confirm('Remove verification from this record?')) return;
    
    selectedRecords.clear();
    selectedRecords.add(recordId.toString());
    await bulkAction('reject', 'Unverified by mentor');
}

// Photo Modal
function showPhotoModal(photoUrl, learnerName, date) {
    document.getElementById('modalImage').src = photoUrl;
    document.getElementById('modalLearnerName').textContent = learnerName;
    document.getElementById('modalDate').textContent = date;
    document.getElementById('photoModal').style.display = 'block';
}

function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
}

// GPS Modal
function showGPS(lat, lng, accuracy) {
    document.getElementById('gpsLat').textContent = lat.toFixed(6);
    document.getElementById('gpsLng').textContent = lng.toFixed(6);
    document.getElementById('gpsAcc').textContent = '¬±' + Math.round(accuracy) + ' meters';
    document.getElementById('gpsMapLink').href = `https://www.google.com/maps?q=${lat},${lng}`;
    document.getElementById('gpsModal').style.display = 'block';
}

function closeGPSModal() {
    document.getElementById('gpsModal').style.display = 'none';
}

// Close modals on outside click
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePhotoModal();
        closeGPSModal();
    }
});
</script>
{% endblock %}
