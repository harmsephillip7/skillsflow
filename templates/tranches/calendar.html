{% extends 'base/app_layout.html' %}
{% load static admin_tags %}

{% block title %}Tranche Calendar - SkillsFlow{% endblock %}

{% block page_title %}{{ month_name }} {{ year }}{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{% url 'tranches:tranche_dashboard' %}" class="text-primary-600 hover:text-primary-800">Tranches</a>
</li>
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <span class="text-gray-700 font-medium">Calendar</span>
</li>
{% endblock %}

{% block page_actions %}
<div class="flex items-center space-x-3">
    <!-- Month Navigation -->
    <div class="flex items-center space-x-2">
        <a href="?year={{ prev_year }}&month={{ prev_month }}" class="p-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <span class="px-4 py-2 text-sm font-semibold text-gray-700">{{ month_name }} {{ year }}</span>
        <a href="?year={{ next_year }}&month={{ next_month }}" class="p-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
    </div>
    
    <a href="{% url 'tranches:tranche_list' %}" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-all">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
        </svg>
        List View
    </a>
</div>
{% endblock %}

{% block main_content %}
<div class="space-y-6">
    
    <!-- Legend -->
    <div class="flex items-center space-x-6 text-sm text-gray-600">
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 rounded-full bg-red-500"></span>
            <span>Overdue</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
            <span>Scheduled</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
            <span>In Progress</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 rounded-full bg-purple-500"></span>
            <span>Pending QC</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 rounded-full bg-green-500"></span>
            <span>Submitted/Paid</span>
        </div>
    </div>
    
    <!-- Calendar Grid -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <!-- Days Header -->
        <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
            {% for day_name in "Mon,Tue,Wed,Thu,Fri,Sat,Sun"|make_list %}
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                {{ day_name }}{{ forloop.counter|add:forloop.counter0 }}
            </div>
            {% endfor %}
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Mon</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Tue</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Wed</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Thu</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Fri</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Sat</div>
            <div class="px-3 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Sun</div>
        </div>
        
        <!-- Calendar Weeks -->
        {% for week in calendar %}
        <div class="grid grid-cols-7 border-b border-gray-200 last:border-b-0">
            {% for day in week %}
            {% if day == 0 %}
            <!-- Empty cell for days outside the month -->
            <div class="min-h-32 bg-gray-50 border-r border-gray-200 last:border-r-0"></div>
            {% else %}
            {% with date_key=year|stringformat:"s"|add:"-"|add:month|stringformat:"02d"|add:"-"|add:day|stringformat:"02d" %}
            <div class="min-h-32 border-r border-gray-200 last:border-r-0 {% if tranches_by_date|get_item:date_key %}bg-yellow-50{% endif %}">
                <!-- Day Number -->
                <div class="px-2 py-1 text-right">
                    <span class="text-sm font-medium text-gray-500">{{ day }}</span>
                </div>
                
                <!-- Tranches for this day -->
                {% if tranches_by_date %}
                {% for date, day_tranches in tranches_by_date.items %}
                {% if date == date_key %}
                <div class="px-1 pb-1 space-y-1">
                    {% for tranche in day_tranches %}
                    <a href="{% url 'tranches:tranche_detail' tranche.pk %}" 
                       class="block px-2 py-1 rounded text-xs truncate transition-colors
                           {% if tranche.is_overdue %}bg-red-100 text-red-800 hover:bg-red-200
                           {% elif tranche.status == 'PENDING_QC' %}bg-purple-100 text-purple-800 hover:bg-purple-200
                           {% elif tranche.status == 'EVIDENCE_COLLECTION' %}bg-blue-100 text-blue-800 hover:bg-blue-200
                           {% elif tranche.status == 'SUBMITTED' or tranche.status == 'PAID' %}bg-green-100 text-green-800 hover:bg-green-200
                           {% else %}bg-yellow-100 text-yellow-800 hover:bg-yellow-200{% endif %}">
                        <span class="font-medium">{{ tranche.reference_number|slice:":12" }}</span>
                        <span class="hidden sm:inline ml-1">{{ tranche.get_tranche_type_display|slice:":10" }}</span>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>
            {% endwith %}
            {% endif %}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    
    <!-- Upcoming Tranches Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Overdue -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 bg-red-50">
                <h3 class="text-sm font-semibold text-red-800">Overdue Tranches</h3>
            </div>
            <div class="divide-y divide-gray-100">
                {% for date, tranches_list in tranches_by_date.items %}
                    {% for tranche in tranches_list %}
                        {% if tranche.is_overdue %}
                        <a href="{% url 'tranches:tranche_detail' tranche.pk %}" class="block px-4 py-3 hover:bg-gray-50 transition-colors">
                            <p class="text-sm font-medium text-gray-900">{{ tranche.reference_number }}</p>
                            <p class="text-xs text-red-600">Due: {{ tranche.due_date|date:"d M Y" }}</p>
                        </a>
                        {% endif %}
                    {% endfor %}
                {% empty %}
                <div class="px-4 py-6 text-center text-sm text-gray-500">
                    No overdue tranches
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- This Week -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 bg-yellow-50">
                <h3 class="text-sm font-semibold text-yellow-800">This Month's Deadlines</h3>
            </div>
            <div class="divide-y divide-gray-100 max-h-80 overflow-y-auto">
                {% for date, tranches_list in tranches_by_date.items %}
                    {% for tranche in tranches_list %}
                    <a href="{% url 'tranches:tranche_detail' tranche.pk %}" class="block px-4 py-3 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-900">{{ tranche.reference_number }}</p>
                            <span class="text-xs text-gray-500">{{ tranche.due_date|date:"d M" }}</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">{{ tranche.get_tranche_type_display }}</p>
                    </a>
                    {% endfor %}
                {% empty %}
                <div class="px-4 py-6 text-center text-sm text-gray-500">
                    No tranches this month
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 bg-primary-50">
                <h3 class="text-sm font-semibold text-primary-800">Quick Actions</h3>
            </div>
            <div class="p-4 space-y-3">
                <a href="{% url 'tranches:tranche_list' %}?quick=overdue" class="block w-full px-4 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                    View Overdue
                </a>
                <a href="{% url 'tranches:tranche_list' %}?quick=pending_qc" class="block w-full px-4 py-2 text-sm font-medium text-center text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition-colors">
                    QC Queue
                </a>
                <a href="{% url 'tranches:tranche_dashboard' %}" class="block w-full px-4 py-2 text-sm font-medium text-center text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Dashboard
                </a>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}
