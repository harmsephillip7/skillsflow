{% extends 'base/app_layout.html' %}
{% load static %}

{% block page_title %}Organization Chart{% endblock %}

{% block extra_head %}
<style>
    /* D3 Org Chart Styles */
    .org-chart-container {
        width: 100%;
        height: 700px;
        overflow: hidden;
        border-radius: 12px;
    }
    
    .node {
        cursor: pointer;
    }
    
    .node rect {
        fill: #fff;
        stroke: #e5e7eb;
        stroke-width: 2px;
        rx: 8;
        ry: 8;
        transition: all 0.2s ease;
    }
    
    .node:hover rect {
        stroke: #f43f5e;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }
    
    .node text {
        font-family: 'Inter', sans-serif;
    }
    
    .node-name {
        font-size: 13px;
        font-weight: 600;
        fill: #1f2937;
    }
    
    .node-title {
        font-size: 11px;
        fill: #6b7280;
    }
    
    .node-dept {
        font-size: 10px;
        fill: #9ca3af;
    }
    
    .node-location {
        font-size: 9px;
        fill: #10b981;
    }
    
    .link {
        fill: none;
        stroke: #d1d5db;
        stroke-width: 2px;
    }
    
    /* Zoom controls */
    .zoom-controls {
        position: absolute;
        bottom: 16px;
        right: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        z-index: 10;
    }
    
    .zoom-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        color: #374151;
        transition: all 0.2s;
    }
    
    .zoom-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    /* Info card tooltip */
    .node-tooltip {
        position: absolute;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        z-index: 100;
        min-width: 250px;
        display: none;
    }
    
    .node-tooltip.active {
        display: block;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <nav class="flex items-center text-sm text-gray-500 mb-2">
                <a href="{% url 'admin:dashboard' %}" class="hover:text-primary-600">Admin</a>
                <svg class="w-4 h-4 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="{% url 'hr_admin:staff_list' %}" class="hover:text-primary-600">Staff</a>
                <svg class="w-4 h-4 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-gray-700">Organization Chart</span>
            </nav>
            <h1 class="text-2xl font-bold text-gray-900">Organization Chart</h1>
            <p class="text-gray-500 mt-1">Interactive company structure diagram</p>
        </div>
        <a href="{% url 'hr_admin:staff_list' %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200 transition">
            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
            List View
        </a>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-rose-100 rounded-lg flex items-center justify-center text-rose-600 mr-3">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ total_staff }}</p>
                    <p class="text-sm text-gray-500">Active Staff</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 mr-3">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ without_manager }}</p>
                    <p class="text-sm text-gray-500">Without Manager</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mr-3">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ without_location }}</p>
                    <p class="text-sm text-gray-500">Without Location</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Bar -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <label class="text-sm font-medium text-gray-700">Filter by Department:</label>
            <select id="departmentFilter" class="px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-rose-500 min-w-[200px]">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept.pk }}">{{ dept.name }}</option>
                {% endfor %}
            </select>
            <button onclick="resetZoom()" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-200 transition">
                <svg class="w-4 h-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Reset View
            </button>
        </div>
    </div>
    
    <!-- Org Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative">
        <div id="orgChart" class="org-chart-container"></div>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </button>
        </div>
        
        <!-- Tooltip -->
        <div id="nodeTooltip" class="node-tooltip">
            <div class="flex items-start gap-3">
                <div id="tooltipAvatar" class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-600 font-bold text-lg flex-shrink-0"></div>
                <div class="flex-1">
                    <h3 id="tooltipName" class="font-semibold text-gray-900"></h3>
                    <p id="tooltipTitle" class="text-sm text-gray-600"></p>
                    <p id="tooltipDept" class="text-sm text-gray-500"></p>
                    <p id="tooltipLocation" class="text-xs text-emerald-600 mt-1"></p>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100 flex gap-2">
                <a id="tooltipViewLink" href="#" class="text-xs text-rose-600 hover:text-rose-700 font-medium">View Profile ‚Üí</a>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Chart Instructions</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-600">
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-gray-50 rounded flex items-center justify-center">üñ±Ô∏è</span>
                <span>Click and drag to pan</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-gray-50 rounded flex items-center justify-center">üîç</span>
                <span>Scroll to zoom in/out</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-gray-50 rounded flex items-center justify-center">üëÜ</span>
                <span>Click node for details</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    // Org chart data from Django
    const orgData = {{ org_data|safe }};
    
    // Chart dimensions
    const containerWidth = document.getElementById('orgChart').clientWidth;
    const containerHeight = 700;
    const nodeWidth = 180;
    const nodeHeight = 70;
    const horizontalSpacing = 50;
    const verticalSpacing = 80;
    
    // Create SVG
    const svg = d3.select('#orgChart')
        .append('svg')
        .attr('width', containerWidth)
        .attr('height', containerHeight);
    
    // Create container group for zoom/pan
    const g = svg.append('g');
    
    // Define zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.2, 3])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });
    
    svg.call(zoom);
    
    // Create tree layout
    const treeLayout = d3.tree()
        .nodeSize([nodeWidth + horizontalSpacing, nodeHeight + verticalSpacing]);
    
    // Create hierarchy from data
    let root = d3.hierarchy(orgData);
    treeLayout(root);
    
    // Initial transform to center the tree
    const initialX = containerWidth / 2;
    const initialY = 50;
    svg.call(zoom.transform, d3.zoomIdentity.translate(initialX, initialY).scale(0.8));
    
    // Draw links
    const links = g.selectAll('.link')
        .data(root.links())
        .enter()
        .append('path')
        .attr('class', 'link')
        .attr('d', d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y + nodeHeight / 2)
        );
    
    // Create node groups
    const nodes = g.selectAll('.node')
        .data(root.descendants())
        .enter()
        .append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${d.x - nodeWidth/2}, ${d.y})`)
        .on('click', showNodeDetails);
    
    // Add rectangles
    nodes.append('rect')
        .attr('width', nodeWidth)
        .attr('height', nodeHeight)
        .attr('rx', 8);
    
    // Add name text
    nodes.append('text')
        .attr('class', 'node-name')
        .attr('x', nodeWidth / 2)
        .attr('y', 20)
        .attr('text-anchor', 'middle')
        .text(d => truncateText(d.data.name, 20));
    
    // Add title text
    nodes.append('text')
        .attr('class', 'node-title')
        .attr('x', nodeWidth / 2)
        .attr('y', 36)
        .attr('text-anchor', 'middle')
        .text(d => truncateText(d.data.title, 22));
    
    // Add department text
    nodes.append('text')
        .attr('class', 'node-dept')
        .attr('x', nodeWidth / 2)
        .attr('y', 50)
        .attr('text-anchor', 'middle')
        .text(d => truncateText(d.data.department, 24));
    
    // Add location indicator
    nodes.filter(d => d.data.location)
        .append('text')
        .attr('class', 'node-location')
        .attr('x', nodeWidth / 2)
        .attr('y', 62)
        .attr('text-anchor', 'middle')
        .text(d => 'üìç ' + truncateText(d.data.location, 18));
    
    // Helper function to truncate text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength - 2) + '...' : text;
    }
    
    // Show node details tooltip
    function showNodeDetails(event, d) {
        event.stopPropagation();
        
        const tooltip = document.getElementById('nodeTooltip');
        const data = d.data;
        
        // Set content
        document.getElementById('tooltipName').textContent = data.name;
        document.getElementById('tooltipTitle').textContent = data.title;
        document.getElementById('tooltipDept').textContent = data.department;
        document.getElementById('tooltipLocation').textContent = data.location ? 'üìç ' + data.location : 'No location set';
        document.getElementById('tooltipAvatar').textContent = getInitials(data.name);
        document.getElementById('tooltipViewLink').href = `/admin/hr/staff/${data.id}/`;
        
        // Position tooltip
        const rect = event.currentTarget.getBoundingClientRect();
        const container = document.getElementById('orgChart').getBoundingClientRect();
        
        tooltip.style.left = (rect.left - container.left + rect.width + 10) + 'px';
        tooltip.style.top = (rect.top - container.top) + 'px';
        tooltip.classList.add('active');
    }
    
    // Hide tooltip on click outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.node') && !e.target.closest('.node-tooltip')) {
            document.getElementById('nodeTooltip').classList.remove('active');
        }
    });
    
    // Get initials from name
    function getInitials(name) {
        if (!name) return '?';
        const parts = name.split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
        }
        return name[0].toUpperCase();
    }
    
    // Zoom functions
    function zoomIn() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.3);
    }
    
    function zoomOut() {
        svg.transition().duration(300).call(zoom.scaleBy, 0.7);
    }
    
    function resetZoom() {
        svg.transition().duration(500).call(
            zoom.transform, 
            d3.zoomIdentity.translate(containerWidth / 2, 50).scale(0.8)
        );
    }
    
    // Department filter
    document.getElementById('departmentFilter').addEventListener('change', function() {
        const deptId = this.value;
        if (deptId) {
            // Fetch filtered data
            fetch(`{% url 'hr_admin:org_chart_data' %}?department=${deptId}`)
                .then(r => r.json())
                .then(data => {
                    // Rebuild tree with filtered data
                    rebuildTree(data.nodes);
                });
        } else {
            // Reset to full tree
            location.reload();
        }
    });
    
    function rebuildTree(nodes) {
        // This would rebuild the tree with filtered nodes
        // For simplicity, we'll just highlight nodes in the selected department
        const deptId = parseInt(document.getElementById('departmentFilter').value);
        
        g.selectAll('.node rect')
            .style('stroke', d => {
                if (!deptId) return '#e5e7eb';
                return d.data.department_id === deptId ? '#f43f5e' : '#e5e7eb';
            })
            .style('stroke-width', d => {
                if (!deptId) return '2px';
                return d.data.department_id === deptId ? '3px' : '1px';
            })
            .style('opacity', d => {
                if (!deptId) return 1;
                return d.data.department_id === deptId ? 1 : 0.4;
            });
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
        const newWidth = document.getElementById('orgChart').clientWidth;
        svg.attr('width', newWidth);
    });
</script>
{% endblock %}
