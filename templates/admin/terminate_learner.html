{% extends 'base/app_layout.html' %}
{% load static %}

{% block page_title %}Terminate Learner{% endblock %}

{% block main_content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Page Header -->
    <div>
        <nav class="flex items-center text-sm text-gray-500 mb-2">
            <a href="{% url 'admin:dashboard' %}" class="hover:text-primary-600">Admin</a>
            <svg class="w-4 h-4 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <a href="{% url 'admin:contract_list' %}" class="hover:text-primary-600">Contracts</a>
            <svg class="w-4 h-4 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <a href="{% url 'admin:contract_detail' pk=contract.pk %}" class="hover:text-primary-600">{{ contract.contract_number }}</a>
            <svg class="w-4 h-4 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span class="text-gray-700">Terminate Learner</span>
        </nav>
        <h1 class="text-2xl font-bold text-gray-900">Terminate Learner</h1>
    </div>
    
    <!-- Warning Banner if Exceeding Limit -->
    {% if will_exceed_limit %}
    <div class="bg-red-50 border border-red-200 rounded-xl p-4">
        <div class="flex">
            <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <h3 class="text-red-800 font-medium">Dropout Limit Warning</h3>
                <p class="text-red-700 text-sm mt-1">
                    Terminating this learner will bring the dropout rate to <strong>{{ projected_dropout_percentage }}%</strong>, 
                    which exceeds the maximum allowed limit of <strong>{{ contract.max_dropout_percentage }}%</strong>.
                </p>
                <p class="text-red-700 text-sm mt-2">
                    You can still proceed, but consider adding a replacement learner to maintain compliance.
                </p>
            </div>
        </div>
    </div>
    {% elif projected_dropout_percentage >= contract.dropout_alert_threshold|floatformat:1|add:0 %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
        <div class="flex">
            <svg class="w-6 h-6 text-amber-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <h3 class="text-amber-800 font-medium">Approaching Dropout Limit</h3>
                <p class="text-amber-700 text-sm mt-1">
                    Terminating this learner will bring the dropout rate to <strong>{{ projected_dropout_percentage }}%</strong>, 
                    which is approaching the maximum limit of <strong>{{ contract.max_dropout_percentage }}%</strong>.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Learner Info Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Learner Information</h2>
        </div>
        <div class="p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                    <span class="text-primary-600 font-bold text-lg">
                        {{ learner.first_name|slice:":1" }}{{ learner.surname|slice:":1" }}
                    </span>
                </div>
                <div class="ml-4">
                    <p class="text-lg font-semibold text-gray-900">{{ learner.surname }}, {{ learner.first_name }}</p>
                    <p class="text-sm text-gray-500">{{ learner.sa_id_number|default:learner.passport_number|default:"No ID" }}</p>
                </div>
            </div>
            <dl class="mt-4 grid grid-cols-2 gap-4 text-sm">
                <div>
                    <dt class="text-gray-500">Contract</dt>
                    <dd class="font-medium text-gray-900">{{ contract.contract_number }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Enrolled</dt>
                    <dd class="font-medium text-gray-900">{{ enrollment.enrollment_date|date:"d M Y" }}</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Days Enrolled</dt>
                    <dd class="font-medium text-gray-900">{{ enrollment.days_enrolled }} days</dd>
                </div>
                <div>
                    <dt class="text-gray-500">Enrollment Type</dt>
                    <dd class="font-medium text-gray-900">
                        {% if enrollment.is_replacement %}Replacement{% else %}Original{% endif %}
                    </dd>
                </div>
            </dl>
        </div>
    </div>
    
    <!-- Termination Form -->
    <form method="post" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {% csrf_token %}
        <div class="px-6 py-4 border-b border-gray-100 bg-red-50">
            <h2 class="text-lg font-semibold text-red-800">Termination Details</h2>
            <p class="text-sm text-red-600 mt-0.5">This action will remove the learner from the contract and update their enrollment status to Withdrawn.</p>
        </div>
        <div class="p-6 space-y-6">
            <!-- Termination Date -->
            <div>
                <label for="termination_date" class="block text-sm font-medium text-gray-700 mb-1">
                    Termination Date <span class="text-red-500">*</span>
                </label>
                <input type="date" name="termination_date" id="termination_date" required
                       value="{% now 'Y-m-d' %}"
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
            
            <!-- Termination Reason -->
            <div>
                <label for="termination_reason" class="block text-sm font-medium text-gray-700 mb-1">
                    Reason for Termination <span class="text-red-500">*</span>
                </label>
                <select name="termination_reason" id="termination_reason" required
                        class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Select a reason...</option>
                    {% for value, display in termination_reasons %}
                    <option value="{{ value }}">{{ display }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Details -->
            <div>
                <label for="termination_details" class="block text-sm font-medium text-gray-700 mb-1">
                    Additional Details
                </label>
                <textarea name="termination_details" id="termination_details" rows="4"
                          placeholder="Provide any additional context about the termination..."
                          class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
            <a href="{% url 'admin:contract_detail' pk=contract.pk %}" 
               class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Cancel
            </a>
            <button type="submit" 
                    class="inline-flex items-center px-6 py-2.5 bg-red-600 text-white text-sm font-medium rounded-xl hover:bg-red-700 transition shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
                Terminate Learner
            </button>
        </div>
    </form>
    
    <!-- Current Dropout Stats -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Current Contract Status</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 rounded-lg p-3">
                    <p class="text-2xl font-bold text-blue-600">{{ contract.original_learner_count|default:contract.original_learners }}</p>
                    <p class="text-xs text-blue-600">Original</p>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                    <p class="text-2xl font-bold text-green-600">{{ contract.active_learners }}</p>
                    <p class="text-xs text-green-600">Active</p>
                </div>
                <div class="bg-red-50 rounded-lg p-3">
                    <p class="text-2xl font-bold text-red-600">{{ contract.terminated_learners }}</p>
                    <p class="text-xs text-red-600">Terminated</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                    <p class="text-2xl font-bold 
                        {% if contract.is_dropout_exceeded %}text-red-600{% elif contract.is_dropout_warning %}text-amber-600{% else %}text-purple-600{% endif %}">
                        {{ contract.dropout_percentage }}%
                    </p>
                    <p class="text-xs 
                        {% if contract.is_dropout_exceeded %}text-red-600{% elif contract.is_dropout_warning %}text-amber-600{% else %}text-purple-600{% endif %}">
                        Dropout Rate
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
