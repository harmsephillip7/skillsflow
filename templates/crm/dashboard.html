{% extends 'crm/crm_base.html' %}
{% load static %}

{% block title %}CRM Dashboard - SkillsFlow{% endblock %}

{% block page_title %}CRM Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <span class="text-gray-700 font-medium">CRM</span>
</li>
{% endblock %}

{% block page_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'crm:lead_create' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add Lead
    </a>
</div>
{% endblock page_actions %}

{% block crm_content %}
<div class="space-y-6">
    
    <!-- Pipeline Stats Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold">Sales Pipeline</h2>
                <p class="mt-1 text-indigo-100">Track leads from inquiry to enrollment</p>
            </div>
            <div class="text-right">
                <p class="text-4xl font-bold">{{ total_leads }}</p>
                <p class="text-sm text-indigo-100">Total Leads</p>
            </div>
        </div>
    </div>
    
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-blue-100">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Active Leads</p>
                    <p class="text-2xl font-bold text-gray-900">{{ active_leads }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-green-100">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">New This Month</p>
                    <p class="text-2xl font-bold text-gray-900">{{ new_this_month }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-purple-100">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Converted MTD</p>
                    <p class="text-2xl font-bold text-gray-900">{{ converted_this_month }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-yellow-100">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Conversion Rate</p>
                    <p class="text-2xl font-bold text-gray-900">{{ conversion_rate }}%</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-red-100">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Follow-ups Due</p>
                    <p class="text-2xl font-bold text-gray-900">{{ follow_ups_due_today }}</p>
                    {% if follow_ups_overdue > 0 %}
                    <p class="text-xs text-red-600">+{{ follow_ups_overdue }} overdue</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Today's Follow-ups Widget -->
    {% if todays_followups or overdue_followups %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="text-lg font-semibold text-white">Follow-ups</h3>
                </div>
                <div class="flex items-center space-x-4">
                    {% if todays_followups %}
                    <span class="px-3 py-1 bg-white/20 rounded-full text-sm text-white">
                        {{ todays_followups|length }} Today
                    </span>
                    {% endif %}
                    {% if overdue_followups %}
                    <span class="px-3 py-1 bg-red-600 rounded-full text-sm text-white">
                        {{ overdue_followups|length }} Overdue
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="divide-y divide-gray-100">
            <!-- Overdue Follow-ups -->
            {% for lead in overdue_followups %}
            <div class="px-6 py-4 hover:bg-red-50 transition-colors flex items-center justify-between" data-lead-id="{{ lead.pk }}">
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-semibold">
                        {{ lead.first_name|slice:":1" }}{{ lead.last_name|slice:":1" }}
                    </div>
                    <div>
                        <a href="{% url 'crm:lead_detail' lead.pk %}" class="text-sm font-medium text-gray-900 hover:text-primary-600">
                            {{ lead.first_name }} {{ lead.last_name }}
                        </a>
                        <p class="text-xs text-red-600 font-medium">
                            Overdue: {{ lead.next_follow_up|date:"d M" }} at {{ lead.next_follow_up|time:"H:i" }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Call Button -->
                    <a href="tel:{{ lead.phone }}" 
                       class="p-2 rounded-lg bg-green-100 text-green-600 hover:bg-green-200 transition-colors"
                       title="Call {{ lead.phone }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </a>
                    
                    <!-- WhatsApp Button -->
                    {% if lead.whatsapp_number or lead.phone %}
                    <a href="https://wa.me/{{ lead.whatsapp_number|default:lead.phone|cut:' '|cut:'-'|cut:'(' |cut:')' }}" 
                       target="_blank"
                       class="p-2 rounded-lg bg-green-100 text-green-600 hover:bg-green-200 transition-colors"
                       title="WhatsApp">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </a>
                    {% endif %}
                    
                    <!-- Mark Complete Button -->
                    <button onclick="completeFollowUp({{ lead.pk }})" 
                            class="p-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors"
                            title="Mark as contacted">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
            
            <!-- Today's Follow-ups -->
            {% for lead in todays_followups %}
            <div class="px-6 py-4 hover:bg-amber-50 transition-colors flex items-center justify-between" data-lead-id="{{ lead.pk }}">
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 font-semibold">
                        {{ lead.first_name|slice:":1" }}{{ lead.last_name|slice:":1" }}
                    </div>
                    <div>
                        <a href="{% url 'crm:lead_detail' lead.pk %}" class="text-sm font-medium text-gray-900 hover:text-primary-600">
                            {{ lead.first_name }} {{ lead.last_name }}
                        </a>
                        <p class="text-xs text-amber-600 font-medium">
                            Today at {{ lead.next_follow_up|time:"H:i" }}
                            {% if lead.follow_up_notes %}<span class="text-gray-500">- {{ lead.follow_up_notes|truncatewords:5 }}</span>{% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Call Button -->
                    <a href="tel:{{ lead.phone }}" 
                       class="p-2 rounded-lg bg-green-100 text-green-600 hover:bg-green-200 transition-colors"
                       title="Call {{ lead.phone }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </a>
                    
                    <!-- WhatsApp Button -->
                    {% if lead.whatsapp_number or lead.phone %}
                    <a href="https://wa.me/{{ lead.whatsapp_number|default:lead.phone|cut:' '|cut:'-'|cut:'(' |cut:')' }}" 
                       target="_blank"
                       class="p-2 rounded-lg bg-green-100 text-green-600 hover:bg-green-200 transition-colors"
                       title="WhatsApp">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </a>
                    {% endif %}
                    
                    <!-- Mark Complete Button -->
                    <button onclick="completeFollowUp({{ lead.pk }})" 
                            class="p-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors"
                            title="Mark as contacted">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if follow_ups_due_today > 10 or follow_ups_overdue > 10 %}
        <div class="px-6 py-3 bg-gray-50 border-t">
            <a href="{% url 'crm:lead_list' %}?filter=follow_up_today" class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                View all follow-ups â†’
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Pipeline Funnel -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Pipeline Overview</h3>
        <div class="grid grid-cols-8 gap-2">
            <a href="{% url 'crm:lead_list' %}?status=NEW" class="text-center p-4 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors">
                <p class="text-2xl font-bold text-blue-600">{{ pipeline_stats.new }}</p>
                <p class="text-xs text-blue-800 mt-1">New</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=CONTACTED" class="text-center p-4 rounded-lg bg-cyan-50 hover:bg-cyan-100 transition-colors">
                <p class="text-2xl font-bold text-cyan-600">{{ pipeline_stats.contacted }}</p>
                <p class="text-xs text-cyan-800 mt-1">Contacted</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=QUALIFIED" class="text-center p-4 rounded-lg bg-teal-50 hover:bg-teal-100 transition-colors">
                <p class="text-2xl font-bold text-teal-600">{{ pipeline_stats.qualified }}</p>
                <p class="text-xs text-teal-800 mt-1">Qualified</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=PROPOSAL" class="text-center p-4 rounded-lg bg-indigo-50 hover:bg-indigo-100 transition-colors">
                <p class="text-2xl font-bold text-indigo-600">{{ pipeline_stats.proposal }}</p>
                <p class="text-xs text-indigo-800 mt-1">Proposal</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=NEGOTIATION" class="text-center p-4 rounded-lg bg-purple-50 hover:bg-purple-100 transition-colors">
                <p class="text-2xl font-bold text-purple-600">{{ pipeline_stats.negotiation }}</p>
                <p class="text-xs text-purple-800 mt-1">Negotiation</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=REGISTERED" class="text-center p-4 rounded-lg bg-yellow-50 hover:bg-yellow-100 transition-colors">
                <p class="text-2xl font-bold text-yellow-600">{{ pipeline_stats.registered }}</p>
                <p class="text-xs text-yellow-800 mt-1">Registered</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=ENROLLED" class="text-center p-4 rounded-lg bg-green-50 hover:bg-green-100 transition-colors">
                <p class="text-2xl font-bold text-green-600">{{ pipeline_stats.enrolled }}</p>
                <p class="text-xs text-green-800 mt-1">Enrolled</p>
            </a>
            <a href="{% url 'crm:lead_list' %}?status=LOST" class="text-center p-4 rounded-lg bg-red-50 hover:bg-red-100 transition-colors">
                <p class="text-2xl font-bold text-red-600">{{ pipeline_stats.lost }}</p>
                <p class="text-xs text-red-800 mt-1">Lost</p>
            </a>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- School Leaver Stats -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">School Leavers</h3>
                <a href="{% url 'crm:lead_list' %}?filter=school_leavers" class="text-sm text-primary-600 hover:text-primary-700">View All â†’</a>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg">
                    <p class="text-3xl font-bold text-indigo-600">{{ school_leaver_stats.total }}</p>
                    <p class="text-sm text-gray-600 mt-1">Total School Leavers</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg">
                    <p class="text-3xl font-bold text-orange-600">{{ school_leaver_stats.under_18 }}</p>
                    <p class="text-sm text-gray-600 mt-1">Under 18 (Minors)</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg">
                    <p class="text-3xl font-bold text-emerald-600">{{ school_leaver_stats.ready_to_enroll }}</p>
                    <p class="text-sm text-gray-600 mt-1">Ready to Enroll (18+)</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg">
                    <p class="text-3xl font-bold text-purple-600">{{ school_leaver_stats.with_consent }}</p>
                    <p class="text-sm text-gray-600 mt-1">With Messaging Consent</p>
                </div>
            </div>
            
            {% if turning_18_soon %}
            <div class="mt-4 border-t pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">ðŸŽ‚ Turning 18 Soon</h4>
                <div class="space-y-2">
                    {% for lead in turning_18_soon %}
                    <a href="{% url 'crm:lead_detail' lead.pk %}" class="block p-2 rounded hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-900">{{ lead.first_name }} {{ lead.last_name }}</span>
                            <span class="text-xs text-gray-500">{{ lead.date_of_birth|date:"d M Y" }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Leads by Source -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Leads by Source</h3>
                <a href="{% url 'crm:crm_settings' %}" class="text-sm text-primary-600 hover:text-primary-700">Manage Sources â†’</a>
            </div>
            <div class="space-y-3">
                {% for source in leads_by_source %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-700">{{ source.source__name }}</span>
                    <div class="flex items-center">
                        <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-primary-600 h-2 rounded-full" style="width: {% widthratio source.count total_leads 100 %}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-900 w-8 text-right">{{ source.count }}</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4">No lead sources yet</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Recent Activities -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Recent Activities</h3>
            <a href="{% url 'crm:lead_list' %}" class="text-sm text-primary-600 hover:text-primary-700">View All Leads â†’</a>
        </div>
        <div class="space-y-3">
            {% for activity in recent_activities %}
            <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <div class="flex-shrink-0">
                    {% if activity.activity_type == 'CALL' %}
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </div>
                    {% elif activity.activity_type == 'EMAIL' %}
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    {% elif activity.activity_type == 'WHATSAPP' %}
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                        </svg>
                    </div>
                    {% elif activity.activity_type == 'STATUS_CHANGE' %}
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                    {% else %}
                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <a href="{% url 'crm:lead_detail' activity.lead.pk %}" class="text-sm font-medium text-gray-900 hover:text-primary-600">
                            {{ activity.lead.first_name }} {{ activity.lead.last_name }}
                        </a>
                        <span class="text-xs text-gray-500">{{ activity.created_at|timesince }} ago</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate">{{ activity.description }}</p>
                    {% if activity.created_by %}
                    <p class="text-xs text-gray-400 mt-0.5">by {{ activity.created_by.get_full_name|default:activity.created_by.email }}</p>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-sm text-gray-500 text-center py-8">No recent activities</p>
            {% endfor %}
        </div>
    </div>
    
</div>

<!-- Follow-up Quick Actions JavaScript -->
<script>
async function completeFollowUp(leadId) {
    // Show a quick modal or prompt for notes
    const notes = prompt('Add a note about this follow-up (optional):');
    
    try {
        // Add activity
        const formData = new FormData();
        formData.append('activity_type', 'CALL');
        formData.append('description', notes || 'Follow-up completed');
        
        const response = await fetch(`/crm/leads/${leadId}/activity/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        if (response.ok) {
            // Remove the row from the widget
            const row = document.querySelector(`[data-lead-id="${leadId}"]`);
            if (row) {
                row.style.transition = 'all 0.3s';
                row.style.opacity = '0';
                row.style.transform = 'translateX(100%)';
                setTimeout(() => row.remove(), 300);
            }
            showToast('Follow-up marked as complete', 'success');
        } else {
            showToast('Failed to update follow-up', 'error');
        }
    } catch (error) {
        showToast('An error occurred', 'error');
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
