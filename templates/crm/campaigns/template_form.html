{% extends 'crm/crm_base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Template{% else %}New Template{% endif %} - CRM - SkillsFlow{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Template{% else %}Create Message Template{% endif %}{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{% url 'crm:dashboard' %}" class="text-gray-500 hover:text-gray-700">CRM</a>
</li>
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{% url 'crm:template_list' %}" class="text-gray-500 hover:text-gray-700">Templates</a>
</li>
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <span class="text-gray-700 font-medium">{% if form.instance.pk %}Edit{% else %}New{% endif %}</span>
</li>
{% endblock %}

{% block crm_content %}
<div class="max-w-4xl mx-auto">
    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="font-semibold text-gray-900">Template Information</h3>
                <p class="text-sm text-gray-500 mt-0.5">Basic details about this message template</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Name and Slug -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Template Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Slug (URL-friendly name) <span class="text-red-500">*</span>
                        </label>
                        {{ form.slug }}
                        {% if form.slug.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.slug.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-xs text-gray-500">Unique identifier for this template</p>
                    </div>
                </div>
                
                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ form.description }}
                </div>
                
                <!-- Channel and Category -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Channel <span class="text-red-500">*</span>
                        </label>
                        {{ form.channel_type }}
                        {% if form.channel_type.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.channel_type.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Category <span class="text-red-500">*</span>
                        </label>
                        {{ form.category }}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Campus</label>
                        {{ form.campus }}
                        <p class="mt-1 text-xs text-gray-500">Leave empty for all campuses</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Message Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <h3 class="font-semibold text-gray-900">Message Content</h3>
                <p class="text-sm text-gray-500 mt-0.5">The actual message content with optional placeholders</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Email Subject (conditional) -->
                <div id="email-subject-field">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Email Subject
                    </label>
                    {{ form.email_subject }}
                    <p class="mt-1 text-xs text-gray-500">Required for email templates</p>
                </div>
                
                <!-- Header (WhatsApp) -->
                <div id="header-fields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Header Type</label>
                        {{ form.header_type }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Header Content</label>
                        {{ form.header_content }}
                        <p class="mt-1 text-xs text-gray-500">Optional header for WhatsApp templates</p>
                    </div>
                </div>
                
                <!-- Body -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Message Body <span class="text-red-500">*</span>
                    </label>
                    {{ form.body }}
                    {% if form.body.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.body.errors.0 }}</p>
                    {% endif %}
                    <p class="mt-1 text-xs text-gray-500">
                        Use placeholders like <code class="bg-gray-100 px-1 rounded">{% verbatim %}{{first_name}}{% endverbatim %}</code>, 
                        <code class="bg-gray-100 px-1 rounded">{% verbatim %}{{programme_name}}{% endverbatim %}</code> for personalization
                    </p>
                </div>
                
                <!-- Footer -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Footer</label>
                    {{ form.footer }}
                    <p class="mt-1 text-xs text-gray-500">Optional footer text</p>
                </div>
                
                <!-- Variables -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Variables (JSON)</label>
                    {{ form.variables }}
                    <p class="mt-1 text-xs text-gray-500">
                        Define variables as a JSON array: <code class="bg-gray-100 px-1 rounded">["first_name", "programme_name"]</code>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Available Variables Help -->
        <div class="bg-blue-50 rounded-xl border border-blue-100 p-4">
            <div class="flex">
                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="ml-3">
                    <h4 class="text-sm font-medium text-blue-800">Available Placeholders</h4>
                    <div class="mt-2 text-sm text-blue-700 space-x-2 flex flex-wrap gap-2">
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{first_name}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{last_name}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{full_name}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{email}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{phone}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{programme_name}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{campus_name}}{% endverbatim %}</code>
                        <code class="bg-blue-100 px-2 py-0.5 rounded">{% verbatim %}{{intake_date}}{% endverbatim %}</code>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Preview Panel -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" x-data="{ showPreview: false }">
            <button type="button" @click="showPreview = !showPreview" 
                    class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    <span class="font-medium text-gray-900">Preview Template</span>
                </div>
                <svg :class="showPreview ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            
            <div x-show="showPreview" x-collapse class="px-6 pb-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="max-w-sm mx-auto">
                        <!-- Phone mockup -->
                        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-gray-800">
                            <div class="bg-gray-800 text-white px-4 py-2 text-center text-sm">Preview</div>
                            <div class="p-4 min-h-[200px] bg-emerald-50">
                                <div class="bg-white rounded-lg p-3 shadow-sm">
                                    <p class="text-sm text-gray-700" id="preview-content">
                                        Hi John! Welcome to SkillsFlow. We're excited to have you join our Business Management programme.
                                    </p>
                                    <p class="text-xs text-gray-400 text-right mt-2">Now</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-4">
            <a href="{% url 'crm:template_list' %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Cancel
            </a>
            
            <button type="submit" 
                    class="inline-flex items-center px-6 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                {% if form.instance.pk %}Update Template{% else %}Create Template{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
// Show/hide channel-specific fields
document.addEventListener('DOMContentLoaded', function() {
    const channelSelect = document.querySelector('[name="channel_type"]');
    const emailSubjectField = document.getElementById('email-subject-field');
    const headerFields = document.getElementById('header-fields');
    
    function updateFieldsVisibility() {
        const channel = channelSelect.value;
        
        // Email subject only for email
        if (emailSubjectField) {
            emailSubjectField.style.display = channel === 'email' ? 'block' : 'none';
        }
        
        // Header fields only for WhatsApp
        if (headerFields) {
            headerFields.style.display = channel === 'whatsapp' ? 'block' : 'none';
        }
    }
    
    if (channelSelect) {
        channelSelect.addEventListener('change', updateFieldsVisibility);
        updateFieldsVisibility();
    }
});
</script>
{% endblock %}
