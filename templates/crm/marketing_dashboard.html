{% extends 'crm/crm_base.html' %}
{% load static %}

{% block title %}Marketing Analytics - {{ brand.name }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block crm_content %}
<div class="px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Marketing Analytics</h1>
                <p class="mt-1 text-sm text-gray-500">Social media and website performance for {{ brand.name }}</p>
            </div>
            
            <!-- Brand Selector & Date Range -->
            <div class="flex flex-wrap items-center gap-3">
                {% if available_brands|length > 1 %}
                <select id="brand-selector" onchange="changeBrand(this.value)" 
                        class="rounded-lg border-gray-300 text-sm focus:ring-primary-500 focus:border-primary-500">
                    {% for b in available_brands %}
                    <option value="{{ b.id }}" {% if b.id == brand.id %}selected{% endif %}>{{ b.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                
                <div class="flex items-center bg-white border border-gray-300 rounded-lg overflow-hidden">
                    <a href="?brand={{ brand.id }}&range=7d" 
                       class="px-3 py-2 text-sm {% if range_type == '7d' %}bg-primary-100 text-primary-700 font-medium{% else %}text-gray-600 hover:bg-gray-50{% endif %}">7D</a>
                    <a href="?brand={{ brand.id }}&range=30d" 
                       class="px-3 py-2 text-sm border-l border-gray-300 {% if range_type == '30d' %}bg-primary-100 text-primary-700 font-medium{% else %}text-gray-600 hover:bg-gray-50{% endif %}">30D</a>
                    <a href="?brand={{ brand.id }}&range=90d" 
                       class="px-3 py-2 text-sm border-l border-gray-300 {% if range_type == '90d' %}bg-primary-100 text-primary-700 font-medium{% else %}text-gray-600 hover:bg-gray-50{% endif %}">90D</a>
                    <a href="?brand={{ brand.id }}&range=ytd" 
                       class="px-3 py-2 text-sm border-l border-gray-300 {% if range_type == 'ytd' %}bg-primary-100 text-primary-700 font-medium{% else %}text-gray-600 hover:bg-gray-50{% endif %}">YTD</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connected Accounts Status -->
    <div class="mb-6 bg-white rounded-xl border border-gray-200 p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Connected Platforms</h3>
        <div class="flex flex-wrap gap-4">
            {% for account in social_accounts %}
            <div class="flex items-center gap-2 px-3 py-2 rounded-lg {% if account.is_active %}bg-green-50 border border-green-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                {% if account.platform == 'META' %}
                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/></svg>
                {% elif account.platform == 'TIKTOK' %}
                <svg class="w-5 h-5 text-gray-900" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/></svg>
                {% elif account.platform == 'GOOGLE_ANALYTICS' %}
                <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M22.84 2.998v17.998a3.003 3.003 0 01-3 3.002H4.159a3.003 3.003 0 01-3-3.002V2.998a3.003 3.003 0 013-3h15.681a3.003 3.003 0 013 3zm-4.5 16.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm-12-9a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg>
                {% endif %}
                <span class="text-sm font-medium {% if account.is_active %}text-green-800{% else %}text-gray-600{% endif %}">
                    {{ account.get_platform_display }}
                </span>
                {% if account.is_active %}
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                {% else %}
                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                {% endif %}
            </div>
            {% empty %}
            <div class="text-sm text-gray-500">
                No platforms connected. 
                <a href="{% url 'tenants:brand_integrations' brand.id %}" class="text-primary-600 hover:underline">Connect now →</a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Overview Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Followers -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Followers</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ social_metrics.total_followers|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center text-sm {% if comparison.followers_change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if comparison.followers_change >= 0 %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                {% else %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                {% endif %}
                {{ comparison.followers_change|floatformat:1 }}% vs prev period
            </div>
        </div>
        
        <!-- Total Reach -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Reach</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ social_metrics.total_reach|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center text-sm {% if comparison.reach_change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if comparison.reach_change >= 0 %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                {% else %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                {% endif %}
                {{ comparison.reach_change|floatformat:1 }}% vs prev period
            </div>
        </div>
        
        <!-- Total Engagement -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Total Engagement</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ social_metrics.total_engagement|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center text-sm {% if comparison.engagement_change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if comparison.engagement_change >= 0 %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                {% else %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                {% endif %}
                {{ comparison.engagement_change|floatformat:1 }}% vs prev period
            </div>
        </div>
        
        <!-- Website Sessions -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Website Sessions</p>
                    <p class="mt-1 text-2xl font-bold text-gray-900">{{ web_metrics.total_sessions|default:0|floatformat:0 }}</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center text-sm {% if comparison.sessions_change >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if comparison.sessions_change >= 0 %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                {% else %}
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                {% endif %}
                {{ comparison.sessions_change|floatformat:1 }}% vs prev period
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Social Media Trend Chart -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Social Media Reach</h3>
                <a href="{% url 'crm:social_analytics' %}?brand={{ brand.id }}&range={{ range_type }}" 
                   class="text-sm text-primary-600 hover:underline">View Details →</a>
            </div>
            <div class="h-64">
                <canvas id="socialTrendChart"></canvas>
            </div>
        </div>
        
        <!-- Web Traffic Trend Chart -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Website Traffic</h3>
                <a href="{% url 'crm:web_analytics' %}?brand={{ brand.id }}&range={{ range_type }}" 
                   class="text-sm text-primary-600 hover:underline">View Details →</a>
            </div>
            <div class="h-64">
                <canvas id="webTrendChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Secondary Charts & Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Engagement Breakdown -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Engagement Breakdown</h3>
            <div class="h-48">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>
        
        <!-- Platform Followers -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Followers by Platform</h3>
            <div class="space-y-4">
                {% for platform, count in social_metrics.followers_by_platform.items %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        {% if platform == 'facebook' %}
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/></svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Facebook</span>
                        {% elif platform == 'instagram' %}
                        <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153a4.908 4.908 0 011.153 1.772c.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122 0 2.717-.01 3.056-.06 4.122-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772 4.915 4.915 0 01-1.772 1.153c-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06-2.717 0-3.056-.01-4.122-.06-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12c0-2.717.01-3.056.06-4.122.05-1.066.217-1.79.465-2.428a4.88 4.88 0 011.153-1.772A4.897 4.897 0 015.45 2.525c.638-.248 1.362-.415 2.428-.465C8.944 2.013 9.283 2 12 2z"/></svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Instagram</span>
                        {% elif platform == 'tiktok' %}
                        <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-gray-900" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/></svg>
                        </div>
                        <span class="text-sm font-medium text-gray-700">TikTok</span>
                        {% endif %}
                    </div>
                    <span class="text-sm font-bold text-gray-900">{{ count|floatformat:0 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Web Metrics Summary -->
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Website Metrics</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Total Users</span>
                    <span class="text-sm font-bold text-gray-900">{{ web_metrics.total_users|default:0|floatformat:0 }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">New Users</span>
                    <span class="text-sm font-bold text-gray-900">{{ web_metrics.total_new_users|default:0|floatformat:0 }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Pageviews</span>
                    <span class="text-sm font-bold text-gray-900">{{ web_metrics.total_pageviews|default:0|floatformat:0 }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Avg Bounce Rate</span>
                    <span class="text-sm font-bold text-gray-900">{{ web_metrics.avg_bounce_rate|default:0|floatformat:1 }}%</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Conversions</span>
                    <span class="text-sm font-bold text-green-600">{{ web_metrics.total_conversions|default:0|floatformat:0 }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Performing Content -->
    <div class="bg-white rounded-xl border border-gray-200 p-5">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Top Performing Content</h3>
            <a href="{% url 'crm:content_analytics' %}?brand={{ brand.id }}&range={{ range_type }}" 
               class="text-sm text-primary-600 hover:underline">View All →</a>
        </div>
        
        {% if top_content %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Content</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Reach</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Engagement</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for post in top_content %}
                    <tr>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                {% if post.thumbnail_url %}
                                <img src="{{ post.thumbnail_url }}" alt="" class="w-10 h-10 rounded object-cover">
                                {% else %}
                                <div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                {% endif %}
                                <div class="max-w-xs truncate text-sm text-gray-900">{{ post.caption|truncatechars:50 }}</div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium 
                                {% if post.platform == 'FACEBOOK' %}bg-blue-100 text-blue-800
                                {% elif post.platform == 'INSTAGRAM' %}bg-pink-100 text-pink-800
                                {% elif post.platform == 'TIKTOK' %}bg-gray-100 text-gray-800{% endif %}">
                                {{ post.get_platform_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right text-sm text-gray-900">{{ post.reach|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right text-sm text-gray-900">{{ post.engagement_total|floatformat:0 }}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                                {{ post.engagement_rate|floatformat:2 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <p class="text-sm">No content data available for this period.</p>
            <p class="text-xs text-gray-400 mt-1">Connect your social accounts and sync data to see content performance.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Brand selector
    function changeBrand(brandId) {
        window.location.href = '?brand=' + brandId + '&range={{ range_type }}';
    }
    
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Social Trend Chart
        fetch('{% url "crm:api_social_trend" %}?brand={{ brand.id }}&range={{ range_type }}&metric=reach')
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById('socialTrendChart'), {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
        
        // Web Traffic Chart
        fetch('{% url "crm:api_web_trend" %}?brand={{ brand.id }}&range={{ range_type }}&metric=sessions')
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById('webTrendChart'), {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
        
        // Engagement Breakdown Chart
        fetch('{% url "crm:api_engagement_breakdown" %}?brand={{ brand.id }}&range={{ range_type }}')
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById('engagementChart'), {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            });
    });
</script>
{% endblock %}
