{% extends 'crm/crm_fullscreen_base.html' %}
{% load static %}

{% block title %}{{ source.name }} - Web Form Source{% endblock %}

{% block crm_content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'crm:webform_sources' %}">Web Form Sources</a></li>
                    <li class="breadcrumb-item active">{{ source.name }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">{{ source.name }}</h1>
            <small class="text-muted">{{ source.domain }}</small>
        </div>
        <div>
            <a href="{% url 'crm:webform_source_update' source.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-1"></i>Edit
            </a>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- Webhook Configuration -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-plug me-2"></i>Webhook Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label small text-muted">Webhook URL</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="webhookUrl" 
                                value="{{ request.scheme }}://{{ request.get_host }}{{ source.get_webhook_url }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('webhookUrl')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Use this URL in your Gravity Forms webhook settings</small>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label small text-muted">Webhook Secret</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" id="webhookSecret" 
                                value="{{ source.webhook_secret }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('webhookSecret')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Send this in the <code>X-Webhook-Secret</code> header</small>
                    </div>
                    
                    <form method="post" action="{% url 'crm:webform_source_regenerate_secret' source.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-warning btn-sm" 
                            onclick="return confirm('This will invalidate the current secret. Continue?')">
                            <i class="fas fa-sync-alt me-1"></i>Regenerate Secret
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h2 mb-0 text-primary">{{ source.form_mappings.count }}</div>
                            <small class="text-muted">Forms Mapped</small>
                        </div>
                        <div class="col-4">
                            <div class="h2 mb-0 text-success">{{ source.total_leads_created }}</div>
                            <small class="text-muted">Leads Created</small>
                        </div>
                        <div class="col-4">
                            <div class="h2 mb-0 text-info">{{ source.total_duplicates_updated }}</div>
                            <small class="text-muted">Duplicates Updated</small>
                        </div>
                    </div>
                    {% if source.last_submission_at %}
                    <hr>
                    <p class="mb-0 text-muted small">
                        <i class="fas fa-clock me-1"></i>Last submission: {{ source.last_submission_at|timesince }} ago
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Form Mappings -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-map-signs me-2"></i>Form Mappings</h5>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMappingModal">
                <i class="fas fa-plus me-1"></i>Add Form Mapping
            </button>
        </div>
        <div class="card-body p-0">
            {% if source.form_mappings.all %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Form Name</th>
                            <th>Form ID</th>
                            <th>Campus</th>
                            <th>Lead Type</th>
                            <th>Leads</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in source.form_mappings.all %}
                        <tr>
                            <td>
                                <strong>{{ mapping.form_name }}</strong>
                                {% if mapping.qualification %}
                                <br><small class="text-muted">{{ mapping.qualification.title|truncatechars:40 }}</small>
                                {% endif %}
                            </td>
                            <td><code>{{ mapping.form_id }}</code></td>
                            <td>{{ mapping.campus|default:source.default_campus|default:"Default" }}</td>
                            <td>{{ mapping.get_lead_type_display }}</td>
                            <td>
                                <span class="text-success">+{{ mapping.leads_created }}</span> / 
                                <span class="text-info">↻{{ mapping.duplicates_updated }}</span>
                            </td>
                            <td>
                                <span class="badge {% if mapping.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if mapping.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="editMapping('{{ mapping.id }}', {{ mapping|json_script:mapping.id|safe }})"
                                    data-bs-toggle="modal" data-bs-target="#editMappingModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteMapping('{{ mapping.id }}', '{{ mapping.form_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-map-signs fa-3x text-muted mb-3"></i>
                <h6>No Form Mappings</h6>
                <p class="text-muted mb-3">Add a mapping for each Gravity Form that sends leads.</p>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMappingModal">
                    <i class="fas fa-plus me-1"></i>Add Form Mapping
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Submissions -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Recent Submissions</h5>
            <a href="{% url 'crm:webform_submissions' %}?source={{ source.id }}" class="btn btn-outline-secondary btn-sm">
                View All
            </a>
        </div>
        <div class="card-body p-0">
            {% if recent_submissions %}
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Time</th>
                            <th>Form</th>
                            <th>Status</th>
                            <th>Lead</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in recent_submissions %}
                        <tr>
                            <td><small>{{ sub.created_at|timesince }} ago</small></td>
                            <td>{{ sub.form_mapping.form_name|default:"Unknown" }}</td>
                            <td>
                                <span class="badge 
                                    {% if sub.status == 'SUCCESS' %}bg-success
                                    {% elif sub.status == 'DUPLICATE' %}bg-info
                                    {% elif sub.status == 'FAILED' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ sub.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if sub.lead %}
                                <a href="{% url 'crm:lead_detail' sub.lead.pk %}">{{ sub.lead.get_full_name }}</a>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <small class="text-muted">No submissions yet</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Mapping Modal -->
<div class="modal fade" id="addMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Form Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMappingForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Form ID <span class="text-danger">*</span></label>
                            <input type="text" name="form_id" class="form-control" placeholder="e.g., 1 or contact-form" required>
                            <small class="text-muted">The Gravity Forms form ID</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Form Name <span class="text-danger">*</span></label>
                            <input type="text" name="form_name" class="form-control" placeholder="e.g., Contact Form" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Campus</label>
                            <select name="campus" class="form-select">
                                <option value="">Use Source Default</option>
                                {% for campus in campuses %}
                                <option value="{{ campus.id }}">{{ campus.brand.code }} - {{ campus.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lead Type</label>
                            <select name="lead_type" class="form-select">
                                <option value="ADULT">Adult Learner</option>
                                <option value="SCHOOL_LEAVER">School Leaver</option>
                                <option value="CORPORATE">Corporate/Employer</option>
                                <option value="REFERRAL">Referral</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Qualification Interest</label>
                            <select name="qualification" class="form-select">
                                <option value="">None</option>
                                {% for qual in qualifications %}
                                <option value="{{ qual.id }}">{{ qual.title|truncatechars:50 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Auto-Assign To</label>
                            <select name="auto_assign_to" class="form-select">
                                <option value="">Don't auto-assign</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Pipeline</label>
                        <select name="pipeline" class="form-select">
                            <option value="">Don't assign to pipeline</option>
                            {% for pipeline in pipelines %}
                            <option value="{{ pipeline.id }}">{{ pipeline.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-exchange-alt me-2"></i>Field Mapping</h6>
                    <p class="text-muted small">Map Gravity Forms field IDs to lead fields. Example: <code>1.3</code> → First Name</p>
                    
                    <div id="fieldMappingContainer">
                        <div class="row mb-2 field-mapping-row">
                            <div class="col-5">
                                <input type="text" class="form-control form-control-sm" placeholder="Form Field ID (e.g., 1.3)" name="form_field[]">
                            </div>
                            <div class="col-5">
                                <select class="form-select form-select-sm" name="lead_field[]">
                                    <option value="">Select Lead Field...</option>
                                    {% for value, label in lead_field_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-2">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFieldMapping(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addFieldMapping()">
                        <i class="fas fa-plus me-1"></i>Add Field
                    </button>
                    
                    <div class="form-check mt-3">
                        <input type="checkbox" name="is_active" class="form-check-input" id="addIsActive" checked>
                        <label class="form-check-label" for="addIsActive">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMapping()">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Form Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMappingForm">
                    <input type="hidden" name="mapping_id" id="editMappingId">
                    <!-- Same fields as add form, populated by JS -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Form ID <span class="text-danger">*</span></label>
                            <input type="text" name="form_id" id="editFormId" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Form Name <span class="text-danger">*</span></label>
                            <input type="text" name="form_name" id="editFormName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Campus</label>
                            <select name="campus" id="editCampus" class="form-select">
                                <option value="">Use Source Default</option>
                                {% for campus in campuses %}
                                <option value="{{ campus.id }}">{{ campus.brand.code }} - {{ campus.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lead Type</label>
                            <select name="lead_type" id="editLeadType" class="form-select">
                                <option value="ADULT">Adult Learner</option>
                                <option value="SCHOOL_LEAVER">School Leaver</option>
                                <option value="CORPORATE">Corporate/Employer</option>
                                <option value="REFERRAL">Referral</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Qualification Interest</label>
                            <select name="qualification" id="editQualification" class="form-select">
                                <option value="">None</option>
                                {% for qual in qualifications %}
                                <option value="{{ qual.id }}">{{ qual.title|truncatechars:50 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Auto-Assign To</label>
                            <select name="auto_assign_to" id="editAutoAssign" class="form-select">
                                <option value="">Don't auto-assign</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Pipeline</label>
                        <select name="pipeline" id="editPipeline" class="form-select">
                            <option value="">Don't assign to pipeline</option>
                            {% for pipeline in pipelines %}
                            <option value="{{ pipeline.id }}">{{ pipeline.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-exchange-alt me-2"></i>Field Mapping</h6>
                    <div id="editFieldMappingContainer"></div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addFieldMapping('edit')">
                        <i class="fas fa-plus me-1"></i>Add Field
                    </button>
                    
                    <div class="form-check mt-3">
                        <input type="checkbox" name="is_active" class="form-check-input" id="editIsActive">
                        <label class="form-check-label" for="editIsActive">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMapping()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
const sourceId = '{{ source.id }}';
const csrfToken = '{{ csrf_token }}';
const leadFieldOptions = `
    <option value="">Select Lead Field...</option>
    {% for value, label in lead_field_choices %}
    <option value="{{ value }}">{{ label }}</option>
    {% endfor %}
`;

function copyToClipboard(elementId) {
    const el = document.getElementById(elementId);
    el.select();
    document.execCommand('copy');
    
    // Show feedback
    const btn = el.nextElementSibling;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i>';
    setTimeout(() => btn.innerHTML = originalHtml, 1500);
}

function addFieldMapping(prefix = '') {
    const container = document.getElementById(prefix ? 'editFieldMappingContainer' : 'fieldMappingContainer');
    const row = document.createElement('div');
    row.className = 'row mb-2 field-mapping-row';
    row.innerHTML = `
        <div class="col-5">
            <input type="text" class="form-control form-control-sm" placeholder="Form Field ID" name="form_field[]">
        </div>
        <div class="col-5">
            <select class="form-select form-select-sm" name="lead_field[]">${leadFieldOptions}</select>
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFieldMapping(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(row);
}

function removeFieldMapping(btn) {
    btn.closest('.field-mapping-row').remove();
}

function getFieldMappingFromForm(formId) {
    const form = document.getElementById(formId);
    const formFields = form.querySelectorAll('input[name="form_field[]"]');
    const leadFields = form.querySelectorAll('select[name="lead_field[]"]');
    const mapping = {};
    
    formFields.forEach((input, i) => {
        if (input.value && leadFields[i].value) {
            mapping[input.value] = leadFields[i].value;
        }
    });
    
    return mapping;
}

function saveMapping() {
    const form = document.getElementById('addMappingForm');
    const formData = new FormData(form);
    
    const data = {
        form_id: formData.get('form_id'),
        form_name: formData.get('form_name'),
        campus: formData.get('campus'),
        lead_type: formData.get('lead_type'),
        qualification: formData.get('qualification'),
        auto_assign_to: formData.get('auto_assign_to'),
        pipeline: formData.get('pipeline'),
        is_active: form.querySelector('#addIsActive').checked,
        field_mapping: getFieldMappingFromForm('addMappingForm')
    };
    
    fetch(`/crm/settings/webforms/sources/${sourceId}/mappings/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to save mapping');
        }
    });
}

function editMapping(mappingId, mappingData) {
    // This function is called with the mapping data from a JSON script tag
    // We need to get the actual data from the DOM
    const scriptEl = document.getElementById(mappingId);
    if (scriptEl) {
        mappingData = JSON.parse(scriptEl.textContent);
    }
    
    document.getElementById('editMappingId').value = mappingId;
    document.getElementById('editFormId').value = mappingData.form_id || '';
    document.getElementById('editFormName').value = mappingData.form_name || '';
    document.getElementById('editCampus').value = mappingData.campus_id || '';
    document.getElementById('editLeadType').value = mappingData.lead_type || 'ADULT';
    document.getElementById('editQualification').value = mappingData.qualification_id || '';
    document.getElementById('editAutoAssign').value = mappingData.auto_assign_to_id || '';
    document.getElementById('editPipeline').value = mappingData.pipeline_id || '';
    document.getElementById('editIsActive').checked = mappingData.is_active;
    
    // Populate field mappings
    const container = document.getElementById('editFieldMappingContainer');
    container.innerHTML = '';
    
    const fieldMapping = mappingData.field_mapping || {};
    Object.entries(fieldMapping).forEach(([formField, leadField]) => {
        const row = document.createElement('div');
        row.className = 'row mb-2 field-mapping-row';
        row.innerHTML = `
            <div class="col-5">
                <input type="text" class="form-control form-control-sm" value="${formField}" name="form_field[]">
            </div>
            <div class="col-5">
                <select class="form-select form-select-sm" name="lead_field[]">${leadFieldOptions}</select>
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFieldMapping(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(row);
        row.querySelector('select').value = leadField;
    });
    
    // Add empty row if no mappings
    if (Object.keys(fieldMapping).length === 0) {
        addFieldMapping('edit');
    }
}

function updateMapping() {
    const mappingId = document.getElementById('editMappingId').value;
    const form = document.getElementById('editMappingForm');
    
    const data = {
        form_id: document.getElementById('editFormId').value,
        form_name: document.getElementById('editFormName').value,
        campus: document.getElementById('editCampus').value,
        lead_type: document.getElementById('editLeadType').value,
        qualification: document.getElementById('editQualification').value,
        auto_assign_to: document.getElementById('editAutoAssign').value,
        pipeline: document.getElementById('editPipeline').value,
        is_active: document.getElementById('editIsActive').checked,
        field_mapping: getFieldMappingFromForm('editMappingForm')
    };
    
    fetch(`/crm/settings/webforms/mappings/${mappingId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to update mapping');
        }
    });
}

function deleteMapping(mappingId, mappingName) {
    if (!confirm(`Delete form mapping "${mappingName}"?`)) return;
    
    fetch(`/crm/settings/webforms/mappings/${mappingId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to delete mapping');
        }
    });
}
</script>

<!-- JSON data for mappings -->
{% for mapping in source.form_mappings.all %}
<script type="application/json" id="{{ mapping.id }}">
{
    "form_id": "{{ mapping.form_id }}",
    "form_name": "{{ mapping.form_name }}",
    "campus_id": "{{ mapping.campus_id|default:'' }}",
    "lead_type": "{{ mapping.lead_type }}",
    "qualification_id": "{{ mapping.qualification_id|default:'' }}",
    "auto_assign_to_id": "{{ mapping.auto_assign_to_id|default:'' }}",
    "pipeline_id": "{{ mapping.pipeline_id|default:'' }}",
    "is_active": {{ mapping.is_active|yesno:"true,false" }},
    "field_mapping": {{ mapping.field_mapping|safe }}
}
</script>
{% endfor %}
{% endblock %}
