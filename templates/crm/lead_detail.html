{% extends 'crm/crm_base.html' %}
{% load static %}

{% block title %}{{ lead.get_full_name }} - CRM - SkillsFlow{% endblock %}

{% block page_title %}{{ lead.get_full_name }}{% endblock %}

{% block breadcrumbs %}
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{% url 'crm:dashboard' %}" class="text-gray-500 hover:text-gray-700">CRM</a>
</li>
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <a href="{% url 'crm:lead_list' %}" class="text-gray-500 hover:text-gray-700">Leads</a>
</li>
<li class="flex items-center">
    <svg class="w-5 h-5 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    <span class="text-gray-700 font-medium">{{ lead.get_full_name }}</span>
</li>
{% endblock %}

{% block page_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'crm:quote_create_for_lead' lead.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Create Quote
    </a>
    <button onclick="openQuickEditModal()" class="inline-flex items-center px-4 py-2 border border-primary-300 shadow-sm text-sm font-medium rounded-md text-primary-700 bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        Quick Edit
    </button>
    <a href="{% url 'crm:lead_update' lead.pk %}" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-500 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200" title="Full Edit Page">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
    </a>
</div>
{% endblock %}

{% block crm_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- Main Content - Left Column -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- Lead Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-16 w-16">
                            <div class="h-16 w-16 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white text-xl font-semibold">
                                {{ lead.first_name|slice:":1" }}{{ lead.last_name|slice:":1" }}
                            </div>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-xl font-bold text-gray-900">{{ lead.get_full_name }}</h2>
                            <div class="flex items-center mt-1 space-x-2">
                                <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if lead.lead_type == 'SCHOOL_LEAVER' %}bg-blue-100 text-blue-800
                                    {% elif lead.lead_type == 'ADULT' %}bg-green-100 text-green-800
                                    {% elif lead.lead_type == 'CORPORATE' %}bg-purple-100 text-purple-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ lead.get_lead_type_display }}
                                </span>
                                <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if lead.priority == 'URGENT' %}bg-red-100 text-red-800
                                    {% elif lead.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                    {% elif lead.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ lead.get_priority_display }} Priority
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Badge -->
                    <span class="px-3 py-1.5 inline-flex text-sm leading-5 font-semibold rounded-lg 
                        {% if lead.status == 'NEW' %}bg-blue-100 text-blue-800
                        {% elif lead.status == 'CONTACTED' %}bg-cyan-100 text-cyan-800
                        {% elif lead.status == 'QUALIFIED' %}bg-teal-100 text-teal-800
                        {% elif lead.status == 'PROPOSAL' %}bg-indigo-100 text-indigo-800
                        {% elif lead.status == 'NEGOTIATION' %}bg-purple-100 text-purple-800
                        {% elif lead.status == 'REGISTERED' %}bg-yellow-100 text-yellow-800
                        {% elif lead.status == 'ENROLLED' %}bg-green-100 text-green-800
                        {% elif lead.status == 'LOST' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ lead.get_status_display }}
                    </span>
                </div>
                
                <!-- Contact Info -->
                <div class="mt-6 grid grid-cols-1 gap-3">
                    <!-- Phone (SMS) -->
                    <div class="flex items-center justify-between text-sm p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            <a href="tel:{{ lead.phone }}" class="text-gray-900 hover:text-primary-600">{{ lead.phone }}</a>
                        </div>
                        <button type="button" 
                                onclick="openDocumentRequestModalForContact('learner', 'whatsapp', '{{ lead.whatsapp_number|default:lead.phone }}')"
                                class="ml-2 px-2 py-1 text-xs font-medium text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-md flex items-center"
                                title="Send document upload link via WhatsApp">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            ðŸ“„
                        </button>
                    </div>
                    
                    <!-- Email -->
                    {% if lead.email %}
                    <div class="flex items-center justify-between text-sm p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <a href="mailto:{{ lead.email }}" class="text-gray-900 hover:text-primary-600">{{ lead.email }}</a>
                        </div>
                        <button type="button" 
                                onclick="openDocumentRequestModalForContact('learner', 'email', '{{ lead.email }}')"
                                class="ml-2 px-2 py-1 text-xs font-medium text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-md flex items-center"
                                title="Send document upload link via Email">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            ðŸ“„
                        </button>
                    </div>
                    {% endif %}
                    
                    <!-- WhatsApp -->
                    {% if lead.whatsapp_number %}
                    <div class="flex items-center justify-between text-sm p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            <a href="https://wa.me/{{ lead.whatsapp_number }}" target="_blank" class="text-gray-900 hover:text-green-600">{{ lead.whatsapp_number }}</a>
                            {% if lead.prefers_whatsapp %}
                            <span class="ml-2 text-xs text-green-600">(Preferred)</span>
                            {% endif %}
                        </div>
                        <button type="button" 
                                onclick="openDocumentRequestModalForContact('learner', 'whatsapp', '{{ lead.whatsapp_number }}')"
                                class="ml-2 px-2 py-1 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 rounded-md flex items-center"
                                title="Send document upload link via WhatsApp">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            ðŸ“„
                        </button>
                    </div>
                    {% endif %}
                    
                    <!-- Source info -->
                    <div class="flex items-center text-sm p-2">
                        <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-gray-600">Source: {{ lead.source.name }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- School Leaver Info (if applicable) -->
        {% if lead.lead_type == 'SCHOOL_LEAVER' %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                </svg>
                School Leaver Details
            </h3>
            
            <div class="grid grid-cols-2 gap-4">
                {% if lead.date_of_birth %}
                <div>
                    <p class="text-sm text-gray-500">Date of Birth</p>
                    <p class="text-sm font-medium text-gray-900">{{ lead.date_of_birth|date:"d F Y" }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Age</p>
                    <p class="text-sm font-medium text-gray-900">
                        {{ age }} years old
                        {% if is_minor %}
                        <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Minor</span>
                        {% else %}
                        <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">Adult</span>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                {% if is_minor and turns_18 %}
                <div class="col-span-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <span class="font-semibold">ðŸŽ‚ Turns 18:</span> {{ turns_18|date:"d F Y" }} 
                        <span class="text-yellow-600">({{ days_until_18 }} days away)</span>
                    </p>
                </div>
                {% endif %}
                
                {% if lead.school_name %}
                <div>
                    <p class="text-sm text-gray-500">School</p>
                    <p class="text-sm font-medium text-gray-900">{{ lead.school_name }}</p>
                </div>
                {% endif %}
                
                {% if lead.grade %}
                <div>
                    <p class="text-sm text-gray-500">Grade</p>
                    <p class="text-sm font-medium text-gray-900">{{ lead.grade }}</p>
                </div>
                {% endif %}
                
                {% if lead.expected_matric_year %}
                <div>
                    <p class="text-sm text-gray-500">Expected Matric Year</p>
                    <p class="text-sm font-medium text-gray-900">{{ lead.expected_matric_year }}</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Parent/Guardian Info -->
            {% if lead.parent_name %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Parent/Guardian</h4>
                <div class="space-y-2">
                    <div>
                        <p class="text-sm text-gray-500">Name</p>
                        <p class="text-sm font-medium text-gray-900">{{ lead.parent_name }} {% if lead.parent_relationship %}({{ lead.parent_relationship }}){% endif %}</p>
                    </div>
                    {% if lead.parent_phone %}
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                        <div>
                            <p class="text-xs text-gray-500">Phone</p>
                            <a href="tel:{{ lead.parent_phone }}" class="text-sm font-medium text-primary-600 hover:text-primary-800">{{ lead.parent_phone }}</a>
                        </div>
                        <button type="button" 
                                onclick="openDocumentRequestModalForContact('parent', 'whatsapp', '{{ lead.parent_phone }}')"
                                class="ml-2 px-2 py-1 text-xs font-medium text-amber-700 bg-amber-50 hover:bg-amber-100 rounded-md flex items-center"
                                title="Send document upload link to parent via WhatsApp">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            ðŸ“„
                        </button>
                    </div>
                    {% endif %}
                    {% if lead.parent_email %}
                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50">
                        <div>
                            <p class="text-xs text-gray-500">Email</p>
                            <a href="mailto:{{ lead.parent_email }}" class="text-sm font-medium text-primary-600 hover:text-primary-800">{{ lead.parent_email }}</a>
                        </div>
                        <button type="button" 
                                onclick="openDocumentRequestModalForContact('parent', 'email', '{{ lead.parent_email }}')"
                                class="ml-2 px-2 py-1 text-xs font-medium text-amber-700 bg-amber-50 hover:bg-amber-100 rounded-md flex items-center"
                                title="Send document upload link to parent via Email">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            ðŸ“„
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Activity Timeline -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Activity Timeline</h3>
            
            <!-- Add Activity Form -->
            <form id="add-activity-form" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-start space-x-3">
                    <select name="activity_type" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                        <option value="NOTE">Note</option>
                        <option value="CALL">Call</option>
                        <option value="EMAIL">Email</option>
                        <option value="WHATSAPP">WhatsApp</option>
                        <option value="MEETING">Meeting</option>
                    </select>
                    <input type="text" name="description" placeholder="Add a note or log an activity..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors">
                        Add
                    </button>
                </div>
            </form>
            
            <!-- Timeline -->
            <div class="space-y-4" id="activity-timeline">
                {% for activity in activities %}
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        {% if activity.activity_type == 'CALL' %}
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                        </div>
                        {% elif activity.activity_type == 'EMAIL' %}
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        {% elif activity.activity_type == 'WHATSAPP' %}
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                        </div>
                        {% elif activity.activity_type == 'STATUS_CHANGE' %}
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                            </svg>
                        </div>
                        {% elif activity.activity_type == 'MEETING' %}
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        {% else %}
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-900">{{ activity.get_activity_type_display }}</p>
                            <span class="text-xs text-gray-500">{{ activity.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ activity.description }}</p>
                        {% if activity.created_by %}
                        <p class="text-xs text-gray-400 mt-1">by {{ activity.created_by.get_full_name|default:activity.created_by.email }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4">No activities yet. Add one above!</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Learner Profile Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Learner Profile</h3>
                    <!-- Profile Completion Indicator -->
                    <div class="flex items-center space-x-3">
                        <div class="text-sm font-medium {% if lead.profile_completion_status.percentage >= 80 %}text-green-600{% elif lead.profile_completion_status.percentage >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ lead.profile_completion_status.percentage }}% Complete
                        </div>
                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full {% if lead.profile_completion_status.percentage >= 80 %}bg-green-500{% elif lead.profile_completion_status.percentage >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                                 style="width: {{ lead.profile_completion_status.percentage }}%"></div>
                        </div>
                    </div>
                </div>
                <p class="mt-1 text-sm text-gray-500">Capture learner information for enrollment. This data will automatically copy to the learner record upon conversion.</p>
            </div>
            
            <!-- Profile Sections Accordion -->
            <div class="divide-y divide-gray-100" id="profile-accordion">
                
                <!-- Personal Information Section -->
                <div class="profile-section" data-section="personal">
                    <button type="button" onclick="toggleProfileSection('personal')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Personal Information</h4>
                                <p class="text-xs text-gray-500">Title, ID number, gender, date of birth, race</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-personal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-personal">
                        <form class="profile-form" data-section="personal" onsubmit="saveProfileSection(event, 'personal')">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
                                    <select name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select title...</option>
                                        <option value="MR" {% if lead.title == 'MR' %}selected{% endif %}>Mr</option>
                                        <option value="MRS" {% if lead.title == 'MRS' %}selected{% endif %}>Mrs</option>
                                        <option value="MS" {% if lead.title == 'MS' %}selected{% endif %}>Ms</option>
                                        <option value="MISS" {% if lead.title == 'MISS' %}selected{% endif %}>Miss</option>
                                        <option value="DR" {% if lead.title == 'DR' %}selected{% endif %}>Dr</option>
                                        <option value="PROF" {% if lead.title == 'PROF' %}selected{% endif %}>Prof</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">SA ID Number</label>
                                    <div class="relative">
                                        <input type="text" name="id_number" value="{{ lead.id_number|default:'' }}" maxlength="13"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="Enter 13-digit SA ID" oninput="validateIdNumber(this)">
                                        <div id="id-validation-result" class="mt-1 text-xs"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Gender</label>
                                    <select name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select gender...</option>
                                        <option value="MALE" {% if lead.gender == 'MALE' %}selected{% endif %}>Male</option>
                                        <option value="FEMALE" {% if lead.gender == 'FEMALE' %}selected{% endif %}>Female</option>
                                        <option value="OTHER" {% if lead.gender == 'OTHER' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Date of Birth</label>
                                    <input type="date" name="date_of_birth" value="{{ lead.date_of_birth|date:'Y-m-d'|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Race</label>
                                    <select name="race" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select race...</option>
                                        <option value="BLACK" {% if lead.race == 'BLACK' %}selected{% endif %}>Black</option>
                                        <option value="WHITE" {% if lead.race == 'WHITE' %}selected{% endif %}>White</option>
                                        <option value="COLOURED" {% if lead.race == 'COLOURED' %}selected{% endif %}>Coloured</option>
                                        <option value="INDIAN" {% if lead.race == 'INDIAN' %}selected{% endif %}>Indian/Asian</option>
                                        <option value="OTHER" {% if lead.race == 'OTHER' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Marital Status</label>
                                    <select name="marital_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select status...</option>
                                        <option value="SINGLE" {% if lead.marital_status == 'SINGLE' %}selected{% endif %}>Single</option>
                                        <option value="MARRIED" {% if lead.marital_status == 'MARRIED' %}selected{% endif %}>Married</option>
                                        <option value="DIVORCED" {% if lead.marital_status == 'DIVORCED' %}selected{% endif %}>Divorced</option>
                                        <option value="WIDOWED" {% if lead.marital_status == 'WIDOWED' %}selected{% endif %}>Widowed</option>
                                        <option value="LIVING_TOGETHER" {% if lead.marital_status == 'LIVING_TOGETHER' %}selected{% endif %}>Living Together</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Number of Dependents</label>
                                    <input type="number" name="number_of_dependents" value="{{ lead.number_of_dependents|default:'' }}" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="0">
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Personal Info
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Languages Section -->
                <div class="profile-section" data-section="languages">
                    <button type="button" onclick="toggleProfileSection('languages')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Languages</h4>
                                <p class="text-xs text-gray-500">First language, second language, English proficiency</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-languages" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-languages">
                        <form class="profile-form" data-section="languages" onsubmit="saveProfileSection(event, 'languages')">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">First Language</label>
                                    <select name="first_language" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select language...</option>
                                        <option value="ENGLISH" {% if lead.first_language == 'ENGLISH' %}selected{% endif %}>English</option>
                                        <option value="AFRIKAANS" {% if lead.first_language == 'AFRIKAANS' %}selected{% endif %}>Afrikaans</option>
                                        <option value="ZULU" {% if lead.first_language == 'ZULU' %}selected{% endif %}>Zulu</option>
                                        <option value="XHOSA" {% if lead.first_language == 'XHOSA' %}selected{% endif %}>Xhosa</option>
                                        <option value="SOTHO" {% if lead.first_language == 'SOTHO' %}selected{% endif %}>Sotho</option>
                                        <option value="TSWANA" {% if lead.first_language == 'TSWANA' %}selected{% endif %}>Tswana</option>
                                        <option value="VENDA" {% if lead.first_language == 'VENDA' %}selected{% endif %}>Venda</option>
                                        <option value="TSONGA" {% if lead.first_language == 'TSONGA' %}selected{% endif %}>Tsonga</option>
                                        <option value="SWATI" {% if lead.first_language == 'SWATI' %}selected{% endif %}>Swati</option>
                                        <option value="NDEBELE" {% if lead.first_language == 'NDEBELE' %}selected{% endif %}>Ndebele</option>
                                        <option value="SEPEDI" {% if lead.first_language == 'SEPEDI' %}selected{% endif %}>Sepedi</option>
                                        <option value="OTHER" {% if lead.first_language == 'OTHER' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Second Language</label>
                                    <select name="second_language" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select language...</option>
                                        <option value="ENGLISH" {% if lead.second_language == 'ENGLISH' %}selected{% endif %}>English</option>
                                        <option value="AFRIKAANS" {% if lead.second_language == 'AFRIKAANS' %}selected{% endif %}>Afrikaans</option>
                                        <option value="ZULU" {% if lead.second_language == 'ZULU' %}selected{% endif %}>Zulu</option>
                                        <option value="XHOSA" {% if lead.second_language == 'XHOSA' %}selected{% endif %}>Xhosa</option>
                                        <option value="SOTHO" {% if lead.second_language == 'SOTHO' %}selected{% endif %}>Sotho</option>
                                        <option value="TSWANA" {% if lead.second_language == 'TSWANA' %}selected{% endif %}>Tswana</option>
                                        <option value="VENDA" {% if lead.second_language == 'VENDA' %}selected{% endif %}>Venda</option>
                                        <option value="TSONGA" {% if lead.second_language == 'TSONGA' %}selected{% endif %}>Tsonga</option>
                                        <option value="SWATI" {% if lead.second_language == 'SWATI' %}selected{% endif %}>Swati</option>
                                        <option value="NDEBELE" {% if lead.second_language == 'NDEBELE' %}selected{% endif %}>Ndebele</option>
                                        <option value="SEPEDI" {% if lead.second_language == 'SEPEDI' %}selected{% endif %}>Sepedi</option>
                                        <option value="OTHER" {% if lead.second_language == 'OTHER' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-xs font-medium text-gray-700 mb-2">English Proficiency</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Speaking</label>
                                        <select name="english_speaking" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="">Select...</option>
                                            <option value="NONE" {% if lead.english_speaking == 'NONE' %}selected{% endif %}>None</option>
                                            <option value="BASIC" {% if lead.english_speaking == 'BASIC' %}selected{% endif %}>Basic</option>
                                            <option value="INTERMEDIATE" {% if lead.english_speaking == 'INTERMEDIATE' %}selected{% endif %}>Intermediate</option>
                                            <option value="ADVANCED" {% if lead.english_speaking == 'ADVANCED' %}selected{% endif %}>Advanced</option>
                                            <option value="FLUENT" {% if lead.english_speaking == 'FLUENT' %}selected{% endif %}>Fluent</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Reading</label>
                                        <select name="english_reading" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="">Select...</option>
                                            <option value="NONE" {% if lead.english_reading == 'NONE' %}selected{% endif %}>None</option>
                                            <option value="BASIC" {% if lead.english_reading == 'BASIC' %}selected{% endif %}>Basic</option>
                                            <option value="INTERMEDIATE" {% if lead.english_reading == 'INTERMEDIATE' %}selected{% endif %}>Intermediate</option>
                                            <option value="ADVANCED" {% if lead.english_reading == 'ADVANCED' %}selected{% endif %}>Advanced</option>
                                            <option value="FLUENT" {% if lead.english_reading == 'FLUENT' %}selected{% endif %}>Fluent</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 mb-1">Writing</label>
                                        <select name="english_writing" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="">Select...</option>
                                            <option value="NONE" {% if lead.english_writing == 'NONE' %}selected{% endif %}>None</option>
                                            <option value="BASIC" {% if lead.english_writing == 'BASIC' %}selected{% endif %}>Basic</option>
                                            <option value="INTERMEDIATE" {% if lead.english_writing == 'INTERMEDIATE' %}selected{% endif %}>Intermediate</option>
                                            <option value="ADVANCED" {% if lead.english_writing == 'ADVANCED' %}selected{% endif %}>Advanced</option>
                                            <option value="FLUENT" {% if lead.english_writing == 'FLUENT' %}selected{% endif %}>Fluent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Languages
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Education Section -->
                <div class="profile-section" data-section="education">
                    <button type="button" onclick="toggleProfileSection('education')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Education</h4>
                                <p class="text-xs text-gray-500">Highest grade, school, tertiary qualifications, subjects</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-education" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-education">
                        <form class="profile-form" data-section="education" onsubmit="saveProfileSection(event, 'education')">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Highest Grade Passed</label>
                                    <select name="highest_grade_passed" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select grade...</option>
                                        <option value="GRADE_8" {% if lead.highest_grade_passed == 'GRADE_8' %}selected{% endif %}>Grade 8</option>
                                        <option value="GRADE_9" {% if lead.highest_grade_passed == 'GRADE_9' %}selected{% endif %}>Grade 9</option>
                                        <option value="GRADE_10" {% if lead.highest_grade_passed == 'GRADE_10' %}selected{% endif %}>Grade 10</option>
                                        <option value="GRADE_11" {% if lead.highest_grade_passed == 'GRADE_11' %}selected{% endif %}>Grade 11</option>
                                        <option value="GRADE_12" {% if lead.highest_grade_passed == 'GRADE_12' %}selected{% endif %}>Grade 12 (Matric)</option>
                                        <option value="N1" {% if lead.highest_grade_passed == 'N1' %}selected{% endif %}>N1</option>
                                        <option value="N2" {% if lead.highest_grade_passed == 'N2' %}selected{% endif %}>N2</option>
                                        <option value="N3" {% if lead.highest_grade_passed == 'N3' %}selected{% endif %}>N3</option>
                                        <option value="N4" {% if lead.highest_grade_passed == 'N4' %}selected{% endif %}>N4</option>
                                        <option value="N5" {% if lead.highest_grade_passed == 'N5' %}selected{% endif %}>N5</option>
                                        <option value="N6" {% if lead.highest_grade_passed == 'N6' %}selected{% endif %}>N6</option>
                                        <option value="DIPLOMA" {% if lead.highest_grade_passed == 'DIPLOMA' %}selected{% endif %}>Diploma</option>
                                        <option value="DEGREE" {% if lead.highest_grade_passed == 'DEGREE' %}selected{% endif %}>Degree</option>
                                        <option value="POSTGRAD" {% if lead.highest_grade_passed == 'POSTGRAD' %}selected{% endif %}>Postgraduate</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Last School Attended</label>
                                    <input type="text" name="last_school_attended" value="{{ lead.last_school_attended|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="School name">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Tertiary Qualifications</label>
                                    <textarea name="tertiary_qualification" rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                              placeholder="List any tertiary qualifications...">{{ lead.tertiary_qualification|default:'' }}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Subjects Completed</label>
                                    <textarea name="subjects_completed" rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                              placeholder="List subjects completed (with results if available)...">{{ lead.subjects_completed|default:'' }}</textarea>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Education
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Work Experience Section -->
                <div class="profile-section" data-section="work">
                    <button type="button" onclick="toggleProfileSection('work')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Work Experience</h4>
                                <p class="text-xs text-gray-500">Employment status, years of experience</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-work" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-work">
                        <form class="profile-form" data-section="work" onsubmit="saveProfileSection(event, 'work')">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Work Status</label>
                                    <select name="work_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select status...</option>
                                        <option value="EMPLOYED" {% if lead.work_status == 'EMPLOYED' %}selected{% endif %}>Employed</option>
                                        <option value="UNEMPLOYED" {% if lead.work_status == 'UNEMPLOYED' %}selected{% endif %}>Unemployed</option>
                                        <option value="SELF_EMPLOYED" {% if lead.work_status == 'SELF_EMPLOYED' %}selected{% endif %}>Self-Employed</option>
                                        <option value="STUDENT" {% if lead.work_status == 'STUDENT' %}selected{% endif %}>Student</option>
                                        <option value="RETIRED" {% if lead.work_status == 'RETIRED' %}selected{% endif %}>Retired</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Years of Experience</label>
                                    <input type="number" name="years_experience" value="{{ lead.years_experience|default:'' }}" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="Years">
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Work Info
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Health Section -->
                <div class="profile-section" data-section="health">
                    <button type="button" onclick="toggleProfileSection('health')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Health & Medical</h4>
                                <p class="text-xs text-gray-500">Disability status, medical conditions</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-health" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-health">
                        <form class="profile-form" data-section="health" onsubmit="saveProfileSection(event, 'health')">
                            <div class="space-y-4">
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" name="has_disability" id="has_disability" 
                                               {% if lead.has_disability %}checked{% endif %}
                                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                               onchange="toggleDisabilityDescription(this)">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="has_disability" class="font-medium text-gray-700">Has Disability</label>
                                        <p class="text-gray-500">Check if the learner has any disability</p>
                                    </div>
                                </div>
                                <div id="disability-description-container" class="{% if not lead.has_disability %}hidden{% endif %}">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Disability Description</label>
                                    <textarea name="disability_description" rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                              placeholder="Describe the disability...">{{ lead.disability_description|default:'' }}</textarea>
                                </div>
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" name="has_medical_conditions" id="has_medical_conditions" 
                                               {% if lead.has_medical_conditions %}checked{% endif %}
                                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                               onchange="toggleMedicalConditions(this)">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="has_medical_conditions" class="font-medium text-gray-700">Has Medical Conditions</label>
                                        <p class="text-gray-500">Check if the learner has any medical conditions</p>
                                    </div>
                                </div>
                                <div id="medical-conditions-container" class="{% if not lead.has_medical_conditions %}hidden{% endif %}">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Medical Conditions</label>
                                    <textarea name="medical_conditions" rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                              placeholder="Describe medical conditions...">{{ lead.medical_conditions|default:'' }}</textarea>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Health Info
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Payment Responsibility Section -->
                <div class="profile-section" data-section="payment">
                    <button type="button" onclick="toggleProfileSection('payment')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Payment Responsibility</h4>
                                <p class="text-xs text-gray-500">Who will be responsible for fees</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-payment" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-payment">
                        <form class="profile-form" data-section="payment" onsubmit="saveProfileSection(event, 'payment')">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Payment Responsibility</label>
                                    <select name="payment_responsibility" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select...</option>
                                        <option value="SELF" {% if lead.payment_responsibility == 'SELF' %}selected{% endif %}>Self (Learner)</option>
                                        <option value="PARENT" {% if lead.payment_responsibility == 'PARENT' %}selected{% endif %}>Parent/Guardian</option>
                                        <option value="EMPLOYER" {% if lead.payment_responsibility == 'EMPLOYER' %}selected{% endif %}>Employer/Company</option>
                                        <option value="BURSARY" {% if lead.payment_responsibility == 'BURSARY' %}selected{% endif %}>Bursary/Scholarship</option>
                                        <option value="OTHER" {% if lead.payment_responsibility == 'OTHER' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500">
                                    <svg class="w-4 h-4 inline-block mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    If payment is by employer or parent, capture their details in the Secondary Contacts section above.
                                </p>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Payment Info
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Physical Address Section -->
                <div class="profile-section" data-section="physical_address">
                    <button type="button" onclick="toggleProfileSection('physical_address')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Physical Address</h4>
                                <p class="text-xs text-gray-500">Residential address details</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-physical_address" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-physical_address">
                        <form class="profile-form" data-section="physical_address" onsubmit="saveProfileSection(event, 'physical_address')">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Address Line 1</label>
                                    <input type="text" name="physical_line_1" value="{{ lead.physical_address.line_1|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="Street address">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Address Line 2</label>
                                    <input type="text" name="physical_line_2" value="{{ lead.physical_address.line_2|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="Apartment, suite, etc. (optional)">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Suburb</label>
                                    <input type="text" name="physical_suburb" value="{{ lead.physical_address.suburb|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="Suburb">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">City</label>
                                    <input type="text" name="physical_city" value="{{ lead.physical_address.city|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="City">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Province</label>
                                    <select name="physical_province" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                        <option value="">Select province...</option>
                                        <option value="EASTERN_CAPE" {% if lead.physical_address.province == 'EASTERN_CAPE' %}selected{% endif %}>Eastern Cape</option>
                                        <option value="FREE_STATE" {% if lead.physical_address.province == 'FREE_STATE' %}selected{% endif %}>Free State</option>
                                        <option value="GAUTENG" {% if lead.physical_address.province == 'GAUTENG' %}selected{% endif %}>Gauteng</option>
                                        <option value="KWAZULU_NATAL" {% if lead.physical_address.province == 'KWAZULU_NATAL' %}selected{% endif %}>KwaZulu-Natal</option>
                                        <option value="LIMPOPO" {% if lead.physical_address.province == 'LIMPOPO' %}selected{% endif %}>Limpopo</option>
                                        <option value="MPUMALANGA" {% if lead.physical_address.province == 'MPUMALANGA' %}selected{% endif %}>Mpumalanga</option>
                                        <option value="NORTH_WEST" {% if lead.physical_address.province == 'NORTH_WEST' %}selected{% endif %}>North West</option>
                                        <option value="NORTHERN_CAPE" {% if lead.physical_address.province == 'NORTHERN_CAPE' %}selected{% endif %}>Northern Cape</option>
                                        <option value="WESTERN_CAPE" {% if lead.physical_address.province == 'WESTERN_CAPE' %}selected{% endif %}>Western Cape</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Postal Code</label>
                                    <input type="text" name="physical_postal_code" value="{{ lead.physical_address.postal_code|default:'' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                           placeholder="Postal code">
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Physical Address
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Postal Address Section -->
                <div class="profile-section" data-section="postal_address">
                    <button type="button" onclick="toggleProfileSection('postal_address')" 
                            class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center">
                                <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h4 class="text-sm font-medium text-gray-900">Postal Address</h4>
                                <p class="text-xs text-gray-500">Mailing address (if different from physical)</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform section-chevron" id="chevron-postal_address" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="hidden px-6 pb-6 pt-2" id="content-postal_address">
                        <form class="profile-form" data-section="postal_address" onsubmit="saveProfileSection(event, 'postal_address')">
                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" name="postal_same_as_physical" id="postal_same_as_physical"
                                           {% if lead.postal_same_as_physical %}checked{% endif %}
                                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                           onchange="togglePostalAddressFields(this)">
                                    <span class="ml-2 text-sm text-gray-700">Same as physical address</span>
                                </label>
                            </div>
                            <div id="postal-address-fields" class="{% if lead.postal_same_as_physical %}hidden{% endif %}">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Address Line 1</label>
                                        <input type="text" name="postal_line_1" value="{{ lead.postal_address.line_1|default:'' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="PO Box or street address">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Address Line 2</label>
                                        <input type="text" name="postal_line_2" value="{{ lead.postal_address.line_2|default:'' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="Optional">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Suburb</label>
                                        <input type="text" name="postal_suburb" value="{{ lead.postal_address.suburb|default:'' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="Suburb">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" name="postal_city" value="{{ lead.postal_address.city|default:'' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="City">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Province</label>
                                        <select name="postal_province" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                            <option value="">Select province...</option>
                                            <option value="EASTERN_CAPE" {% if lead.postal_address.province == 'EASTERN_CAPE' %}selected{% endif %}>Eastern Cape</option>
                                            <option value="FREE_STATE" {% if lead.postal_address.province == 'FREE_STATE' %}selected{% endif %}>Free State</option>
                                            <option value="GAUTENG" {% if lead.postal_address.province == 'GAUTENG' %}selected{% endif %}>Gauteng</option>
                                            <option value="KWAZULU_NATAL" {% if lead.postal_address.province == 'KWAZULU_NATAL' %}selected{% endif %}>KwaZulu-Natal</option>
                                            <option value="LIMPOPO" {% if lead.postal_address.province == 'LIMPOPO' %}selected{% endif %}>Limpopo</option>
                                            <option value="MPUMALANGA" {% if lead.postal_address.province == 'MPUMALANGA' %}selected{% endif %}>Mpumalanga</option>
                                            <option value="NORTH_WEST" {% if lead.postal_address.province == 'NORTH_WEST' %}selected{% endif %}>North West</option>
                                            <option value="NORTHERN_CAPE" {% if lead.postal_address.province == 'NORTHERN_CAPE' %}selected{% endif %}>Northern Cape</option>
                                            <option value="WESTERN_CAPE" {% if lead.postal_address.province == 'WESTERN_CAPE' %}selected{% endif %}>Western Cape</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Postal Code</label>
                                        <input type="text" name="postal_postal_code" value="{{ lead.postal_address.postal_code|default:'' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500"
                                               placeholder="Postal code">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                                    Save Postal Address
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
    
    <!-- Sidebar - Right Column -->
    <div class="space-y-6">
        
        <!-- Quick Status Update -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Update Status</h3>
            <div class="grid grid-cols-2 gap-2">
                {% for value, label in statuses %}
                <button onclick="updateStatus('{{ value }}')" 
                        class="px-3 py-2 text-xs font-medium rounded-lg border transition-colors
                        {% if lead.status == value %}
                        bg-primary-100 border-primary-300 text-primary-700
                        {% else %}
                        bg-white border-gray-200 text-gray-600 hover:bg-gray-50
                        {% endif %}">
                    {{ label }}
                </button>
                {% endfor %}
            </div>
        </div>
        
        <!-- Assignment -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Assignment</h3>
            <div class="flex items-center">
                {% if lead.assigned_to %}
                <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white font-semibold">
                        {{ lead.assigned_to.first_name|slice:":1" }}{{ lead.assigned_to.last_name|slice:":1" }}
                    </div>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">{{ lead.assigned_to.get_full_name|default:lead.assigned_to.username }}</p>
                    <p class="text-xs text-gray-500">{{ lead.assigned_to.email }}</p>
                </div>
                {% else %}
                <p class="text-sm text-orange-600">Unassigned</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Follow-up -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Next Follow-up</h3>
            {% if lead.next_follow_up %}
            <div class="p-3 rounded-lg {% if lead.next_follow_up.date < today %}bg-red-50{% elif lead.next_follow_up.date == today %}bg-yellow-50{% else %}bg-gray-50{% endif %}">
                <p class="text-sm font-medium {% if lead.next_follow_up.date < today %}text-red-700{% elif lead.next_follow_up.date == today %}text-yellow-700{% else %}text-gray-700{% endif %}">
                    {{ lead.next_follow_up|date:"d M Y H:i" }}
                </p>
                {% if lead.follow_up_notes %}
                <p class="text-xs text-gray-600 mt-1">{{ lead.follow_up_notes }}</p>
                {% endif %}
            </div>
            {% else %}
            <p class="text-sm text-gray-500">No follow-up scheduled</p>
            {% endif %}
            <a href="{% url 'crm:lead_update' lead.pk %}" class="mt-3 inline-flex items-center text-sm text-primary-600 hover:text-primary-700">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Schedule Follow-up
            </a>
        </div>
        
        <!-- Messaging Consent -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Messaging Consent</h3>
            {% if lead.consent_bulk_messaging and not lead.unsubscribed %}
            <div class="flex items-center text-green-600">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-sm font-medium">Consented to bulk messaging</span>
            </div>
            {% if lead.consent_date %}
            <p class="text-xs text-gray-500 mt-1">Since {{ lead.consent_date|date:"d M Y" }}</p>
            {% endif %}
            {% elif lead.unsubscribed %}
            <div class="flex items-center text-red-600">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
                <span class="text-sm font-medium">Unsubscribed</span>
            </div>
            {% if lead.unsubscribed_date %}
            <p class="text-xs text-gray-500 mt-1">On {{ lead.unsubscribed_date|date:"d M Y" }}</p>
            {% endif %}
            {% else %}
            <div class="flex items-center text-gray-500">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-sm font-medium">No consent given</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Uploaded Documents Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4 flex items-center justify-between">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                    Documents ({{ lead_documents.count }})
                </span>
            </h3>
            
            <!-- Upload Form -->
            <form id="document-upload-form" enctype="multipart/form-data" class="mb-4 p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Document Type</label>
                        <select name="document_type" id="upload-doc-type" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                            {% for value, label in document_types %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Select File</label>
                        <input type="file" name="file" id="document-file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               class="w-full text-sm text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-medium file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                    </div>
                    <button type="submit" id="upload-doc-btn"
                            class="w-full py-2 px-3 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Upload Document
                    </button>
                </div>
            </form>
            
            <!-- Document List -->
            <div id="document-list" class="space-y-2 max-h-96 overflow-y-auto">
                {% if lead_documents %}
                    {% for doc in lead_documents %}
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors" id="doc-{{ doc.id }}">
                        <div class="flex items-center min-w-0">
                            <!-- Document Icon -->
                            <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center
                                {% if doc.content_type == 'application/pdf' %}bg-red-100 text-red-600
                                {% elif 'image' in doc.content_type %}bg-blue-100 text-blue-600
                                {% else %}bg-gray-100 text-gray-600{% endif %}">
                                {% if doc.content_type == 'application/pdf' %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                                </svg>
                                {% elif 'image' in doc.content_type %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                </svg>
                                {% else %}
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                                </svg>
                                {% endif %}
                            </div>
                            <div class="ml-2 min-w-0">
                                <p class="text-xs font-medium text-gray-900 truncate">{{ doc.get_document_type_display }}</p>
                                <p class="text-xs text-gray-500 truncate">{{ doc.original_filename }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 ml-2">
                            <!-- Status Badge -->
                            <span class="px-1.5 py-0.5 text-xs rounded
                                {% if doc.status == 'VERIFIED' %}bg-green-100 text-green-700
                                {% elif doc.status == 'REJECTED' %}bg-red-100 text-red-700
                                {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ doc.get_status_display }}
                            </span>
                            <!-- View Button -->
                            <a href="{{ doc.file.url }}" target="_blank"
                               class="p-1 text-gray-400 hover:text-primary-600" title="View">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </a>
                            <!-- Download Button -->
                            <a href="{{ doc.file.url }}" download
                               class="p-1 text-gray-400 hover:text-primary-600" title="Download">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </a>
                            <!-- Delete Button -->
                            <button type="button" onclick="deleteDocument('{{ doc.id }}')"
                                    class="p-1 text-gray-400 hover:text-red-600" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500 text-center py-4">No documents uploaded yet</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Pipeline Memberships Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4 flex items-center justify-between">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Pipelines ({{ lead.pipeline_memberships.count }})
                </span>
                <button type="button" onclick="openAddPipelineModal()" 
                        class="text-primary-600 hover:text-primary-800 transition-colors" title="Add to Pipeline">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                </button>
            </h3>
            
            <!-- Pipeline Memberships List -->
            <div class="space-y-2" id="pipeline-memberships-list">
                {% for membership in pipeline_memberships %}
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200" id="membership-{{ membership.id }}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ membership.pipeline.color }}"></span>
                            <span class="font-medium text-sm text-gray-900">{{ membership.pipeline.name }}</span>
                        </div>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full 
                            {% if membership.status == 'ACTIVE' %}bg-green-100 text-green-800
                            {% elif membership.status == 'PAUSED' %}bg-yellow-100 text-yellow-800
                            {% elif membership.status == 'COMPLETED' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ membership.get_status_display }}
                        </span>
                    </div>
                    
                    {% if membership.current_stage %}
                    <div class="text-xs text-gray-500 mb-2">
                        <span class="font-medium">Stage:</span> {{ membership.current_stage.name }}
                        {% if membership.stage_entered_at %}
                        <span class="ml-2 text-gray-400">({{ membership.stage_entered_at|timesince }} ago)</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Joined {{ membership.joined_at|date:"d M Y" }}</span>
                        <div class="flex items-center space-x-2">
                            {% if membership.status == 'ACTIVE' %}
                            <button type="button" onclick="pausePipelineMembership({{ membership.id }})" 
                                    class="text-yellow-600 hover:text-yellow-800" title="Pause">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                            {% elif membership.status == 'PAUSED' %}
                            <button type="button" onclick="resumePipelineMembership({{ membership.id }})" 
                                    class="text-green-600 hover:text-green-800" title="Resume">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                            {% endif %}
                            <button type="button" onclick="removePipelineMembership({{ membership.id }}, '{{ membership.pipeline.name }}')" 
                                    class="text-red-600 hover:text-red-800" title="Remove from Pipeline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4" id="no-pipelines-msg">Not enrolled in any pipelines</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Applications Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4 flex items-center justify-between">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Applications ({{ active_applications.count }})
                </span>
                <button type="button" onclick="openCreateApplicationModal()" 
                        class="text-primary-600 hover:text-primary-800 transition-colors" title="Create Application">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                </button>
            </h3>
            
            <!-- Active Applications List -->
            <div class="space-y-2" id="applications-list">
                {% for app in active_applications %}
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-sm text-gray-900">{{ app.opportunity.qualification.title|default:"Application" }}</span>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full 
                            {% if app.status == 'DRAFT' %}bg-gray-100 text-gray-800
                            {% elif app.status == 'SUBMITTED' %}bg-blue-100 text-blue-800
                            {% elif app.status == 'DOCUMENTS_PENDING' %}bg-yellow-100 text-yellow-800
                            {% elif app.status == 'UNDER_REVIEW' %}bg-indigo-100 text-indigo-800
                            {% elif app.status == 'ACCEPTED' %}bg-green-100 text-green-800
                            {% elif app.status == 'WAITLIST' %}bg-orange-100 text-orange-800
                            {% elif app.status == 'REJECTED' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ app.get_status_display }}
                        </span>
                    </div>
                    
                    {% if app.opportunity.intake %}
                    <div class="text-xs text-gray-500 mb-1">
                        <span class="font-medium">Intake:</span> {{ app.opportunity.intake.name }}
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">Created {{ app.created_at|date:"d M Y" }}</span>
                        <a href="{% url 'crm:application_detail' app.pk %}" 
                           class="text-primary-600 hover:text-primary-800 font-medium">
                            View Details â†’
                        </a>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center py-4">No active applications</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Document Upload Links -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm border border-blue-200 p-6">
            <h3 class="text-sm font-semibold text-blue-800 uppercase tracking-wider mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Document Upload Links
            </h3>
            
            <!-- Create New Request Button -->
            <button type="button" onclick="openDocumentRequestModal()"
                    class="w-full mb-4 py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Request Documents
            </button>
            
            <!-- Existing Document Requests -->
            {% if document_requests %}
            <div class="space-y-3">
                {% for request in document_requests %}
                <div class="p-3 bg-white rounded-lg border {% if request.status == 'COMPLETED' %}border-green-200{% elif request.status == 'EXPIRED' %}border-red-200{% elif request.status == 'REVOKED' %}border-gray-200{% else %}border-blue-200{% endif %}">
                    <!-- Status Badge -->
                    <div class="flex items-center justify-between mb-2">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full 
                            {% if request.status == 'ACTIVE' %}bg-blue-100 text-blue-800
                            {% elif request.status == 'COMPLETED' %}bg-green-100 text-green-800
                            {% elif request.status == 'EXPIRED' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ request.get_status_display }}
                        </span>
                        <span class="text-xs text-gray-500">{{ request.created_at|date:"d M Y" }}</span>
                    </div>
                    
                    <!-- Progress -->
                    {% if request.status == 'ACTIVE' %}
                    <div class="mb-2">
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                            <span>Upload Progress</span>
                            <span>{{ request.upload_progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: {{ request.upload_progress }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Unique Portal Link -->
                    {% if request.status == 'ACTIVE' %}
                    <div class="mt-2 p-2 bg-gray-50 rounded border border-gray-200">
                        <p class="text-xs text-gray-500 mb-1">Unique Portal Link:</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" 
                                   value="{{ request.get_full_portal_url }}" 
                                   id="portal-link-{{ request.id }}"
                                   class="flex-1 text-xs bg-white border border-gray-200 rounded px-2 py-1 text-gray-600"
                                   readonly>
                            <button type="button" 
                                    onclick="copyPortalLink('{{ request.id }}', '{{ request.get_full_portal_url }}')"
                                    class="px-2 py-1 text-xs font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 rounded flex items-center"
                                    title="Copy link">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Send Buttons -->
                    <div class="mt-2 flex space-x-2">
                        {% if lead.whatsapp_number %}
                        <button type="button" 
                                onclick="resendDocumentLink('{{ request.id }}', 'whatsapp')"
                                class="flex-1 px-2 py-1.5 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 rounded flex items-center justify-center"
                                title="Resend via WhatsApp">
                            <svg class="w-3.5 h-3.5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            WhatsApp
                        </button>
                        {% endif %}
                        {% if lead.email %}
                        <button type="button" 
                                onclick="resendDocumentLink('{{ request.id }}', 'email')"
                                class="flex-1 px-2 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded flex items-center justify-center"
                                title="Resend via Email">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            Email
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Tracking Info -->
                    <div class="mt-2 text-xs text-gray-500 space-y-0.5">
                        {% if request.view_count > 0 %}
                        <p>ðŸ‘ Viewed {{ request.view_count }} time{{ request.view_count|pluralize }} {% if request.last_viewed_at %}(last: {{ request.last_viewed_at|date:"d M Y H:i" }}){% endif %}</p>
                        {% endif %}
                        {% if request.sent_at %}
                        <p>ðŸ“¤ Sent via {{ request.get_sent_via_display }} on {{ request.sent_at|date:"d M Y H:i" }}</p>
                        {% endif %}
                        {% if request.valid_until %}
                        <p>â° Expires: {{ request.valid_until|date:"d M Y" }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <svg class="mx-auto h-10 w-10 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-sm text-blue-700 mt-2">No document requests yet</p>
                <p class="text-xs text-blue-600 mt-1">Click above to send a document upload link</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Quick Quote Section -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl shadow-sm border border-amber-200 p-6">
            <h3 class="text-sm font-semibold text-amber-800 uppercase tracking-wider mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Create Quote
            </h3>
            
            {% if lead.qualification_interest %}
            <div class="mb-4 p-3 bg-white rounded-lg border border-amber-200">
                <p class="text-sm font-medium text-gray-900">{{ lead.qualification_interest.title }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ lead.qualification_interest.saqa_id }}</p>
                {% if lead.qualification_interest.fee_full %}
                <p class="text-lg font-bold text-amber-700 mt-2">R{{ lead.qualification_interest.fee_full|floatformat:0 }}</p>
                {% endif %}
            </div>
            
            <button type="button" onclick="openQuickQuoteModal()"
                    class="w-full py-3 px-4 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-lg transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Generate & Send Quote
            </button>
            {% else %}
            <div class="text-center py-4">
                <svg class="mx-auto h-10 w-10 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <p class="text-sm text-amber-700 mt-2">No qualification selected</p>
                <p class="text-xs text-amber-600 mt-1">Select a qualification to create a quote</p>
            </div>
            
            <button type="button" onclick="openQuickQuoteModal()"
                    class="w-full mt-3 py-3 px-4 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-lg transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Select & Quote
            </button>
            {% endif %}
            
            <a href="{% url 'crm:quote_create_for_lead' lead.pk %}" 
               class="mt-3 w-full inline-flex items-center justify-center text-sm text-amber-700 hover:text-amber-800">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                Advanced Quote Form
            </a>
        </div>
        
        <!-- Interest -->
        {% if lead.qualification_interest %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Interest</h3>
            <p class="text-sm font-medium text-gray-900">{{ lead.qualification_interest.title }}</p>
            <p class="text-xs text-gray-500">{{ lead.qualification_interest.saqa_id }}</p>
        </div>
        {% endif %}
        
        <!-- Notes -->
        {% if lead.notes %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Notes</h3>
            <p class="text-sm text-gray-600 whitespace-pre-wrap">{{ lead.notes }}</p>
        </div>
        {% endif %}
        
        <!-- Meta -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-4">Details</h3>
            <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <dt class="text-gray-500">Created</dt>
                    <dd class="text-gray-900">{{ lead.created_at|date:"d M Y H:i" }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-gray-500">Updated</dt>
                    <dd class="text-gray-900">{{ lead.updated_at|date:"d M Y H:i" }}</dd>
                </div>
                {% if lead.brand %}
                <div class="flex justify-between">
                    <dt class="text-gray-500">Brand</dt>
                    <dd class="text-gray-900">{{ lead.brand.name }}</dd>
                </div>
                {% endif %}
                {% if lead.campus %}
                <div class="flex justify-between">
                    <dt class="text-gray-500">Campus</dt>
                    <dd class="text-gray-900">{{ lead.campus.name }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>
        
    </div>
</div>

<script>
function updateStatus(status) {
    fetch('{% url "crm:lead_quick_status" lead.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'status=' + status
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

document.getElementById('add-activity-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('{% url "crm:lead_add_activity" lead.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
});

// Quick Quote Modal Functions
function openQuickQuoteModal() {
    document.getElementById('quick-quote-modal').classList.remove('hidden');
    document.getElementById('quote-modal-content').innerHTML = `
        <div class="animate-pulse flex flex-col space-y-4">
            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            <div class="h-10 bg-gray-200 rounded"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
    `;
    
    // Load quote data
    fetch('/crm/api/leads/{{ lead.pk }}/quick-quote-data/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('quote-modal-content').innerHTML = `
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="mt-2 text-red-600">${data.error}</p>
                    </div>
                `;
                return;
            }
            renderQuoteForm(data);
        })
        .catch(error => {
            document.getElementById('quote-modal-content').innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-600">Failed to load quote data. Please try again.</p>
                </div>
            `;
        });
}

function closeQuoteModal() {
    document.getElementById('quick-quote-modal').classList.add('hidden');
}

let quoteData = null;

function renderQuoteForm(data) {
    quoteData = data;
    
    let qualOptions = data.qualifications.map(q => 
        `<option value="${q.id}" data-price="${q.price}" ${q.id === data.lead.qualification_interest_id ? 'selected' : ''}>
            ${q.name} - R${q.price.toLocaleString()}
        </option>`
    ).join('');
    
    let paymentOptions = data.payment_options.map(p =>
        `<option value="${p.id}" data-months="${p.monthly_term}" data-deposit="${p.deposit_percent}">
            ${p.name} (${p.monthly_term} months)
        </option>`
    ).join('');
    
    const currentPrice = data.lead.qualification_interest_price || (data.qualifications[0]?.price || 0);
    
    document.getElementById('quote-modal-content').innerHTML = `
        <div class="space-y-4">
            <!-- Lead Info -->
            <div class="bg-gray-50 rounded-lg p-3">
                <p class="font-medium text-gray-900">${data.lead.full_name}</p>
                <p class="text-sm text-gray-500">${data.lead.email || ''} ${data.lead.phone ? 'â€¢ ' + data.lead.phone : ''}</p>
            </div>
            
            <!-- Qualification Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Qualification</label>
                <select id="quote-qualification" class="w-full rounded-lg border-gray-300 focus:ring-amber-500 focus:border-amber-500" onchange="updateQuotePricing()">
                    ${qualOptions || '<option disabled>No qualifications available</option>'}
                </select>
            </div>
            
            <!-- Payment Plan -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Plan</label>
                <select id="quote-payment" class="w-full rounded-lg border-gray-300 focus:ring-amber-500 focus:border-amber-500" onchange="updateQuotePricing()">
                    ${paymentOptions || '<option value="">Full Payment</option>'}
                </select>
            </div>
            
            <!-- Pricing Summary -->
            <div id="quote-pricing" class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">Total Fee:</span>
                    <span id="quote-total" class="font-bold text-gray-900">R${currentPrice.toLocaleString()}</span>
                </div>
                <div id="quote-deposit-row" class="flex justify-between text-sm mb-2 hidden">
                    <span class="text-gray-600">Deposit:</span>
                    <span id="quote-deposit" class="font-medium text-gray-700">R0</span>
                </div>
                <div id="quote-monthly-row" class="flex justify-between text-sm hidden">
                    <span class="text-gray-600">Monthly Payment:</span>
                    <span id="quote-monthly" class="font-medium text-gray-700">R0</span>
                </div>
            </div>
            
            <!-- Send Options -->
            <div class="border-t border-gray-200 pt-4">
                <p class="text-sm font-medium text-gray-700 mb-3">Send Quote Via:</p>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="quote-whatsapp" ${data.lead.has_whatsapp ? 'checked' : ''} class="rounded text-amber-600 focus:ring-amber-500">
                        <span class="ml-2 text-sm text-gray-700 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            WhatsApp ${data.lead.whatsapp_number || data.lead.phone || ''}
                        </span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="quote-email" ${data.lead.has_email ? '' : 'disabled'} class="rounded text-amber-600 focus:ring-amber-500">
                        <span class="ml-2 text-sm ${data.lead.has_email ? 'text-gray-700' : 'text-gray-400'}">
                            ðŸ“§ Email ${data.lead.email || '(no email)'}
                        </span>
                    </label>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-3 pt-2">
                <button type="button" onclick="closeQuoteModal()" 
                        class="flex-1 py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="button" onclick="submitQuote()" id="submit-quote-btn"
                        class="flex-1 py-3 px-4 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-lg transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    Send Quote
                </button>
            </div>
        </div>
    `;
    
    // Trigger initial pricing calculation
    updateQuotePricing();
}

function updateQuotePricing() {
    if (!quoteData) return;
    
    const qualSelect = document.getElementById('quote-qualification');
    const paymentSelect = document.getElementById('quote-payment');
    
    if (!qualSelect) return;
    
    const selectedOption = qualSelect.options[qualSelect.selectedIndex];
    const price = parseFloat(selectedOption?.dataset?.price || 0);
    
    document.getElementById('quote-total').textContent = 'R' + price.toLocaleString();
    
    // Calculate payment plan if selected
    if (paymentSelect && paymentSelect.value) {
        const paymentOption = paymentSelect.options[paymentSelect.selectedIndex];
        const depositPercent = parseFloat(paymentOption?.dataset?.deposit || 0);
        const months = parseInt(paymentOption?.dataset?.months || 1);
        
        if (depositPercent > 0 || months > 1) {
            const deposit = price * (depositPercent / 100);
            const remaining = price - deposit;
            const monthly = remaining / months;
            
            document.getElementById('quote-deposit').textContent = 'R' + deposit.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('quote-monthly').textContent = 'R' + monthly.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/month';
            
            document.getElementById('quote-deposit-row').classList.remove('hidden');
            document.getElementById('quote-monthly-row').classList.remove('hidden');
        } else {
            document.getElementById('quote-deposit-row').classList.add('hidden');
            document.getElementById('quote-monthly-row').classList.add('hidden');
        }
    } else {
        document.getElementById('quote-deposit-row')?.classList.add('hidden');
        document.getElementById('quote-monthly-row')?.classList.add('hidden');
    }
}

function submitQuote() {
    const qualId = document.getElementById('quote-qualification').value;
    const paymentId = document.getElementById('quote-payment')?.value || '';
    const sendWhatsApp = document.getElementById('quote-whatsapp')?.checked || false;
    const sendEmail = document.getElementById('quote-email')?.checked || false;
    
    if (!qualId) {
        alert('Please select a qualification');
        return;
    }
    
    if (!sendWhatsApp && !sendEmail) {
        alert('Please select at least one delivery method (WhatsApp or Email)');
        return;
    }
    
    const submitBtn = document.getElementById('submit-quote-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Creating Quote...
    `;
    
    fetch('/crm/api/leads/{{ lead.pk }}/quick-quote-create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            qualification_id: qualId,
            payment_option_id: paymentId,
            send_whatsapp: sendWhatsApp,
            send_email: sendEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            document.getElementById('quote-modal-content').innerHTML = `
                <div class="text-center py-8">
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-900">Quote Sent Successfully!</h3>
                    <p class="mt-2 text-sm text-gray-600">Quote #${data.quote_number} has been created and sent.</p>
                    <div class="mt-4 space-y-2">
                        ${data.whatsapp_sent ? '<p class="text-sm text-green-600">âœ“ Sent via WhatsApp</p>' : ''}
                        ${data.email_sent ? '<p class="text-sm text-green-600">âœ“ Sent via Email</p>' : ''}
                    </div>
                    <div class="mt-6 flex space-x-3 justify-center">
                        <a href="/crm/quotes/${data.quote_id}/" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-lg transition-colors">
                            View Quote
                        </a>
                        <button type="button" onclick="closeQuoteModal(); location.reload();" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
        } else {
            alert(data.error || 'Failed to create quote. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                Send Quote
            `;
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            Send Quote
        `;
    });
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeQuoteModal();
    }
});
</script>

<!-- Quick Quote Modal -->
<div id="quick-quote-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Quick Quote
                </h3>
                <button onclick="closeQuoteModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div id="quote-modal-content">
                <div class="animate-pulse flex flex-col space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-10 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Request Modal -->
<div id="document-request-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Request Documents
                </h3>
                <button onclick="closeDocumentRequestModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div id="document-request-modal-content">
                <!-- Recipient -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Send To</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="doc_recipient" value="learner" class="mr-2" checked>
                            <div>
                                <span class="text-sm font-medium text-gray-900">Learner</span>
                                <span class="block text-xs text-gray-500" id="learner-contact-display">{{ lead.phone }}</span>
                            </div>
                        </label>
                        {% if lead.parent_phone or lead.parent_email %}
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="doc_recipient" value="parent" class="mr-2">
                            <div>
                                <span class="text-sm font-medium text-gray-900">Parent</span>
                                <span class="block text-xs text-gray-500">{{ lead.parent_name }}</span>
                            </div>
                        </label>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Send Via -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Send Via</label>
                    <div class="flex space-x-2">
                        {% if lead.whatsapp_number or lead.phone %}
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-green-50 transition-colors flex-1">
                            <input type="radio" name="doc_send_via" value="whatsapp" class="mr-2" checked>
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            <span class="text-sm font-medium">WhatsApp</span>
                        </label>
                        {% endif %}
                        {% if lead.email %}
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition-colors flex-1">
                            <input type="radio" name="doc_send_via" value="email" class="mr-2" {% if not lead.whatsapp_number and not lead.phone %}checked{% endif %}>
                            <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <span class="text-sm font-medium">Email</span>
                        </label>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Document Types -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Documents Requested</label>
                    <div class="grid grid-cols-2 gap-2">
                        {% for type_code, type_name in document_types %}
                        <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="checkbox" name="doc_types" value="{{ type_code }}" class="mr-2 doc-type-checkbox" checked>
                            <span class="text-sm text-gray-700">{{ type_name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Custom Message -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Message (Optional)</label>
                    <textarea id="doc-custom-message" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Add a personal message..."></textarea>
                </div>
                
                <!-- Submit Button -->
                <div class="flex space-x-3">
                    <button type="button" onclick="closeDocumentRequestModal()"
                            class="flex-1 py-2 px-4 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button type="button" id="submit-document-request-btn" onclick="submitDocumentRequest()"
                            class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        Send Request
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Document Request Modal Functions
let preselectedSendVia = null;
let preselectedRecipient = null;

function openDocumentRequestModal() {
    document.getElementById('document-request-modal').classList.remove('hidden');
    preselectedSendVia = null;
    preselectedRecipient = null;
}

function openDocumentRequestModalForContact(recipient, sendVia, contactValue) {
    // Open modal with pre-selected options
    document.getElementById('document-request-modal').classList.remove('hidden');
    
    // Pre-select recipient
    const recipientRadio = document.querySelector(`input[name="doc_recipient"][value="${recipient}"]`);
    if (recipientRadio) {
        recipientRadio.checked = true;
    }
    
    // Pre-select send via
    const sendViaRadio = document.querySelector(`input[name="doc_send_via"][value="${sendVia}"]`);
    if (sendViaRadio) {
        sendViaRadio.checked = true;
    }
}

function closeDocumentRequestModal() {
    document.getElementById('document-request-modal').classList.add('hidden');
}

function submitDocumentRequest() {
    const recipient = document.querySelector('input[name="doc_recipient"]:checked')?.value || 'learner';
    const sendVia = document.querySelector('input[name="doc_send_via"]:checked')?.value || 'whatsapp';
    const docTypes = Array.from(document.querySelectorAll('.doc-type-checkbox:checked')).map(cb => cb.value);
    const customMessage = document.getElementById('doc-custom-message').value;
    
    if (docTypes.length === 0) {
        alert('Please select at least one document type');
        return;
    }
    
    const submitBtn = document.getElementById('submit-document-request-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending...
    `;
    
    fetch('/crm/leads/{{ lead.pk }}/send-document-link/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            send_via: sendVia,
            recipient: recipient,
            document_types: docTypes,
            message: customMessage
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('document-request-modal-content').innerHTML = `
                <div class="text-center py-8">
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-900">Request Sent Successfully!</h3>
                    <p class="mt-2 text-sm text-gray-600">Document upload link has been sent.</p>
                    ${data.portal_url ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Portal Link:</p>
                        <input type="text" value="${data.portal_url}" class="w-full text-xs bg-white border border-gray-200 rounded px-2 py-1 text-gray-600" readonly>
                    </div>
                    ` : ''}
                    <div class="mt-6">
                        <button type="button" onclick="closeDocumentRequestModal(); location.reload();" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            Done
                        </button>
                    </div>
                </div>
            `;
        } else {
            alert(data.error || 'Failed to send request. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                Send Request
            `;
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            Send Request
        `;
    });
}

function copyPortalLink(requestId, url) {
    navigator.clipboard.writeText(url).then(() => {
        // Show brief success feedback
        const btn = document.querySelector(`button[onclick*="copyPortalLink('${requestId}'"]`);
        if (btn) {
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<svg class="w-3.5 h-3.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
            setTimeout(() => {
                btn.innerHTML = originalHtml;
            }, 1500);
        }
    }).catch(err => {
        // Fallback - select the input
        const input = document.getElementById(`portal-link-${requestId}`);
        if (input) {
            input.select();
            document.execCommand('copy');
        }
    });
}

function resendDocumentLink(requestId, sendVia) {
    if (!confirm(`Resend document upload link via ${sendVia === 'whatsapp' ? 'WhatsApp' : 'Email'}?`)) {
        return;
    }
    
    fetch('/crm/leads/{{ lead.pk }}/send-document-link/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            send_via: sendVia,
            resend_request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Link resent successfully!');
        } else {
            alert(data.error || 'Failed to resend. Please try again.');
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
    });
}

// Update existing keydown listener to also close document modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeQuoteModal();
        closeDocumentRequestModal();
    }
});

// Learner Profile Section Functions
function toggleProfileSection(section) {
    const content = document.getElementById('content-' + section);
    const chevron = document.getElementById('chevron-' + section);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

function toggleDisabilityDescription(checkbox) {
    const container = document.getElementById('disability-description-container');
    if (checkbox.checked) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function toggleMedicalConditions(checkbox) {
    const container = document.getElementById('medical-conditions-container');
    if (checkbox.checked) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function togglePostalAddressFields(checkbox) {
    const fields = document.getElementById('postal-address-fields');
    if (checkbox.checked) {
        fields.classList.add('hidden');
    } else {
        fields.classList.remove('hidden');
    }
}

function validateIdNumber(input) {
    const idNumber = input.value;
    const resultDiv = document.getElementById('id-validation-result');
    
    if (idNumber.length < 13) {
        resultDiv.innerHTML = '';
        return;
    }
    
    // Client-side validation
    if (idNumber.length !== 13 || !/^\d+$/.test(idNumber)) {
        resultDiv.innerHTML = '<span class="text-red-600">ID number must be exactly 13 digits</span>';
        return;
    }
    
    // Call server-side validation
    fetch('/crm/api/validate-id-number/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ id_number: idNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valid) {
            resultDiv.innerHTML = `<span class="text-green-600">âœ“ Valid - DOB: ${data.date_of_birth}, Gender: ${data.gender}</span>`;
            // Auto-fill date of birth and gender if empty
            const dobField = document.querySelector('input[name="date_of_birth"]');
            const genderField = document.querySelector('select[name="gender"]');
            if (dobField && !dobField.value) {
                dobField.value = data.date_of_birth;
            }
            if (genderField && !genderField.value) {
                genderField.value = data.gender;
            }
        } else {
            resultDiv.innerHTML = `<span class="text-red-600">âœ— ${data.error}</span>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<span class="text-red-600">Error validating ID</span>';
    });
}

function saveProfileSection(event, section) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
    `;
    
    // Convert FormData to object
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    data.section = section;
    
    // Handle checkboxes (they don't send value when unchecked)
    if (section === 'health') {
        data.has_disability = document.getElementById('has_disability').checked;
        data.has_medical_conditions = document.getElementById('has_medical_conditions').checked;
    }
    if (section === 'postal_address') {
        data.postal_same_as_physical = document.getElementById('postal_same_as_physical').checked;
    }
    
    fetch('/crm/leads/{{ lead.pk }}/save-profile/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        submitButton.disabled = false;
        
        if (data.success) {
            // Show success state briefly
            submitButton.classList.remove('bg-primary-600', 'hover:bg-primary-700');
            submitButton.classList.add('bg-green-600');
            submitButton.innerHTML = `
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Saved!
            `;
            
            // Update profile completion indicator
            if (data.profile_completion) {
                updateProfileCompletion(data.profile_completion);
            }
            
            setTimeout(() => {
                submitButton.classList.remove('bg-green-600');
                submitButton.classList.add('bg-primary-600', 'hover:bg-primary-700');
                submitButton.textContent = originalText;
            }, 2000);
        } else {
            // Show error
            submitButton.classList.remove('bg-primary-600', 'hover:bg-primary-700');
            submitButton.classList.add('bg-red-600');
            submitButton.textContent = 'Error saving';
            
            setTimeout(() => {
                submitButton.classList.remove('bg-red-600');
                submitButton.classList.add('bg-primary-600', 'hover:bg-primary-700');
                submitButton.textContent = originalText;
            }, 2000);
            
            if (data.errors) {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        }
    })
    .catch(error => {
        submitButton.disabled = false;
        submitButton.classList.remove('bg-primary-600', 'hover:bg-primary-700');
        submitButton.classList.add('bg-red-600');
        submitButton.textContent = 'Error saving';
        
        setTimeout(() => {
            submitButton.classList.remove('bg-red-600');
            submitButton.classList.add('bg-primary-600', 'hover:bg-primary-700');
            submitButton.textContent = originalText;
        }, 2000);
    });
}

function updateProfileCompletion(completion) {
    // Update the percentage text
    const percentageText = document.querySelector('.text-sm.font-medium[class*="text-green"], .text-sm.font-medium[class*="text-yellow"], .text-sm.font-medium[class*="text-red"]');
    if (percentageText) {
        percentageText.textContent = completion.percentage + '% Complete';
        // Update color based on percentage
        percentageText.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
        if (completion.percentage >= 80) {
            percentageText.classList.add('text-green-600');
        } else if (completion.percentage >= 50) {
            percentageText.classList.add('text-yellow-600');
        } else {
            percentageText.classList.add('text-red-600');
        }
    }
    
    // Update the progress bar
    const progressBar = document.querySelector('.h-full.rounded-full[class*="bg-green"], .h-full.rounded-full[class*="bg-yellow"], .h-full.rounded-full[class*="bg-red"]');
    if (progressBar) {
        progressBar.style.width = completion.percentage + '%';
        progressBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
        if (completion.percentage >= 80) {
            progressBar.classList.add('bg-green-500');
        } else if (completion.percentage >= 50) {
            progressBar.classList.add('bg-yellow-500');
        } else {
            progressBar.classList.add('bg-red-500');
        }
    }
}

// Document Upload Functions
document.getElementById('document-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('document-file');
    const docType = document.getElementById('upload-doc-type').value;
    const uploadBtn = document.getElementById('upload-doc-btn');
    
    if (!fileInput.files || !fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('document_type', docType);
    
    // Show loading state
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Uploading...
    `;
    
    fetch('/crm/leads/{{ lead.pk }}/upload-document/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = `
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Upload Document
        `;
        
        if (data.success) {
            // Reset form
            fileInput.value = '';
            // Reload to show new document
            location.reload();
        } else {
            alert('Error uploading: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = `
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            Upload Document
        `;
        alert('Error uploading document');
    });
});

function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) {
        return;
    }
    
    fetch('/crm/leads/{{ lead.pk }}/delete-document/' + docId + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from DOM
            const docElement = document.getElementById('doc-' + docId);
            if (docElement) {
                docElement.remove();
            }
            // Check if list is empty
            const docList = document.getElementById('document-list');
            if (docList && docList.children.length === 0) {
                docList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No documents uploaded yet</p>';
            }
        } else {
            alert('Error deleting: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting document');
    });
}

// Pipeline Membership Functions
function openAddPipelineModal() {
    document.getElementById('add-pipeline-modal').classList.remove('hidden');
}

function closeAddPipelineModal() {
    document.getElementById('add-pipeline-modal').classList.add('hidden');
}

function addToPipeline(pipelineId) {
    fetch('/crm/leads/{{ lead.pk }}/add-to-pipeline/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ pipeline_id: pipelineId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddPipelineModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error adding to pipeline');
    });
}

function pausePipelineMembership(membershipId) {
    fetch('/crm/leads/{{ lead.pk }}/pipeline-membership/' + membershipId + '/pause/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function resumePipelineMembership(membershipId) {
    fetch('/crm/leads/{{ lead.pk }}/pipeline-membership/' + membershipId + '/resume/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

function removePipelineMembership(membershipId, pipelineName) {
    if (!confirm('Remove lead from pipeline "' + pipelineName + '"?')) {
        return;
    }
    
    fetch('/crm/leads/{{ lead.pk }}/pipeline-membership/' + membershipId + '/remove/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('membership-' + membershipId).remove();
            // Check if list empty
            const list = document.getElementById('pipeline-memberships-list');
            if (list && list.children.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4" id="no-pipelines-msg">Not enrolled in any pipelines</p>';
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}

// Application Functions
function openCreateApplicationModal() {
    document.getElementById('create-application-modal').classList.remove('hidden');
}

function closeCreateApplicationModal() {
    document.getElementById('create-application-modal').classList.add('hidden');
}

function createApplication() {
    const qualificationSelect = document.getElementById('application-qualification');
    const intakeSelect = document.getElementById('application-intake');
    const bypassCheckbox = document.getElementById('bypass-eligibility');
    
    if (!qualificationSelect.value) {
        alert('Please select a qualification');
        return;
    }
    
    const data = {
        qualification_id: qualificationSelect.value,
        intake_id: intakeSelect.value || null,
        bypass_eligibility: bypassCheckbox ? bypassCheckbox.checked : false
    };
    
    fetch('/crm/leads/{{ lead.pk }}/create-application/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeCreateApplicationModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error creating application');
    });
}
</script>

<!-- Add Pipeline Modal -->
<div id="add-pipeline-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-11/12 max-w-md shadow-lg rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Add to Pipeline</h3>
            <button onclick="closeAddPipelineModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <p class="text-sm text-gray-500 mb-4">Select a pipeline to add this lead to for automated communications.</p>
        
        <div class="space-y-2 max-h-64 overflow-y-auto">
            {% for pipeline in available_pipelines %}
            <button onclick="addToPipeline({{ pipeline.id }})"
                    class="w-full p-3 text-left bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-between transition-colors">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full mr-3" style="background-color: {{ pipeline.color }}"></span>
                    <div>
                        <span class="font-medium text-gray-900">{{ pipeline.name }}</span>
                        <span class="block text-xs text-gray-500">{{ pipeline.get_learner_type_display }}</span>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
            {% empty %}
            <p class="text-sm text-gray-500 text-center py-4">No available pipelines</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Create Application Modal -->
<div id="create-application-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-11/12 max-w-md shadow-lg rounded-xl bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Create Application</h3>
            <button onclick="closeCreateApplicationModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Qualification *</label>
                <select id="application-qualification" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <option value="">Select a qualification...</option>
                    {% for qual in qualifications %}
                    <option value="{{ qual.id }}">{{ qual.title }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Intake (Optional)</label>
                <select id="application-intake" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <option value="">Select an intake...</option>
                    {% for intake in intakes %}
                    <option value="{{ intake.id }}">{{ intake.name }} - {{ intake.start_date|date:"d M Y" }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {% if lead.is_minor %}
            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center text-sm text-yellow-800">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    This lead is a minor. Pre-approval may be required.
                </div>
            </div>
            {% endif %}
            
            <div class="flex items-center">
                <input type="checkbox" id="bypass-eligibility" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <label for="bypass-eligibility" class="ml-2 text-sm text-gray-600">
                    Bypass eligibility checks (staff override)
                </label>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeCreateApplicationModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" onclick="createApplication()"
                        class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700">
                    Create Application
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Edit Modal -->
<div id="quick-edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-0 border w-11/12 max-w-2xl shadow-xl rounded-xl bg-white">
        <!-- Modal Header -->
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-xl">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Quick Edit Lead</h3>
                <p class="text-sm text-gray-500">Edit {{ lead.get_full_name }}</p>
            </div>
            <button onclick="closeQuickEditModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 bg-white">
            <nav class="flex -mb-px px-6" aria-label="Tabs">
                <button type="button" onclick="switchQuickEditTab('contact')" id="tab-contact"
                        class="quick-edit-tab active py-3 px-4 text-sm font-medium border-b-2 border-primary-500 text-primary-600">
                    Contact Info
                </button>
                <button type="button" onclick="switchQuickEditTab('status')" id="tab-status"
                        class="quick-edit-tab py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Status & Type
                </button>
                <button type="button" onclick="switchQuickEditTab('school')" id="tab-school"
                        class="quick-edit-tab py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    School Info
                </button>
                <button type="button" onclick="switchQuickEditTab('parent')" id="tab-parent"
                        class="quick-edit-tab py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Parent/Guardian
                </button>
                <button type="button" onclick="switchQuickEditTab('followup')" id="tab-followup"
                        class="quick-edit-tab py-3 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Follow-up
                </button>
            </nav>
        </div>
        
        <!-- Tab Content -->
        <div class="p-6 max-h-96 overflow-y-auto">
            <!-- Contact Info Tab -->
            <div id="panel-contact" class="quick-edit-panel">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                        <input type="text" id="qe-first_name" value="{{ lead.first_name }}" 
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                        <input type="text" id="qe-last_name" value="{{ lead.last_name }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="qe-email" value="{{ lead.email }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input type="tel" id="qe-phone" value="{{ lead.phone }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Secondary Phone</label>
                        <input type="tel" id="qe-phone_secondary" value="{{ lead.phone_secondary }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number</label>
                        <input type="tel" id="qe-whatsapp_number" value="{{ lead.whatsapp_number }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div class="col-span-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="qe-prefers_whatsapp" {% if lead.prefers_whatsapp %}checked{% endif %}
                                   class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            <span class="ml-2 text-sm text-gray-600">Prefers WhatsApp for communication</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Status & Type Tab -->
            <div id="panel-status" class="quick-edit-panel hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="qe-status" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            {% for value, label in statuses %}
                            <option value="{{ value }}" {% if lead.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="qe-priority" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            {% for value, label in priorities %}
                            <option value="{{ value }}" {% if lead.priority == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lead Type</label>
                        <select id="qe-lead_type" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            {% for value, label in lead_types %}
                            <option value="{{ value }}" {% if lead.lead_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lead Source</label>
                        <select id="qe-source_id" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="">-- Select Source --</option>
                            {% for source in sources %}
                            <option value="{{ source.id }}" {% if lead.source_id == source.id %}selected{% endif %}>{{ source.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Qualification Interest</label>
                        <select id="qe-qualification_interest_id" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="">-- Select Qualification --</option>
                            {% for qual in qualifications %}
                            <option value="{{ qual.id }}" {% if lead.qualification_interest_id == qual.id %}selected{% endif %}>{{ qual.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                        <input type="date" id="qe-date_of_birth" value="{{ lead.date_of_birth|date:'Y-m-d' }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="qe-notes" rows="3"
                                  class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">{{ lead.notes }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- School Info Tab -->
            <div id="panel-school" class="quick-edit-panel hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">School Name</label>
                        <input type="text" id="qe-school_name" value="{{ lead.school_name }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                        <input type="text" id="qe-grade" value="{{ lead.grade }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                               placeholder="e.g., 11, 12">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expected Matric Year</label>
                        <input type="number" id="qe-expected_matric_year" value="{{ lead.expected_matric_year }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                               min="2024" max="2035" placeholder="e.g., 2026">
                    </div>
                </div>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                    <strong>ðŸ’¡ Tip:</strong> School leaver details help track progression from school to enrollment.
                </div>
            </div>
            
            <!-- Parent/Guardian Tab -->
            <div id="panel-parent" class="quick-edit-panel hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parent/Guardian Name</label>
                        <input type="text" id="qe-parent_name" value="{{ lead.parent_name }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parent Phone</label>
                        <input type="tel" id="qe-parent_phone" value="{{ lead.parent_phone }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parent Email</label>
                        <input type="email" id="qe-parent_email" value="{{ lead.parent_email }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
                        <input type="text" id="qe-parent_relationship" value="{{ lead.parent_relationship }}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                               placeholder="e.g., Mother, Father, Guardian">
                    </div>
                </div>
                {% if lead.is_minor %}
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-sm text-yellow-700">
                    <strong>âš ï¸ Minor:</strong> This lead is under 18. Parent/guardian details are required for enrollment.
                </div>
                {% endif %}
            </div>
            
            <!-- Follow-up Tab -->
            <div id="panel-followup" class="quick-edit-panel hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Next Follow-up Date & Time</label>
                        <input type="datetime-local" id="qe-next_follow_up" 
                               value="{% if lead.next_follow_up %}{{ lead.next_follow_up|date:'Y-m-d' }}T{{ lead.next_follow_up|time:'H:i' }}{% endif %}"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Follow-up Notes</label>
                        <textarea id="qe-follow_up_notes" rows="4"
                                  class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                                  placeholder="What should be discussed or actioned in the follow-up?">{{ lead.follow_up_notes }}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex justify-between items-center px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
            <a href="{% url 'crm:lead_update' lead.pk %}" class="text-sm text-gray-500 hover:text-primary-600 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                Open Full Edit Page
            </a>
            <div class="flex space-x-3">
                <button type="button" onclick="closeQuickEditModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" onclick="saveQuickEdit()" id="save-quick-edit-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 flex items-center">
                    <svg class="w-4 h-4 mr-2 hidden" id="save-spinner" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Quick Edit Modal Functions
function openQuickEditModal() {
    document.getElementById('quick-edit-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeQuickEditModal() {
    document.getElementById('quick-edit-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

function switchQuickEditTab(tabName) {
    // Hide all panels and deactivate all tabs
    document.querySelectorAll('.quick-edit-panel').forEach(panel => panel.classList.add('hidden'));
    document.querySelectorAll('.quick-edit-tab').forEach(tab => {
        tab.classList.remove('border-primary-500', 'text-primary-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected panel and activate tab
    document.getElementById('panel-' + tabName).classList.remove('hidden');
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-primary-500', 'text-primary-600');
}

function saveQuickEdit() {
    const btn = document.getElementById('save-quick-edit-btn');
    const spinner = document.getElementById('save-spinner');
    
    btn.disabled = true;
    spinner.classList.remove('hidden');
    
    // Collect all form data
    const data = {
        // Contact
        first_name: document.getElementById('qe-first_name').value,
        last_name: document.getElementById('qe-last_name').value,
        email: document.getElementById('qe-email').value,
        phone: document.getElementById('qe-phone').value,
        phone_secondary: document.getElementById('qe-phone_secondary').value,
        whatsapp_number: document.getElementById('qe-whatsapp_number').value,
        prefers_whatsapp: document.getElementById('qe-prefers_whatsapp').checked,
        // Status
        status: document.getElementById('qe-status').value,
        priority: document.getElementById('qe-priority').value,
        lead_type: document.getElementById('qe-lead_type').value,
        source_id: document.getElementById('qe-source_id').value,
        qualification_interest_id: document.getElementById('qe-qualification_interest_id').value,
        date_of_birth: document.getElementById('qe-date_of_birth').value,
        notes: document.getElementById('qe-notes').value,
        // School
        school_name: document.getElementById('qe-school_name').value,
        grade: document.getElementById('qe-grade').value,
        expected_matric_year: document.getElementById('qe-expected_matric_year').value,
        // Parent
        parent_name: document.getElementById('qe-parent_name').value,
        parent_phone: document.getElementById('qe-parent_phone').value,
        parent_email: document.getElementById('qe-parent_email').value,
        parent_relationship: document.getElementById('qe-parent_relationship').value,
        // Follow-up
        next_follow_up: document.getElementById('qe-next_follow_up').value,
        follow_up_notes: document.getElementById('qe-follow_up_notes').value
    };
    
    fetch('/crm/leads/{{ lead.pk }}/quick-edit/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        spinner.classList.add('hidden');
        
        if (data.success) {
            // Show success message
            closeQuickEditModal();
            
            // Show a toast notification
            showToast('Lead updated successfully!', 'success');
            
            // Refresh the page to show updated data
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        btn.disabled = false;
        spinner.classList.add('hidden');
        showToast('Error saving changes', 'error');
    });
}

// Simple toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-gray-800 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeQuickEditModal();
    }
});

// Close modal when clicking outside
document.getElementById('quick-edit-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeQuickEditModal();
    }
});
</script>
{% endblock %}
