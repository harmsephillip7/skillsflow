{% extends 'base/app_layout.html' %}
{% load humanize %}

{% block title %}{{ onboarding.get_service_type_display }} Setup - {{ client.company_name }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li><a href="{% url 'corporate:dashboard' %}" class="text-gray-500 hover:text-gray-700">Corporate</a></li>
        <li class="flex items-center">
            <svg class="w-4 h-4 mx-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <a href="{% url 'corporate:client_360' client.pk %}" class="text-gray-500 hover:text-gray-700">{{ client.company_name }}</a>
        </li>
        <li class="flex items-center">
            <svg class="w-4 h-4 mx-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <span class="text-gray-700 font-medium">{{ onboarding.get_service_type_display }} Setup</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block main_content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center">
                    <span class="px-3 py-1 rounded-full text-sm font-medium 
                        {% if service_type == 'WSP_ATR' %}bg-blue-100 text-blue-700
                        {% elif service_type == 'EE' %}bg-purple-100 text-purple-700
                        {% elif service_type == 'BBBEE' %}bg-orange-100 text-orange-700
                        {% else %}bg-gray-100 text-gray-700{% endif %} mr-3">
                        {{ onboarding.get_service_type_display }}
                    </span>
                    <h1 class="text-2xl font-bold text-gray-900">Service Setup</h1>
                </div>
                <p class="text-gray-600 mt-1">{{ client.company_name }} - {{ subscription.service.name }}</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Progress</div>
                <div class="text-2xl font-bold text-primary-600">{{ onboarding.progress_percentage }}%</div>
            </div>
        </div>
    </div>
    
    <!-- Progress Steps -->
    <div class="mb-8 overflow-x-auto">
        <div class="flex items-center min-w-max pb-2">
            {% for step in steps %}
            <div class="flex items-center {% if not forloop.last %}flex-1{% endif %}">
                <div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium
                        {% if step.completed %}bg-green-500 text-white
                        {% elif step.current %}bg-primary-600 text-white ring-2 ring-primary-100
                        {% else %}bg-gray-200 text-gray-500{% endif %}">
                        {% if step.completed %}
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        {% else %}
                            {{ step.number }}
                        {% endif %}
                    </div>
                    <span class="mt-1 text-xs text-center {% if step.current %}text-primary-600 font-medium{% else %}text-gray-500{% endif %}" style="max-width: 70px;">
                        {{ step.name }}
                    </span>
                </div>
                {% if not forloop.last %}
                <div class="flex-1 mx-2 h-0.5 {% if step.completed %}bg-green-500{% else %}bg-gray-200{% endif %}" style="min-width: 30px;"></div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Step Content -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <form method="post" action="{% url 'corporate:service_onboarding_step' client.pk subscription.pk current_step %}">
            {% csrf_token %}
            
            {% with current_step_info=onboarding.step_data|default_if_none:"{}"|dictsort %}
            {% for step_key, step_info in onboarding.step_data.items %}
            {% if step_key == current_step|stringformat:"s" %}
            
            <div class="p-6 border-b border-gray-200 bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-900">Step {{ current_step }}: {{ step_info.name }}</h2>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Dynamic content based on step code -->
                {% if step_info.code == 'SETA_CONFIRMATION' %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SETA</label>
                            <select name="seta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                                <option value="">Select SETA...</option>
                                {% for seta in setas %}
                                <option value="{{ seta.id }}" {% if current_seta.id == seta.id %}selected{% endif %}>{{ seta.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">SDL Number</label>
                            <input type="text" name="seta_number" value="{{ client.seta_number }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                
                {% elif step_info.code == 'FINANCIAL_YEAR' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Financial Year</label>
                        <p class="text-sm text-gray-500 mb-3">Select the financial year for WSP/ATR reporting (May - April)</p>
                        <select name="financial_year" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="{{ current_fy }}">{{ current_fy }}/{{ current_fy|add:1 }} (Current)</option>
                            <option value="{{ next_fy }}">{{ next_fy }}/{{ next_fy|add:1 }} (Next)</option>
                        </select>
                    </div>
                
                {% elif step_info.code == 'COMMITTEE' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Meeting Frequency</label>
                        <select name="meeting_frequency" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="QUARTERLY">Quarterly</option>
                            <option value="BI_MONTHLY">Bi-Monthly</option>
                            <option value="MONTHLY">Monthly</option>
                        </select>
                    </div>
                    {% if committee %}
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-green-700">✓ Training Committee already exists: {{ committee.name }}</p>
                    </div>
                    {% endif %}
                
                {% elif step_info.code == 'SDF_APPOINTMENT' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select SDF Contact</label>
                        <select name="sdf_contact" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="">Select contact...</option>
                            {% for contact in contacts %}
                            <option value="{{ contact.id }}" {% if sdf_contact.id == contact.id %}selected{% endif %}>
                                {{ contact.name }} ({{ contact.get_role_display }})
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-sm text-gray-500 mt-2">The SDF must be registered with the SETA.</p>
                    </div>
                
                {% elif step_info.code == 'WORKFORCE' %}
                    <p class="text-gray-600 mb-4">Workforce profile data will be collected in the WSP/ATR management section.</p>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-700">Click "Complete" to proceed. You can add detailed workforce data later.</p>
                    </div>
                
                {% elif step_info.code == 'TRAINING_HISTORY' %}
                    <p class="text-gray-600">Previous training data will be imported from the ATR section.</p>
                
                {% elif step_info.code == 'DOCUMENTS' %}
                    <p class="text-gray-600 mb-4">The following documents will be required:</p>
                    <ul class="space-y-2">
                        {% for doc in document_types %}
                        <li class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <svg class="w-5 h-5 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>{{ doc.1 }}</span>
                            {% if doc.2 %}<span class="ml-2 text-xs text-red-500">Required</span>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                
                {% elif step_info.code == 'MEETINGS' %}
                    <p class="text-gray-600 mb-4">Quarterly committee meetings will be scheduled:</p>
                    <ul class="space-y-2 text-sm">
                        <li class="p-3 bg-gray-50 rounded-lg">Q1 Meeting - July</li>
                        <li class="p-3 bg-gray-50 rounded-lg">Q2 Meeting - October</li>
                        <li class="p-3 bg-gray-50 rounded-lg">Q3 Meeting - January</li>
                        <li class="p-3 bg-gray-50 rounded-lg">Q4 Meeting - April</li>
                    </ul>
                
                {% elif step_info.code == 'REPORTING_PERIOD' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reporting Year</label>
                        <p class="text-sm text-gray-500 mb-3">EE Reporting period runs October - September</p>
                        <select name="reporting_year" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                            <option value="{{ current_year }}">{{ current_year }}</option>
                            <option value="{{ current_year|add:1 }}">{{ current_year|add:1 }}</option>
                        </select>
                    </div>
                
                {% elif step_info.code == 'CLASSIFICATION' %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Entity Type</label>
                            <select name="entity_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                                {% for code, name in entity_types %}
                                <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Annual Turnover (R)</label>
                            <input type="number" name="turnover" step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                
                {% elif step_info.code == 'OWNERSHIP' %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Black Ownership %</label>
                            <input type="number" name="black_ownership" min="0" max="100" step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Black Women Ownership %</label>
                            <input type="number" name="black_women_ownership" min="0" max="100" step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                
                {% else %}
                    <p class="text-gray-600">Complete this step to proceed.</p>
                {% endif %}
            </div>
            
            {% endif %}
            {% endfor %}
            {% endwith %}
            
            <!-- Actions -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                <div>
                    {% if current_step > 1 %}
                    <button type="submit" name="action" value="back" class="px-4 py-2 text-gray-700 hover:text-gray-900">
                        ← Previous
                    </button>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{% url 'corporate:client_360' client.pk %}" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Save & Exit
                    </a>
                    <button type="submit" name="action" value="complete" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium">
                        {% if current_step == onboarding.total_steps %}
                            Complete Setup
                        {% else %}
                            Continue →
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
