{% extends 'base/app_layout.html' %}
{% load static %}

{% block title %}WSP/ATR Project Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">WSP/ATR Project Management</h1>
            <p class="text-gray-500">Manage Workplace Skills Plans and Annual Training Reports</p>
        </div>
        <div class="flex items-center gap-3">
            <select id="yearFilter" onchange="filterByYear(this.value)" class="rounded-lg border-gray-300 text-sm">
                {% for year in wsp_years %}
                <option value="{{ year.id }}" {% if year == selected_year %}selected{% endif %}>
                    {{ year.year }}/{{ year.year|add:1 }}
                </option>
                {% endfor %}
            </select>
            <select id="clientFilter" onchange="filterByClient(this.value)" class="rounded-lg border-gray-300 text-sm">
                <option value="">All Clients</option>
                {% for client in clients %}
                <option value="{{ client.id }}" {% if selected_client_id == client.id|stringformat:"i" %}selected{% endif %}>
                    {{ client.company_name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- WSP Stats -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">WSP Submissions</p>
                    <p class="text-2xl font-bold text-gray-900">{{ wsp_stats.total }}</p>
                </div>
                <div class="h-12 w-12 rounded-lg bg-blue-100 flex items-center justify-center">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center gap-4 text-xs">
                <span class="text-green-600">{{ wsp_stats.accepted }} Accepted</span>
                <span class="text-yellow-600">{{ wsp_stats.in_progress }} In Progress</span>
            </div>
        </div>

        <!-- ATR Stats -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">ATR Submissions</p>
                    <p class="text-2xl font-bold text-gray-900">{{ atr_stats.total }}</p>
                </div>
                <div class="h-12 w-12 rounded-lg bg-green-100 flex items-center justify-center">
                    <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
            </div>
            <div class="mt-3 flex items-center gap-4 text-xs">
                <span class="text-green-600">{{ atr_stats.accepted }} Accepted</span>
                <span class="text-yellow-600">{{ atr_stats.in_progress }} In Progress</span>
            </div>
        </div>

        <!-- Upcoming Deadlines -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Upcoming Activities</p>
                    <p class="text-2xl font-bold text-gray-900">{{ upcoming_activities|length }}</p>
                </div>
                <div class="h-12 w-12 rounded-lg bg-yellow-100 flex items-center justify-center">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
            <p class="mt-3 text-xs text-gray-500">Next 30 days</p>
        </div>

        <!-- Overdue -->
        <div class="bg-white rounded-xl shadow-sm border p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Overdue Activities</p>
                    <p class="text-2xl font-bold text-red-600">{{ overdue_activities|length }}</p>
                </div>
                <div class="h-12 w-12 rounded-lg bg-red-100 flex items-center justify-center">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
            <p class="mt-3 text-xs text-red-500">Requires attention</p>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Service Delivery Progress -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">Service Delivery Progress</h2>
                <span class="text-sm text-gray-500">{{ selected_year }}</span>
            </div>
            <div class="p-5">
                <div class="space-y-4">
                    {% for delivery in service_deliveries %}
                    <a href="{% url 'corporate:service_delivery_detail' delivery.pk %}" class="block p-4 border rounded-lg hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-900">{{ delivery.client.company_name }}</span>
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if delivery.status == 'ON_TRACK' %}bg-green-100 text-green-700
                                {% elif delivery.status == 'AT_RISK' %}bg-yellow-100 text-yellow-700
                                {% elif delivery.status == 'DELAYED' %}bg-red-100 text-red-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ delivery.get_status_display }}
                            </span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-600 rounded-full" style="width: {{ delivery.overall_progress }}%"></div>
                                </div>
                            </div>
                            <span class="text-sm font-medium text-gray-600">{{ delivery.overall_progress }}%</span>
                        </div>
                        <div class="mt-2 flex items-center gap-4 text-xs text-gray-500">
                            {% if delivery.wsp %}
                            <span>WSP: {{ delivery.wsp.get_status_display }}</span>
                            {% endif %}
                            {% if delivery.atr %}
                            <span>ATR: {{ delivery.atr.get_status_display }}</span>
                            {% endif %}
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <p>No service deliveries found for the selected period.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Checklist Progress -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b">
                <h2 class="font-semibold text-gray-900">Checklist Progress</h2>
            </div>
            <div class="p-5 space-y-4">
                {% for item in checklist_progress %}
                <div class="p-3 border rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-900 truncate">{{ item.client.company_name }}</span>
                        <span class="text-xs text-gray-500">{{ item.completed }}/{{ item.total }}</span>
                    </div>
                    <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 rounded-full" style="width: {{ item.progress }}%"></div>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-gray-500 py-4">No checklist data available.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Submissions Tables -->
    <div class="grid lg:grid-cols-2 gap-6">
        <!-- WSP Submissions -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">WSP Submissions</h2>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-700">View All</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-5 py-3 text-right text-xs font-medium text-gray-500 uppercase">Learners</th>
                            <th class="px-5 py-3"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for wsp in wsp_submissions %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4">
                                <span class="text-sm font-medium text-gray-900">{{ wsp.client.company_name }}</span>
                            </td>
                            <td class="px-5 py-4">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if wsp.status == 'ACCEPTED' %}bg-green-100 text-green-700
                                    {% elif wsp.status == 'SUBMITTED' %}bg-blue-100 text-blue-700
                                    {% elif wsp.status == 'IN_PROGRESS' %}bg-yellow-100 text-yellow-700
                                    {% elif wsp.status == 'REJECTED' %}bg-red-100 text-red-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ wsp.get_status_display }}
                                </span>
                            </td>
                            <td class="px-5 py-4 text-right text-sm text-gray-600">{{ wsp.total_learners_planned }}</td>
                            <td class="px-5 py-4 text-right">
                                <a href="{% url 'corporate:wsp_detail' wsp.pk %}" class="text-blue-600 hover:text-blue-700">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-5 py-8 text-center text-gray-500">No WSP submissions found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ATR Submissions -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">ATR Submissions</h2>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-700">View All</a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                            <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-5 py-3 text-right text-xs font-medium text-gray-500 uppercase">Trained</th>
                            <th class="px-5 py-3"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for atr in atr_submissions %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4">
                                <span class="text-sm font-medium text-gray-900">{{ atr.client.company_name }}</span>
                            </td>
                            <td class="px-5 py-4">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if atr.status == 'ACCEPTED' %}bg-green-100 text-green-700
                                    {% elif atr.status == 'SUBMITTED' %}bg-blue-100 text-blue-700
                                    {% elif atr.status == 'IN_PROGRESS' %}bg-yellow-100 text-yellow-700
                                    {% elif atr.status == 'REJECTED' %}bg-red-100 text-red-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ atr.get_status_display }}
                                </span>
                            </td>
                            <td class="px-5 py-4 text-right text-sm text-gray-600">{{ atr.total_learners_trained }}</td>
                            <td class="px-5 py-4 text-right">
                                <a href="{% url 'corporate:atr_detail' atr.pk %}" class="text-blue-600 hover:text-blue-700">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-5 py-8 text-center text-gray-500">No ATR submissions found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upcoming & Overdue Activities -->
    <div class="grid lg:grid-cols-2 gap-6">
        <!-- Upcoming -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b">
                <h2 class="font-semibold text-gray-900">Upcoming Activities (30 days)</h2>
            </div>
            <div class="divide-y">
                {% for activity in upcoming_activities %}
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="font-medium text-gray-900">{{ activity.name }}</p>
                            <p class="text-sm text-gray-500">{{ activity.service_delivery.client.company_name }}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">
                            Due {{ activity.planned_end|date:"d M" }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-gray-500">No upcoming activities.</div>
                {% endfor %}
            </div>
        </div>

        <!-- Overdue -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="p-5 border-b bg-red-50">
                <h2 class="font-semibold text-red-700">Overdue Activities</h2>
            </div>
            <div class="divide-y">
                {% for activity in overdue_activities %}
                <div class="p-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="font-medium text-gray-900">{{ activity.name }}</p>
                            <p class="text-sm text-gray-500">{{ activity.service_delivery.client.company_name }}</p>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">
                            {{ activity.days_remaining|abs }} days overdue
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-green-600">
                    <svg class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>No overdue activities!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function filterByYear(yearId) {
    const clientId = document.getElementById('clientFilter').value;
    let url = '{% url "corporate:wsp_atr_dashboard" %}?year=' + yearId;
    if (clientId) url += '&client=' + clientId;
    window.location.href = url;
}

function filterByClient(clientId) {
    const yearId = document.getElementById('yearFilter').value;
    let url = '{% url "corporate:wsp_atr_dashboard" %}?year=' + yearId;
    if (clientId) url += '&client=' + clientId;
    window.location.href = url;
}
</script>
{% endblock %}
