# Generated by Django 5.2.8 on 2026-01-06 15:02

import django.db.models.deletion
import integrations.encryption
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('tenants', '0002_extend_campus_code_length'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='IntegrationProvider',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('slug', models.SlugField(help_text="Unique identifier (e.g., 'sage-intacct', 'microsoft-365')", unique=True)),
                ('name', models.CharField(help_text='Display name', max_length=100)),
                ('description', models.TextField(blank=True, help_text='Brief description of the integration')),
                ('category', models.CharField(choices=[('FINANCE', 'Finance & Accounting'), ('LMS', 'Learning Management'), ('CRM', 'CRM & Sales'), ('COMMS', 'Communication'), ('PRODUCTIVITY', 'Productivity & Collaboration'), ('SOCIAL', 'Social Media'), ('AUTOMATION', 'Automation & Workflow'), ('STORAGE', 'File Storage'), ('ANALYTICS', 'Analytics & Reporting'), ('HR', 'HR & Workforce'), ('OTHER', 'Other')], default='OTHER', max_length=20)),
                ('auth_type', models.CharField(choices=[('API_KEY', 'API Key'), ('OAUTH2', 'OAuth 2.0'), ('OAUTH1', 'OAuth 1.0'), ('BASIC', 'Basic Auth (Username/Password)'), ('BEARER', 'Bearer Token'), ('WEBHOOK', 'Webhook Only'), ('CUSTOM', 'Custom Authentication')], default='API_KEY', max_length=20)),
                ('logo', models.ImageField(blank=True, null=True, upload_to='integration_logos/')),
                ('icon_class', models.CharField(blank=True, help_text="CSS icon class (e.g., 'fab fa-microsoft')", max_length=50)),
                ('color', models.CharField(default='#6366f1', help_text='Brand color (hex)', max_length=7)),
                ('docs_url', models.URLField(blank=True, help_text='Link to integration documentation')),
                ('setup_instructions', models.TextField(blank=True, help_text='Step-by-step setup guide (Markdown)')),
                ('oauth_auth_url', models.URLField(blank=True, help_text='OAuth authorization endpoint')),
                ('oauth_token_url', models.URLField(blank=True, help_text='OAuth token endpoint')),
                ('oauth_scopes', models.TextField(blank=True, help_text='Required OAuth scopes (comma-separated)')),
                ('rate_limit_requests', models.PositiveIntegerField(default=1000, help_text='Max requests per window')),
                ('rate_limit_window_seconds', models.PositiveIntegerField(default=3600, help_text='Rate limit window in seconds')),
                ('supports_sync', models.BooleanField(default=True, help_text='Supports data synchronization')),
                ('supports_webhooks', models.BooleanField(default=False, help_text='Supports inbound webhooks')),
                ('supports_realtime', models.BooleanField(default=False, help_text='Supports real-time updates')),
                ('is_active', models.BooleanField(default=True, help_text='Available for new connections')),
                ('is_beta', models.BooleanField(default=False, help_text='Beta/experimental integration')),
                ('connector_class', models.CharField(blank=True, help_text="Python path to connector class (e.g., 'integrations.connectors.microsoft.MicrosoftConnector')", max_length=200)),
            ],
            options={
                'verbose_name': 'Integration Provider',
                'verbose_name_plural': 'Integration Providers',
                'ordering': ['category', 'name'],
            },
        ),
        migrations.CreateModel(
            name='IntegrationConnection',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(blank=True, help_text='Custom name for this connection', max_length=100)),
                ('api_key', integrations.encryption.EncryptedCharField(blank=True, help_text='API Key or Token', max_length=1000)),
                ('api_secret', integrations.encryption.EncryptedCharField(blank=True, help_text='API Secret', max_length=1000)),
                ('access_token', integrations.encryption.EncryptedTextField(blank=True, help_text='OAuth Access Token')),
                ('refresh_token', integrations.encryption.EncryptedTextField(blank=True, help_text='OAuth Refresh Token')),
                ('client_id', integrations.encryption.EncryptedCharField(blank=True, help_text='OAuth Client ID', max_length=1000)),
                ('client_secret', integrations.encryption.EncryptedCharField(blank=True, help_text='OAuth Client Secret', max_length=1000)),
                ('token_expires_at', models.DateTimeField(blank=True, help_text='When access token expires', null=True)),
                ('oauth_state', models.CharField(blank=True, help_text='OAuth state parameter for CSRF', max_length=100)),
                ('config', models.JSONField(blank=True, default=dict, help_text='Provider-specific configuration (e.g., tenant_id, company_id)')),
                ('base_url', models.URLField(blank=True, help_text='Custom API base URL (if applicable)')),
                ('webhook_url', models.URLField(blank=True, help_text='Outbound webhook URL (if applicable)')),
                ('status', models.CharField(choices=[('PENDING', 'Pending Setup'), ('ACTIVE', 'Active'), ('ERROR', 'Error'), ('DISCONNECTED', 'Disconnected'), ('EXPIRED', 'Credentials Expired'), ('RATE_LIMITED', 'Rate Limited')], default='PENDING', max_length=20)),
                ('health_status', models.CharField(choices=[('HEALTHY', 'Healthy'), ('DEGRADED', 'Degraded'), ('UNHEALTHY', 'Unhealthy'), ('UNKNOWN', 'Unknown')], default='UNKNOWN', max_length=20)),
                ('last_health_check', models.DateTimeField(blank=True, null=True)),
                ('status_message', models.TextField(blank=True, help_text='Last status/error message')),
                ('sync_enabled', models.BooleanField(default=True, help_text='Enable automatic sync')),
                ('sync_interval_minutes', models.PositiveIntegerField(default=60, help_text='Sync interval in minutes')),
                ('last_sync_at', models.DateTimeField(blank=True, null=True)),
                ('last_sync_status', models.CharField(blank=True, max_length=20)),
                ('next_sync_at', models.DateTimeField(blank=True, null=True)),
                ('rate_limit_remaining', models.PositiveIntegerField(blank=True, help_text='Remaining API calls', null=True)),
                ('rate_limit_resets_at', models.DateTimeField(blank=True, help_text='When rate limit resets', null=True)),
                ('connected_at', models.DateTimeField(blank=True, help_text='When connection was established', null=True)),
                ('disconnected_at', models.DateTimeField(blank=True, help_text='When connection was disconnected', null=True)),
                ('brand', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='integration_connections', to='tenants.brand')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
                ('provider', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='connections', to='integrations.integrationprovider')),
            ],
            options={
                'verbose_name': 'Integration Connection',
                'verbose_name_plural': 'Integration Connections',
                'ordering': ['-created_at'],
                'permissions': [('can_manage_integrations', 'Can manage integration connections')],
                'unique_together': {('provider', 'brand', 'name')},
            },
        ),
        migrations.CreateModel(
            name='IntegrationWebhook',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(help_text="Webhook name (e.g., 'Payment Notifications')", max_length=100)),
                ('event_types', models.JSONField(blank=True, default=list, help_text='Event types this webhook handles (list of strings)')),
                ('secret_key', integrations.encryption.EncryptedCharField(help_text='HMAC secret for signature verification', max_length=1000)),
                ('allowed_ips', models.JSONField(blank=True, default=list, help_text='Optional IP allowlist (list of IP addresses)')),
                ('is_active', models.BooleanField(default=True)),
                ('is_verified', models.BooleanField(default=False, help_text='Has webhook been verified?')),
                ('last_received_at', models.DateTimeField(blank=True, null=True)),
                ('total_received', models.PositiveIntegerField(default=0)),
                ('total_processed', models.PositiveIntegerField(default=0)),
                ('total_failed', models.PositiveIntegerField(default=0)),
                ('connection', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='webhooks', to='integrations.integrationconnection')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Webhook',
                'verbose_name_plural': 'Webhooks',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='IntegrationEntityMapping',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('entity_type', models.CharField(help_text="Entity type (e.g., 'learner', 'invoice')", max_length=50)),
                ('internal_id', models.CharField(help_text='SkillsFlow entity ID', max_length=100)),
                ('external_id', models.CharField(help_text='External system entity ID', max_length=100)),
                ('external_data', models.JSONField(blank=True, default=dict, help_text='Cached external entity data')),
                ('last_synced_at', models.DateTimeField(auto_now=True)),
                ('sync_status', models.CharField(default='SYNCED', max_length=20)),
                ('checksum', models.CharField(blank=True, help_text='Hash for change detection', max_length=64)),
                ('connection', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='entity_mappings', to='integrations.integrationconnection')),
            ],
            options={
                'verbose_name': 'Entity Mapping',
                'verbose_name_plural': 'Entity Mappings',
                'ordering': ['-last_synced_at'],
                'indexes': [models.Index(fields=['connection', 'entity_type', 'external_id'], name='integration_connect_8943ab_idx'), models.Index(fields=['entity_type', 'internal_id'], name='integration_entity__df0b3d_idx')],
                'unique_together': {('connection', 'entity_type', 'internal_id')},
            },
        ),
        migrations.CreateModel(
            name='IntegrationFieldMapping',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('entity_type', models.CharField(help_text="Entity type (e.g., 'learner', 'invoice')", max_length=50)),
                ('direction', models.CharField(choices=[('INBOUND', 'Inbound (External → SkillsFlow)'), ('OUTBOUND', 'Outbound (SkillsFlow → External)'), ('BIDIRECTIONAL', 'Bidirectional')], default='BIDIRECTIONAL', max_length=20)),
                ('internal_field', models.CharField(help_text="SkillsFlow field path (e.g., 'learner.email')", max_length=100)),
                ('external_field', models.CharField(help_text="External system field (e.g., 'contact_email')", max_length=100)),
                ('transform_type', models.CharField(choices=[('DIRECT', 'Direct Copy'), ('UPPERCASE', 'Convert to Uppercase'), ('LOWERCASE', 'Convert to Lowercase'), ('DATE_FORMAT', 'Format Date'), ('LOOKUP', 'Lookup Value'), ('CONCAT', 'Concatenate Fields'), ('SPLIT', 'Split Field'), ('CUSTOM', 'Custom Transform')], default='DIRECT', max_length=20)),
                ('transform_config', models.JSONField(blank=True, default=dict, help_text='Transform configuration (e.g., date format, lookup table)')),
                ('is_required', models.BooleanField(default=False, help_text='Is this field required for sync?')),
                ('is_active', models.BooleanField(default=True)),
                ('default_value', models.CharField(blank=True, help_text='Default value if source is empty', max_length=500)),
                ('connection', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='field_mappings', to='integrations.integrationconnection')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_created', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deleted', to=settings.AUTH_USER_MODEL)),
                ('updated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='%(class)s_updated', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Field Mapping',
                'verbose_name_plural': 'Field Mappings',
                'ordering': ['entity_type', 'internal_field'],
                'unique_together': {('connection', 'entity_type', 'internal_field', 'direction')},
            },
        ),
        migrations.CreateModel(
            name='IntegrationSyncLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('direction', models.CharField(choices=[('INBOUND', 'Inbound (External → SkillsFlow)'), ('OUTBOUND', 'Outbound (SkillsFlow → External)'), ('BIDIRECTIONAL', 'Bidirectional')], default='OUTBOUND', max_length=20)),
                ('entity_type', models.CharField(help_text="Type of data synced (e.g., 'learner', 'invoice', 'course')", max_length=50)),
                ('operation', models.CharField(blank=True, help_text="Specific operation (e.g., 'create', 'update', 'sync_all')", max_length=50)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('IN_PROGRESS', 'In Progress'), ('SUCCESS', 'Success'), ('PARTIAL', 'Partial Success'), ('FAILED', 'Failed'), ('CANCELLED', 'Cancelled')], default='PENDING', max_length=20)),
                ('records_total', models.PositiveIntegerField(default=0, help_text='Total records to process')),
                ('records_processed', models.PositiveIntegerField(default=0, help_text='Records successfully processed')),
                ('records_failed', models.PositiveIntegerField(default=0, help_text='Records that failed')),
                ('records_skipped', models.PositiveIntegerField(default=0, help_text='Records skipped (already synced)')),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('duration_ms', models.PositiveIntegerField(blank=True, help_text='Duration in milliseconds', null=True)),
                ('request_payload', models.JSONField(blank=True, help_text='Request data sent to API', null=True)),
                ('response_payload', models.JSONField(blank=True, help_text='Response data received', null=True)),
                ('error_message', models.TextField(blank=True, help_text='Error message if failed')),
                ('error_details', models.JSONField(blank=True, help_text='Detailed error info (stack trace, etc.)', null=True)),
                ('is_scheduled', models.BooleanField(default=False, help_text='Was this a scheduled sync?')),
                ('connection', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sync_logs', to='integrations.integrationconnection')),
                ('triggered_by', models.ForeignKey(blank=True, help_text='User who triggered the sync (null for scheduled)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='integration_syncs', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Sync Log',
                'verbose_name_plural': 'Sync Logs',
                'ordering': ['-started_at'],
                'indexes': [models.Index(fields=['connection', '-started_at'], name='integration_connect_28818a_idx'), models.Index(fields=['status', '-started_at'], name='integration_status_998770_idx'), models.Index(fields=['entity_type', '-started_at'], name='integration_entity__4ac084_idx')],
            },
        ),
        migrations.CreateModel(
            name='IntegrationWebhookLog',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('event_type', models.CharField(blank=True, max_length=50)),
                ('headers', models.JSONField(default=dict, help_text='Request headers')),
                ('payload', models.JSONField(default=dict, help_text='Request body')),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('status', models.CharField(choices=[('RECEIVED', 'Received'), ('VERIFIED', 'Signature Verified'), ('PROCESSED', 'Processed'), ('FAILED', 'Failed'), ('REJECTED', 'Rejected (Invalid Signature)')], default='RECEIVED', max_length=20)),
                ('error_message', models.TextField(blank=True)),
                ('received_at', models.DateTimeField(auto_now_add=True)),
                ('processed_at', models.DateTimeField(blank=True, null=True)),
                ('webhook', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='integrations.integrationwebhook')),
            ],
            options={
                'verbose_name': 'Webhook Log',
                'verbose_name_plural': 'Webhook Logs',
                'ordering': ['-received_at'],
                'indexes': [models.Index(fields=['webhook', '-received_at'], name='integration_webhook_b9e7fd_idx'), models.Index(fields=['status', '-received_at'], name='integration_status_0ec87a_idx')],
            },
        ),
    ]
